<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Key Kalkulator Multi Rumus - RAN</title>
<style>
/* CSS */
* { 
    margin:0; 
    padding:0; 
    box-sizing:border-box; 
}
body { 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
    min-height:100vh; 
    padding:20px;
    display: flex;
    align-items: flex-start;
    justify-content: center;
}
.container { 
    max-width:1200px; 
    width:100%;
    margin:0 auto; 
    background:white; 
    border-radius:20px; 
    padding:30px; 
    box-shadow:0 20px 40px rgba(0,0,0,0.15);
}
.header { 
    text-align:center; 
    margin-bottom:25px; 
}
h1 { 
    color:#2d3748; 
    margin-bottom:8px; 
    font-size:2.2rem;
    font-weight:700;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}
.subtitle { 
    text-align:center; 
    color:#718096; 
    font-size:15px; 
    margin-bottom:25px;
    line-height:1.5;
}
.grid-container { 
    display:grid; 
    grid-template-columns:1fr 1fr; 
    gap:25px; 
    margin-bottom:25px;
}
.input-section, .output-section { 
    background:#f8f9fa; 
    padding:25px; 
    border-radius:15px; 
    border:2px solid #e9ecef;
    box-shadow: 0 5px 15px rgba(0,0,0,0.08);
}
.section-title { 
    color:#2d3748; 
    margin-bottom:20px; 
    font-size:18px; 
    font-weight:bold;
    display: flex;
    align-items: center;
    gap: 8px;
}
.data-input { 
    margin-bottom:20px;
}
.data-input textarea { 
    width:100%; 
    height:200px; 
    padding:15px; 
    border:2px solid #e2e8f0; 
    border-radius:12px; 
    font-size:15px; 
    resize:vertical; 
    margin-bottom:10px;
    font-family: 'Courier New', monospace;
    transition: all 0.3s ease;
    background: white;
}
.data-input textarea:focus { 
    border-color:#667eea; 
    outline:none;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}
.formula-display {
    background: #1a202c;
    color: #e2e8f0;
    padding: 15px;
    border-radius: 12px;
    font-family: 'Courier New', monospace;
    margin-bottom: 20px;
    border: 2px solid #2d3748;
    font-size: 14px;
    text-align: left;
    max-height: 150px;
    overflow-y: auto;
}
.button-group { 
    display:flex; 
    gap:12px; 
    margin-bottom:20px;
}
.button-group-double {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 20px;
}
button { 
    padding:15px; 
    border:none; 
    border-radius:12px; 
    font-size:15px; 
    font-weight:600; 
    cursor:pointer; 
    transition:all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}
.btn-calculate { 
    background:linear-gradient(135deg, #4CAF50, #45a049);
    color:white;
    box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
}
.btn-clear { 
    background:linear-gradient(135deg, #ff6b6b, #ee5a52);
    color:white;
    box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
}
.btn-copy { 
    background:linear-gradient(135deg, #2196F3, #1976D2);
    color:white;
    box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
}
.btn-copy-combined {
    background:linear-gradient(135deg, #9C27B0, #7B1FA2);
    color:white;
    box-shadow: 0 4px 15px rgba(156, 39, 176, 0.3);
}
button:hover { 
    transform:translateY(-3px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
}
button:active {
    transform:translateY(-1px);
}
.info { 
    background:#e3f2fd; 
    padding:18px; 
    border-radius:12px; 
    margin-bottom:20px; 
    text-align:center;
    font-weight:500;
    border-left:4px solid #2196F3;
    transition: all 0.3s ease;
}
.info.success {
    background:#e8f5e8;
    border-left-color:#4CAF50;
    color:#2e7d32;
}
.info.error {
    background:#ffebee;
    border-left-color:#f44336;
    color:#c62828;
}
.input-info { 
    text-align:center; 
    color:#718096; 
    font-size:13px; 
    margin-bottom:15px;
    font-weight: 500;
}
.result-box { 
    background:#1a202c; 
    color:#e2e8f0; 
    padding:25px; 
    border-radius:12px; 
    font-family:'Courier New',monospace; 
    min-height:200px; 
    white-space:pre-wrap; 
    line-height:1.6;
    border:1px solid #2d3748;
    font-size:14px;
    overflow-y: auto;
    max-height: 400px;
    position: relative;
}
.result-box::-webkit-scrollbar {
    width:8px;
}
.result-box::-webkit-scrollbar-track {
    background:#2d3748;
    border-radius:4px;
}
.result-box::-webkit-scrollbar-thumb {
    background:#4a5568;
    border-radius:4px;
}
.result-box::-webkit-scrollbar-thumb:hover {
    background:#718096;
}
.copy-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #4CAF50;
    color: white;
    padding: 15px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1000;
    transform: translateX(150%);
    transition: transform 0.3s ease;
}
.copy-notification.show {
    transform: translateX(0);
}
.formula-label {
    color: #a0aec0;
    font-size: 12px;
    margin-bottom: 5px;
    text-align: center;
}
.history-info {
    background: #e8f5e8;
    padding: 10px 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    font-size: 12px;
    color: #2e7d32;
    text-align: center;
    border-left: 4px solid #4CAF50;
}
.formula-item {
    margin-bottom: 5px;
    padding: 3px 0;
}
.formula-index {
    color: #FFD700;
    font-weight: bold;
}
@media (max-width: 768px) {
    .container {
        padding:20px;
    }
    .grid-container {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    .button-group-double {
        grid-template-columns: 1fr;
    }
}
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üîÆ KEY KALKULATOR</h1>
        <div class="subtitle">Hitung rumus otomatis dengan multi kolom AI</div>
    </div>

    <div class="grid-container">
        <div class="input-section">
            <div class="data-input">
                <textarea id="inputData" placeholder="Masukkan data dengan format:
6987 = 02 . 75 . 27 . 37 ai
7070 = 68 . 97 . 16 . 60 ai
1567 = 80 . 42 . 05 . 48 ai
...
======
A7mb+E7ty.(mb)
C3ml-E3ty.(m9)
A6ix+E4
A5ix-K6"></textarea>
                <div class="input-info" id="inputInfo">0 angka + 0 rumus terdeteksi</div>
            </div>
            
            <div class="formula-label">Rumus Terdeteksi:</div>
            <div class="formula-display" id="detectedFormula">Tidak ada rumus</div>
            
            <div class="history-info" id="historyInfo">Butuh 0 hari history. Data terbaru (bawah) membutuhkan data sebelumnya (atas) untuk perhitungan.</div>
            
            <div class="button-group">
                <button class="btn-calculate" onclick="calculateFormula()">üßÆ HITUNG RUMUS</button>
                <button class="btn-clear" onclick="clearAll()">üóëÔ∏è HAPUS SEMUA</button>
            </div>
            
            <div class="info" id="info">
                Masukkan data dengan format angka dan multiple rumus, lalu klik HITUNG RUMUS
                <div style="margin-top: 10px; font-size: 12px; text-align: left; background: #e8f5e8; padding: 10px; border-radius: 8px;">
                    <strong>Format Input Multi Kolom:</strong><br>
                    ‚Ä¢ <code>6987 = 02 . 75 . 27 . 37 ai</code><br>
                    ‚Ä¢ Kolom 1 ‚Üí Rumus 1, Kolom 2 ‚Üí Rumus 2, Kolom 3 ‚Üí Rumus 3, Kolom 4 ‚Üí Rumus 4<br>
                    ‚Ä¢ Support highlight 2-6 digit<br>
                    <strong>Komponen yang didukung:</strong><br>
                    ‚Ä¢ <code>A</code>=AS ‚Ä¢ <code>C</code>=COP ‚Ä¢ <code>K</code>=KEPALA ‚Ä¢ <code>E</code>=EKOR<br>
                    ‚Ä¢ <code>J</code>=K+E ‚Ä¢ <code>Js</code>=K-E ‚Ä¢ <code>J3D</code>=C+K+E ‚Ä¢ <code>J4D</code>=A+C+K+E<br>
                </div>
            </div>
        </div>

        <div class="output-section">
            <div class="section-title">üì§ HASIL OUTPUT</div>
            <div class="result-box" id="resultOutput">// Hasil perhitungan akan muncul di sini
// Support multi kolom + highlight 2-6 digit:

// 6987 = <span style="color: #FF6B6B; font-weight: bold; background: rgba(0,0,0,0.1); padding: 1px 3px; border-radius: 3px;">0</span><span style="color: #4ECDC4; font-weight: bold; background: rgba(0,0,0,0.1); padding: 1px 3px; border-radius: 3px;">2</span>3456789 ai
// 7070 = <span style="color: #FF6B6B; font-weight: bold; background: rgba(0,0,0,0.1); padding: 1px 3px; border-radius: 3px;">6</span><span style="color: #4ECDC4; font-weight: bold; background: rgba(0,0,0,0.1); padding: 1px 3px; border-radius: 3px;">8</span>9012345 ai
// ======
// A7mb+E7ty.(mb)

// 6987 = <span style="color: #FF6B6B; font-weight: bold; background: rgba(0,0,0,0.1); padding: 1px 3px; border-radius: 3px;">7</span><span style="color: #4ECDC4; font-weight: bold; background: rgba(0,0,0,0.1); padding: 1px 3px; border-radius: 3px;">5</span>8901234 ai
// 7070 = <span style="color: #FF6B6B; font-weight: bold; background: rgba(0,0,0,0.1); padding: 1px 3px; border-radius: 3px;">9</span><span style="color: #4ECDC4; font-weight: bold; background: rgba(0,0,0,0.1); padding: 1px 3px; border-radius: 3px;">7</span>0123456 ai
// ======
// C3ml-E3ty.(m9)

// ... dan seterusnya untuk setiap rumus</div>
            <br>
            <div class="button-group-double">
                <button class="btn-copy" onclick="copyOutput()">üìã SALIN OUTPUT</button>
                <button class="btn-copy-combined" onclick="copyCombinedOutput()">üîó SALIN GABUNGAN</button>
            </div>
        </div>
    </div>
</div>

<div class="copy-notification" id="copyNotification">
    ‚úÖ Output berhasil disalin ke clipboard!
</div>

<script>
// Tabel konversi mistik
const mistikTables = {
    'IX': {'0':'5', '1':'6', '2':'7', '3':'8', '4':'9', '5':'0', '6':'1', '7':'2', '8':'3', '9':'4'},
    'TY': {'0':'7', '1':'4', '2':'9', '3':'6', '4':'1', '5':'8', '6':'3', '7':'0', '8':'5', '9':'2'},
    'ML': {'0':'1', '1':'0', '2':'5', '3':'8', '4':'7', '5':'2', '6':'9', '7':'4', '8':'3', '9':'6'},
    'MB': {'0':'8', '1':'7', '2':'6', '3':'9', '4':'5', '5':'4', '6':'2', '7':'1', '8':'0', '9':'3'},
    'M0': {'0':'6', '1':'5', '2':'8', '3':'7', '4':'9', '5':'1', '6':'0', '7':'2', '8':'3', '9':'4'},
    'M1': {'0':'1', '1':'0', '2':'9', '3':'8', '4':'7', '5':'6', '6':'5', '7':'4', '8':'3', '9':'2'},
    'M2': {'0':'2', '1':'8', '2':'0', '3':'9', '4':'7', '5':'6', '6':'5', '7':'4', '8':'1', '9':'3'},
    'M3': {'0':'3', '1':'2', '2':'1', '3':'0', '4':'9', '5':'8', '6':'7', '7':'6', '8':'5', '9':'4'},
    'M4': {'0':'6', '1':'5', '2':'3', '3':'2', '4':'7', '5':'1', '6':'0', '7':'4', '8':'9', '9':'8'},
    'M5': {'0':'5', '1':'4', '2':'3', '3':'2', '4':'1', '5':'0', '6':'9', '7':'8', '8':'7', '9':'6'},
    'M6': {'0':'6', '1':'8', '2':'4', '3':'5', '4':'2', '5':'3', '6':'0', '7':'9', '8':'1', '9':'7'},
    'M7': {'0':'7', '1':'6', '2':'5', '3':'4', '4':'3', '5':'2', '6':'1', '7':'0', '8':'9', '9':'8'},
    'M8': {'0':'8', '1':'7', '2':'6', '3':'5', '4':'9', '5':'3', '6':'1', '7':'2', '8':'0', '9':'4'},
    'M9': {'0':'9', '1':'8', '2':'7', '3':'6', '4':'5', '5':'4', '6':'3', '7':'2', '8':'1', '9':'0'},
    'M10': {'0':'4', '1':'2', '2':'1', '3':'8', '4':'0', '5':'6', '6':'5', '7':'9', '8':'3', '9':'7'},
};

let dataHistory = [];
let currentFormulas = [];
let originalInputData = [];
let aiHistory = [];

// Fungsi untuk extract hanya bagian rumus (abaikan @AB #12, dll)
function extractFormulaOnly(line) {
    // Hapus bagian setelah tab (\t)
    if (line.includes('\t')) {
        line = line.split('\t')[0].trim();
    }
    
    // Hapus bagian setelah 2+ spasi (format: "rumus  @AB #12")
    const doubleSpaceIndex = line.indexOf('  ');
    if (doubleSpaceIndex !== -1) {
        line = line.substring(0, doubleSpaceIndex).trim();
    }
    
    // Hapus bagian setelah "@" jika langsung menyusul
    const atIndex = line.indexOf(' @');
    if (atIndex !== -1) {
        line = line.substring(0, atIndex).trim();
    }
    
    // Hapus bagian setelah "#" jika langsung menyusul
    const hashIndex = line.indexOf(' #');
    if (hashIndex !== -1) {
        line = line.substring(0, hashIndex).trim();
    }
    
    // Normalisasi karakter khusus
    line = line.replace(/[‚Äì‚Äî]/g, '-');
    
    // Hapus komentar
    if (line.includes('//')) {
        line = line.split('//')[0].trim();
    }
    
    return line.trim();
}

function parseInputData(inputData) {
    dataHistory = [];
    currentFormulas = [];
    originalInputData = [];
    aiHistory = [];
    
    const lines = inputData.split('\n').filter(line => line.trim());
    let foundSeparator = false;
    const tempData = [];
    const tempFormulas = [];
    
    for (let line of lines) {
        line = line.trim();
        
        if (line === '======' || line.startsWith('======')) {
            foundSeparator = true;
            continue;
        }
        
        if (foundSeparator && line) {
            // Extract hanya bagian rumus
            const formula = extractFormulaOnly(line);
            
            if (formula && !formula.startsWith('//')) {
                tempFormulas.push(formula);
            }
        }
        
        if (!foundSeparator) {
            const numberMatch = line.match(/(\d{4})/);
            if (numberMatch) {
                const number = numberMatch[1];
                
                const as = number[0];
                const cop = number[1];
                const kepala = number[2];
                const ekor = number[3];
                const jumlah = reduceToSingleDigit(parseInt(kepala) + parseInt(ekor));
                
                tempData.push({
                    number: number,
                    as: as,
                    cop: cop,
                    kepala: kepala,
                    ekor: ekor,
                    jumlah: jumlah
                });
                
                // Extract semua kolom AI (support 2-6 digit)
                const aiMatch = line.match(/(\d{4})\s*=\s*(.+?)\s*ai$/i);
                if (aiMatch) {
                    const aiParts = aiMatch[2].split('.').map(part => {
                        const trimmed = part.trim();
                        return (trimmed === 'Xx' || trimmed === 'xx' || trimmed === 'XX') ? 'Xx' : trimmed;
                    });
                    
                    const aiColumns = [];
                    for (let i = 0; i < Math.min(aiParts.length, 6); i++) {
                        aiColumns.push(aiParts[i] || '');
                    }
                    
                    originalInputData.push({
                        number: aiMatch[1],
                        ai_columns: aiColumns,
                        type: 'ai'
                    });
                } else {
                    originalInputData.push({
                        number: number,
                        ai_columns: [],
                        type: ''
                    });
                }
            }
        }
    }
    
    dataHistory = tempData;
    currentFormulas = tempFormulas;
    
    updateFormulaDisplay();
    
    if (currentFormulas.length > 0) {
        const maxDaysNeeded = currentFormulas.map(formula => findMaxDayInFormula(formula));
        const maxDay = Math.max(...maxDaysNeeded);
        document.getElementById('historyInfo').textContent = 
            `Butuh ${maxDay} hari history. ${currentFormulas.length} rumus terdeteksi.`;
    }
    
    return {
        data: dataHistory,
        formulas: currentFormulas
    };
}

function updateFormulaDisplay() {
    const formulaDisplay = document.getElementById('detectedFormula');
    
    if (currentFormulas.length === 0) {
        formulaDisplay.textContent = 'Tidak ada rumus';
    } else {
        formulaDisplay.innerHTML = currentFormulas.map((formula, index) => 
            `<div class="formula-item"><span class="formula-index">R${index + 1}:</span> ${formula}</div>`
        ).join('');
    }
}

function calculateFormula() {
    const inputData = document.getElementById('inputData').value.trim();
    
    if (!inputData) {
        showInfo('Masukkan data terlebih dahulu!', 'error');
        return;
    }
    
    try {
        const parsedData = parseInputData(inputData);
        
        if (currentFormulas.length === 0) {
            showInfo('Tidak ada rumus yang terdeteksi! Pastikan ada rumus setelah garis "======"', 'error');
            return;
        }
        
        displayAllFormulaResults(currentFormulas);
        showInfo(`Perhitungan berhasil! ${currentFormulas.length} rumus diproses.`, 'success');
        
    } catch (error) {
        showInfo(`Error: ${error.message}`, 'error');
        console.error('Calculation error:', error);
    }
}

function displayAllFormulaResults(formulas) {
    const output = document.getElementById('resultOutput');
    let outputHTML = '';
    
    // Untuk setiap rumus
    for (let i = 0; i < formulas.length; i++) {
        try {
            const results = calculateAIForSingleFormula(formulas[i]);
            
            // Tentukan highlight data dari KOLOM INPUT yang sesuai
            let highlightData = [];
            if (originalInputData.length > 0 && originalInputData[0].ai_columns) {
                const aiColumnIndex = Math.min(i, originalInputData[0].ai_columns.length - 1);
                highlightData = originalInputData.map(item => {
                    const aiValue = item.ai_columns[aiColumnIndex] || '';
                    return (aiValue === 'Xx' || aiValue === 'xx' || aiValue === 'XX') ? '' : aiValue;
                });
            }
            
            const formulaOutput = generateRotatedOutput(results, formulas[i], highlightData);
            
            // Tambah info rotasi
            const rotationInfo = getRotationInfoForFormula({ data: results, formula: formulas[i] }, i);
            outputHTML += formulaOutput + `\t${rotationInfo}`;
            
            if (i < formulas.length - 1) {
                outputHTML += '\n\n';
            }
            
        } catch (error) {
            outputHTML += `// ERROR pada rumus ${i+1}: ${formulas[i]}\n`;
            outputHTML += `// ${error.message}\n`;
            outputHTML += '======\n';
            outputHTML += formulas[i] + '\t@XX #Xx\n\n';
        }
    }
    
    output.innerHTML = outputHTML;
}

function calculateAIForSingleFormula(formula) {
    const results = [];
    const maxDayNeeded = findMaxDayInFormula(formula);
    
    aiHistory = [];
    
    for (let i = 0; i < dataHistory.length; i++) {
        if (i >= maxDayNeeded - 1) {
            const aiResult = calculateSingleAI(formula, i);
            results.push({
                number: dataHistory[i].number,
                ai: aiResult,
                canCalculate: true
            });
            aiHistory[i] = aiResult;
        } else {
            results.push({
                number: dataHistory[i].number,
                ai: '',
                canCalculate: false
            });
            aiHistory[i] = null;
        }
    }
    
    return results;
}

function generateRotatedOutput(results, formula, highlightData) {
    let output = '';
    let inheritedPositions = null;
    
    for (let i = 0; i < results.length; i++) {
        const result = results[i];
        
        if (result.canCalculate) {
            const highlightAI = highlightData[i] || '';
            const rotatedResult = formatAIWithColorAndInheritance(result.ai, highlightAI, inheritedPositions);
            
            let suffix = '';
            const highlightedCount = rotatedResult.highlightCount;
            
            if (highlightedCount === 2) {
                suffix = ' ai';
            } else if (highlightedCount > 2) {
                suffix = ` (${highlightedCount} digit)`;
            }
            
            output += `${result.number} = ${rotatedResult.rotatedDigits}${suffix}\n`;
            
            inheritedPositions = rotatedResult.highlightPositions;
        } else {
            output += `${result.number} = \n`;
            inheritedPositions = null;
        }
    }
    
    output += '======\n';
    output += formula;
    
    return output;
}

function formatAIWithColorAndInheritance(calculatedAI, highlightAI, inheritedPositions) {
    let rotatedDigits = '';
    const allDigits = '0123456789';
    const startIndex = allDigits.indexOf(calculatedAI.toString());
    
    for (let i = 0; i < allDigits.length; i++) {
        const actualIndex = (startIndex + i) % allDigits.length;
        rotatedDigits += allDigits[actualIndex];
    }
    
    let highlightPositions = [];
    
    if (highlightAI && highlightAI.trim() !== '') {
        const highlightDigits = highlightAI.toString().split('');
        
        highlightDigits.forEach((digit, index) => {
            if (digit >= '0' && digit <= '9') {
                const position = rotatedDigits.indexOf(digit);
                if (position !== -1 && !highlightPositions.some(p => p.position === position)) {
                    highlightPositions.push({
                        position: position,
                        digit: digit,
                        index: index
                    });
                }
            }
        });
        
        highlightPositions.sort((a, b) => a.position - b.position);
    }
    
    if (highlightPositions.length === 0 && inheritedPositions) {
        inheritedPositions.forEach((pos, index) => {
            if (pos >= 0 && pos < rotatedDigits.length) {
                highlightPositions.push({
                    position: pos,
                    digit: rotatedDigits[pos],
                    index: index
                });
            }
        });
    }
    
    let result = '';
    const highlightColors = [
        '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', 
        '#FFEAA7', '#DDA0DD', '#FFA07A', '#20B2AA',
        '#778899', '#D8BFD8'
    ];
    
    for (let i = 0; i < rotatedDigits.length; i++) {
        const digit = rotatedDigits[i];
        const highlight = highlightPositions.find(h => h.position === i);
        
        if (highlight) {
            const colorIndex = highlight.index % highlightColors.length;
            const color = highlightColors[colorIndex];
            result += `<span style="color: ${color}; font-weight: bold; background: rgba(0,0,0,0.1); padding: 1px 3px; border-radius: 3px;">${digit}</span>`;
        } else {
            result += digit;
        }
    }
    
    return {
        rotatedDigits: result,
        highlightPositions: highlightPositions.map(h => h.position),
        highlightCount: highlightPositions.length
    };
}

function copyOutput() {
    const outputElement = document.getElementById('resultOutput');
    let copyText = '';
    
    const lines = outputElement.innerHTML.split('\n');
    let currentBlock = '';
    let blocks = [];
    let waitingForFormula = false;
    
    for (let line of lines) {
        line = line.trim();
        
        if (line === '======') {
            waitingForFormula = true;
            currentBlock += '======\n';
            continue;
        }
        
        if (line.includes('//')) {
            continue;
        }
        
        if (waitingForFormula && line && !line.includes('//')) {
            // Extract hanya rumus (abaikan @AB #12)
            const formulaOnly = extractFormulaOnly(line);
            currentBlock += formulaOnly + '\n';
            waitingForFormula = false;
            blocks.push(currentBlock.trim());
            currentBlock = '';
            continue;
        }
        
        const numberMatch = line.match(/(\d{4})\s*=/);
        if (numberMatch) {
            const number = numberMatch[1];
            
            const regex = /<span[^>]*>(\d)<\/span>/g;
            let match;
            let highlightedDigits = '';
            
            while ((match = regex.exec(line)) !== null) {
                highlightedDigits += match[1];
            }
            
            if (highlightedDigits) {
                const suffix = highlightedDigits.length === 2 ? ' ai' : '';
                currentBlock += `${number} = ${highlightedDigits}${suffix}\n`;
            } else {
                currentBlock += `${number} = \n`;
            }
        }
    }
    
    if (currentBlock.trim()) {
        blocks.push(currentBlock.trim());
    }
    
    copyText = blocks.join('\n\n');
    
    if (!copyText || copyText.includes('Hasil perhitungan akan muncul di sini')) {
        showInfo('Tidak ada output yang bisa disalin!', 'error');
        return;
    }
    
    navigator.clipboard.writeText(copyText).then(() => {
        showCopyNotification();
    }).catch(err => {
        const textArea = document.createElement('textarea');
        textArea.value = copyText;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showCopyNotification();
    });
}

function copyCombinedOutput() {
    const outputElement = document.getElementById('resultOutput');
    
    // Parse semua hasil
    const lines = outputElement.innerHTML.split('\n');
    const blocks = [];
    let currentBlock = [];
    let waitingForFormula = false;
    let currentFormula = '';
    
    for (let line of lines) {
        line = line.trim();
        
        if (line === '======') {
            waitingForFormula = true;
            if (currentBlock.length > 0) {
                blocks.push({
                    data: currentBlock,
                    formula: currentFormula
                });
            }
            currentBlock = [];
            continue;
        }
        
        if (waitingForFormula && line && !line.includes('//')) {
            currentFormula = extractFormulaOnly(line);
            waitingForFormula = false;
            continue;
        }
        
        if (line.includes('//')) {
            continue;
        }
        
        const numberMatch = line.match(/(\d{4})\s*=\s*(.*?)(?:\s+(ai|\(\d+ digit\)))?$/);
        if (numberMatch) {
            const number = numberMatch[1];
            const digits = numberMatch[2] || '';
            
            const regex = /<span[^>]*>(\d)<\/span>/g;
            let match;
            let highlightedDigits = '';
            
            while ((match = regex.exec(digits)) !== null) {
                highlightedDigits += match[1];
            }
            
            currentBlock.push({
                number: number,
                ai: highlightedDigits
            });
        }
    }
    
    if (currentBlock.length > 0) {
        blocks.push({
            data: currentBlock,
            formula: currentFormula
        });
    }
    
    const combinedText = combineAllResults(blocks);
    
    if (!combinedText || combinedText.includes('Hasil perhitungan akan muncul di sini')) {
        showInfo('Tidak ada output yang bisa disalin!', 'error');
        return;
    }
    
    navigator.clipboard.writeText(combinedText).then(() => {
        showCopyNotification();
    }).catch(err => {
        const textArea = document.createElement('textarea');
        textArea.value = combinedText;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showCopyNotification();
    });
}

function combineAllResults(blocks) {
    if (blocks.length === 0) return '';
    
    const maxLength = Math.max(...blocks.map(block => block.data.length));
    const allNumbers = blocks[0].data.map(item => item.number);
    
    const combinedResults = [];
    
    for (let i = 0; i < maxLength; i++) {
        const number = allNumbers[i] || '';
        const columns = [];
        
        for (let j = 0; j < blocks.length; j++) {
            const block = blocks[j];
            const dataItem = block.data[i];
            
            if (dataItem && dataItem.ai) {
                // Tentukan jumlah digit dari info rotasi
                const rotationInfo = getRotationInfoForFormula(block, j);
                const hashMatch = rotationInfo.match(/#(.+)$/);
                const hashValue = hashMatch ? hashMatch[1] : 'Xx';
                
                if (hashValue === 'Xx' || hashValue === 'xx' || hashValue === 'XX') {
                    const lettersMatch = rotationInfo.match(/@([A-J]+)/);
                    const digitCount = lettersMatch ? lettersMatch[1].length : 2;
                    columns.push('Xx'.repeat(Math.ceil(digitCount / 2)).slice(0, digitCount));
                } else {
                    columns.push(hashValue);
                }
            } else {
                const rotationInfo = getRotationInfoForFormula(block, j);
                const lettersMatch = rotationInfo.match(/@([A-J]+)/);
                const digitCount = lettersMatch ? lettersMatch[1].length : 2;
                columns.push('Xx'.repeat(Math.ceil(digitCount / 2)).slice(0, digitCount));
            }
        }
        
        while (columns.length < 4) {
            columns.push('Xx');
        }
        
        combinedResults.push(`${number} = ${columns.join(' . ')} ai`);
    }
    
    let resultText = combinedResults.join('\n');
    resultText += '\n======\n';
    
    const formulaLines = blocks.map((block, index) => {
        const formula = block.formula;
        const rotationInfo = getRotationInfoForFormula(block, index);
        return `${formula}\t${rotationInfo}`;
    });
    
    resultText += formulaLines.join('\n');
    
    return resultText;
}

function getRotationInfoForFormula(block, formulaIndex) {
    if (!block.data || block.data.length === 0) {
        return `@XX #Xx`;
    }
    
    let lastValidData = null;
    let lastIndex = -1;
    
    for (let i = block.data.length - 1; i >= 0; i--) {
        if (block.data[i] && block.data[i].ai) {
            lastValidData = block.data[i];
            lastIndex = i;
            break;
        }
    }
    
    if (!lastValidData) {
        return `@XX #Xx`;
    }
    
    const lastAI = lastValidData.ai;
    
    let highlightAI = '';
    if (originalInputData.length > 0 && originalInputData[0].ai_columns) {
        const aiColumnIndex = Math.min(formulaIndex, originalInputData[0].ai_columns.length - 1);
        const inputItem = originalInputData[lastIndex];
        if (inputItem && inputItem.ai_columns) {
            highlightAI = inputItem.ai_columns[aiColumnIndex] || '';
            if (highlightAI === 'Xx' || highlightAI === 'xx' || highlightAI === 'XX') {
                highlightAI = '';
            }
        }
    }
    
    const rotationLetters = getRotationLetters(lastAI, highlightAI);
    
    let hashValue;
    if (!highlightAI || highlightAI.trim() === '') {
        const digitCount = rotationLetters.length;
        hashValue = 'Xx'.repeat(Math.ceil(digitCount / 2)).slice(0, digitCount);
    } else {
        hashValue = highlightAI;
    }
    
    return `@${rotationLetters} #${hashValue}`;
}

function getRotationLetters(calculatedAI, highlightAI) {
    if (!highlightAI || highlightAI.trim() === '') {
        return 'XX';
    }
    
    const allDigits = '0123456789';
    const startIndex = allDigits.indexOf(calculatedAI.toString());
    
    const positions = [];
    const highlightDigits = highlightAI.toString().split('');
    
    for (let digit of highlightDigits) {
        if (digit >= '0' && digit <= '9') {
            for (let j = 0; j < allDigits.length; j++) {
                const actualIndex = (startIndex + j) % allDigits.length;
                if (allDigits[actualIndex] === digit) {
                    positions.push(j);
                    break;
                }
            }
        }
    }
    
    positions.sort((a, b) => a - b);
    
    const letters = positions.map(pos => {
        if (pos < 10) {
            return String.fromCharCode(65 + pos);
        } else {
            return String.fromCharCode(65 + (pos % 10));
        }
    });
    
    if (letters.length === 0) {
        return 'XX';
    }
    
    return letters.join('');
}

function findMaxDayInFormula(formula) {
    let maxDay = 1;
    let workingFormula = formula.replace(/\.\((\w+)\)/, '');
    
    const componentRegex = /(A|C|K|E|J|Js|J3D|J4D)(\d+)/g;
    let match;
    
    while ((match = componentRegex.exec(workingFormula)) !== null) {
        const day = parseInt(match[2]);
        if (day > maxDay) {
            maxDay = day;
        }
    }
    
    return maxDay;
}

function calculateSingleAI(formula, currentDayIndex) {
    let workingFormula = formula;
    const finalConversion = workingFormula.match(/\.\((\w+)\)/);
    if (finalConversion) {
        workingFormula = workingFormula.replace(/\.\((\w+)\)/, '');
    }
    
    const components = workingFormula.split(/([+\-])/);
    let total = 0;
    let currentOperator = '+';
    
    for (let i = 0; i < components.length; i++) {
        const component = components[i].trim();
        
        if (component === '+' || component === '-') {
            currentOperator = component;
            continue;
        }
        
        if (component) {
            const value = processComponent(component, currentDayIndex);
            
            if (currentOperator === '+') {
                total += value;
            } else if (currentOperator === '-') {
                total -= value;
            }
        }
    }
    
    if (total < 0) {
        total = Math.abs(total);
    }
    
    if (finalConversion) {
        const table = finalConversion[1].toUpperCase();
        const converted = convertMistik(total.toString(), table);
        total = parseInt(converted);
    }
    
    const finalResult = reduceToSingleDigit(total);
    
    aiHistory[currentDayIndex] = finalResult;
    
    return finalResult;
}

function processComponent(component, currentDayIndex) {
    component = component.replace(/[‚Äì‚Äî]/g, '-');
    
    const match = component.match(/^(A|C|K|E|J|Js|J3D|J4D)(\d+)(\w*)$/);
    if (!match) {
        throw new Error(`Format komponen tidak valid: ${component}`);
    }
    
    const type = match[1];
    const dayOffset = parseInt(match[2]);
    const conversion = match[3];
    
    const targetDayIndex = currentDayIndex - (dayOffset - 1);
    
    if (targetDayIndex < 0 || targetDayIndex >= dataHistory.length) {
        throw new Error(`Data tidak tersedia untuk ${component} (butuh ${dayOffset} hari history)`);
    }
    
    const data = dataHistory[targetDayIndex];
    let value;
    
    switch(type) {
        case 'A': value = parseInt(data.as); break;
        case 'C': value = parseInt(data.cop); break;
        case 'K': value = parseInt(data.kepala); break;
        case 'E': value = parseInt(data.ekor); break;
        case 'J': value = data.jumlah; break;
        case 'Js': 
            value = Math.abs(parseInt(data.kepala) - parseInt(data.ekor));
            value = reduceToSingleDigit(value);
            break;
        case 'J3D':
            value = parseInt(data.cop) + parseInt(data.kepala) + parseInt(data.ekor);
            value = reduceToSingleDigit(value);
            break;
        case 'J4D':
            value = parseInt(data.as) + parseInt(data.cop) + parseInt(data.kepala) + parseInt(data.ekor);
            value = reduceToSingleDigit(value);
            break;
        default: 
            throw new Error(`Tipe komponen tidak dikenali: ${type}`);
    }
    
    if (conversion) {
        const table = conversion.toUpperCase();
        value = parseInt(convertMistik(value.toString(), table));
    }
    
    return value;
}

function convertMistik(number, table) {
    if (!mistikTables[table]) {
        throw new Error(`Tabel mistik tidak ditemukan: ${table}`);
    }
    
    const digit = reduceToSingleDigit(parseInt(number)).toString();
    
    if (mistikTables[table][digit] === undefined) {
        throw new Error(`Angka ${digit} tidak ada di tabel ${table}`);
    }
    
    return mistikTables[table][digit];
}

function reduceToSingleDigit(num) {
    let result = num;
    while (result > 9) {
        result = result.toString().split('').reduce((sum, digit) => sum + parseInt(digit), 0);
    }
    return result;
}

function clearAll() {
    document.getElementById('inputData').value = '';
    document.getElementById('resultOutput').innerHTML = `// Hasil perhitungan akan muncul di sini
// Support multi kolom + highlight 2-6 digit:

// 6987 = <span style="color: #FF6B6B; font-weight: bold; background: rgba(0,0,0,0.1); padding: 1px 3px; border-radius: 3px;">0</span><span style="color: #4ECDC4; font-weight: bold; background: rgba(0,0,0,0.1); padding: 1px 3px; border-radius: 3px;">2</span>3456789 ai
// 7070 = <span style="color: #FF6B6B; font-weight: bold; background: rgba(0,0,0,0.1); padding: 1px 3px; border-radius: 3px;">6</span><span style="color: #4ECDC4; font-weight: bold; background: rgba(0,0,0,0.1); padding: 1px 3px; border-radius: 3px;">8</span>9012345 ai
// ======
// A7mb+E7ty.(mb)

// 6987 = <span style="color: #FF6B6B; font-weight: bold; background: rgba(0,0,0,0.1); padding: 1px 3px; border-radius: 3px;">7</span><span style="color: #4ECDC4; font-weight: bold; background: rgba(0,0,0,0.1); padding: 1px 3px; border-radius: 3px;">5</span>8901234 ai
// 7070 = <span style="color: #FF6B6B; font-weight: bold; background: rgba(0,0,0,0.1); padding: 1px 3px; border-radius: 3px;">9</span><span style="color: #4ECDC4; font-weight: bold; background: rgba(0,0,0,0.1); padding: 1px 3px; border-radius: 3px;">7</span>0123456 ai
// ======
// C3ml-E3ty.(m9)

// ... dan seterusnya untuk setiap rumus`;
    document.getElementById('info').innerHTML = `Masukkan data dengan format angka dan multiple rumus, lalu klik HITUNG RUMUS
    <div style="margin-top: 10px; font-size: 12px; text-align: left; background: #e8f5e8; padding: 10px; border-radius: 8px;">
        <strong>Format Input Multi Kolom:</strong><br>
        ‚Ä¢ <code>6987 = 02 . 75 . 27 . 37 ai</code><br>
        ‚Ä¢ Kolom 1 ‚Üí Rumus 1, Kolom 2 ‚Üí Rumus 2, Kolom 3 ‚Üí Rumus 3, Kolom 4 ‚Üí Rumus 4<br>
        ‚Ä¢ Support highlight 2-6 digit<br>
        <strong>Komponen yang didukung:</strong><br>
        ‚Ä¢ <code>A</code>=AS ‚Ä¢ <code>C</code>=COP ‚Ä¢ <code>K</code>=KEPALA ‚Ä¢ <code>E</code>=EKOR<br>
        ‚Ä¢ <code>J</code>=K+E ‚Ä¢ <code>Js</code>=K-E ‚Ä¢ <code>J3D</code>=C+K+E ‚Ä¢ <code>J4D</code>=A+C+K+E<br>
    </div>`;
    document.getElementById('inputInfo').textContent = '0 angka + 0 rumus terdeteksi';
    document.getElementById('detectedFormula').textContent = 'Tidak ada rumus';
    document.getElementById('historyInfo').textContent = 'Butuh 0 hari history. Data terbaru (bawah) membutuhkan data sebelumnya (atas) untuk perhitungan.';
    dataHistory = [];
    currentFormulas = [];
    originalInputData = [];
    aiHistory = [];
}

function showInfo(message, type) {
    const infoDiv = document.getElementById('info');
    infoDiv.innerHTML = message;
    infoDiv.className = 'info';
    if (type === 'error') {
        infoDiv.classList.add('error');
    } else if (type === 'success') {
        infoDiv.classList.add('success');
    }
}

function updateInputInfo() {
    const input = document.getElementById('inputData').value.trim();
    const parsed = parseInputData(input);
    const numberCount = dataHistory.length;
    const formulaCount = currentFormulas.length;
    
    document.getElementById('inputInfo').textContent = `${numberCount} angka + ${formulaCount} rumus terdeteksi`;
}

function showCopyNotification() {
    const notification = document.getElementById('copyNotification');
    notification.classList.add('show');
    setTimeout(() => {
        notification.classList.remove('show');
    }, 3000);
}

document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('inputData').addEventListener('input', updateInputInfo);
    updateInputInfo();
});

document.getElementById('inputData').addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.key === 'Enter') {
        calculateFormula();
    }
});
</script>

</body>
</html>
