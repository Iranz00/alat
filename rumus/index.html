<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rumus Otomatis & Semi-Auto - RAN</title>
    <style>
        /* ========== GLOBAL RESET & FONTS ========== */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body { 
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            overflow-x: hidden;
            transition: all 0.3s ease;
        }
        
        /* ========== DARK MODE THEME ========== */
        body.dark-theme {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            color: #e2e8f0;
        }
        
        /* ========== CONTAINERS ========== */
        .main-container { 
            max-width: 1400px; 
            width: 100%;
            margin: 0 auto; 
            background: white; 
            border-radius: 20px; 
            padding: 30px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
        }
        
        body.dark-theme .main-container {
            background: #2d3748;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        
        .header { 
            text-align: center; 
            margin-bottom: 25px; 
        }
        
        .header h1 { 
            color: #2d3748; 
            margin-bottom: 8px; 
            font-size: 2.2rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
        }
        
        body.dark-theme .header h1 {
            color: #e2e8f0;
        }
        
        .subtitle { 
            text-align: center; 
            color: #718096; 
            font-size: 15px; 
            margin-bottom: 25px;
            line-height: 1.5;
            transition: all 0.3s ease;
        }
        
        body.dark-theme .subtitle {
            color: #a0aec0;
        }
        
        /* ========== THEME TOGGLE ========== */
        .theme-toggle {
            text-align: center;
            margin-bottom: 25px;
        }
        
        .theme-toggle button {
            background: linear-gradient(135deg, #4a5568, #718096);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .theme-toggle button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        
        body.dark-theme .theme-toggle button {
            background: linear-gradient(135deg, #718096, #4a5568);
        }
        
        /* ========== TAB SYSTEM ========== */
        .tab-container {
            margin-bottom: 30px;
        }
        
        .tab-buttons {
            display: flex;
            background: #f8fafc;
            border-radius: 12px;
            padding: 5px;
            margin-bottom: 20px;
        }
        
        body.dark-theme .tab-buttons {
            background: #4a5568;
        }
        
        .tab-btn {
            flex: 1;
            padding: 15px 20px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: #4a5568;
        }
        
        body.dark-theme .tab-btn {
            color: #cbd5e0;
        }
        
        .tab-btn:hover {
            background: rgba(102, 126, 234, 0.1);
        }
        
        body.dark-theme .tab-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .tab-btn.active {
            background: white;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            color: #667eea;
        }
        
        body.dark-theme .tab-btn.active {
            background: #2d3748;
            color: #667eea;
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ========== PROGRAM 1 STYLES ========== */
        .grid-container-1 { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 25px; 
            margin-bottom: 25px;
        }
        
        .input-section-1, .output-section-1 { 
            background: #f8f9fa; 
            padding: 25px; 
            border-radius: 15px; 
            border: 2px solid #e9ecef;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }
        
        body.dark-theme .input-section-1,
        body.dark-theme .output-section-1 {
            background: #4a5568;
            border-color: #718096;
        }
        
        .section-title-1 { 
            color: #2d3748; 
            margin-bottom: 20px; 
            font-size: 18px; 
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        
        body.dark-theme .section-title-1 {
            color: #e2e8f0;
        }
        
        .data-input-1 { 
            margin-bottom: 20px;
        }
        
        .data-input-1 textarea { 
            width: 100%; 
            height: 200px; 
            padding: 15px; 
            border: 2px solid #e2e8f0; 
            border-radius: 12px; 
            font-size: 15px; 
            resize: vertical; 
            margin-bottom: 10px;
            font-family: 'Courier New', monospace;
            transition: all 0.3s ease;
            background: white;
            color: #333;
        }
        
        body.dark-theme .data-input-1 textarea {
            background: #2d3748;
            border-color: #718096;
            color: #e2e8f0;
        }
        
        .data-input-1 textarea:focus { 
            border-color: #667eea; 
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        body.dark-theme .data-input-1 textarea:focus {
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }
        
        .formula-display-1 {
            background: #1a202c;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            margin-bottom: 20px;
            border: 2px solid #2d3748;
            font-size: 14px;
            text-align: left;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .button-group-1 { 
            display: flex; 
            gap: 12px; 
            margin-bottom: 20px;
        }
        
        .button-group-double-1 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .button-1 { 
            padding: 15px; 
            border: none; 
            border-radius: 12px; 
            font-size: 15px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: white;
        }
        
        .btn-calculate-1 { 
            background: linear-gradient(135deg, #2196F3, #1976D2);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }
        
        .btn-clear-1 { 
            background: linear-gradient(135deg, #f44336, #f44336);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }
        
        .btn-copy-1 { 
            background: linear-gradient(135deg, #009688, #00796B);
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
        }
        
        .button-1:hover { 
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        
        .button-1:active {
            transform: translateY(-1px);
        }
        
        .info-1 { 
            background: #e3f2fd; 
            padding: 18px; 
            border-radius: 12px; 
            margin-bottom: 20px; 
            text-align: center;
            font-weight: 500;
            border-left: 4px solid #2196F3;
            transition: all 0.3s ease;
            color: #333;
        }
        
        body.dark-theme .info-1 {
            background: #4a5568;
            border-left-color: #667eea;
            color: #e2e8f0;
        }
        
        .info-1.success {
            background: #e8f5e8;
            border-left-color: #4CAF50;
            color: #2e7d32;
        }
        
        body.dark-theme .info-1.success {
            background: #2d5c2d;
            border-left-color: #4CAF50;
            color: #e8f5e8;
        }
        
        .info-1.error {
            background: #ffebee;
            border-left-color: #f44336;
            color: #c62828;
        }
        
        body.dark-theme .info-1.error {
            background: #5c2d2d;
            border-left-color: #f44336;
            color: #ffebee;
        }
        
        .input-info-1 { 
            text-align: center; 
            color: #718096; 
            font-size: 13px; 
            margin-bottom: 15px;
            font-weight: 500;
        }
        
        body.dark-theme .input-info-1 {
            color: #a0aec0;
        }
        
        .result-box-1 { 
            background: #1a202c; 
            color: #e2e8f0; 
            padding: 25px; 
            border-radius: 12px; 
            font-family: 'Courier New', monospace; 
            min-height: 200px; 
            white-space: pre-wrap; 
            line-height: 1.6;
            border: 1px solid #2d3748;
            font-size: 14px;
            overflow-y: auto;
            max-height: 400px;
            position: relative;
        }
        
        .result-box-1::-webkit-scrollbar {
            width: 8px;
        }
        
        .result-box-1::-webkit-scrollbar-track {
            background: #2d3748;
            border-radius: 4px;
        }
        
        .result-box-1::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 4px;
        }
        
        .result-box-1::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
        
        .formula-label-1 {
            color: #a0aec0;
            font-size: 12px;
            margin-bottom: 5px;
            text-align: center;
        }
        
        .history-info-1 {
            background: #e8f5e8;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 12px;
            color: #2e7d32;
            text-align: center;
            border-left: 4px solid #4CAF50;
        }
        
        body.dark-theme .history-info-1 {
            background: #2d5c2d;
            color: #e8f5e8;
        }
        
        /* ========== PROGRAM 2 STYLES ========== */
        .grid-container-2 { 
            display: grid; 
            grid-template-columns: 1fr 1.2fr; 
            gap: 20px; 
            margin-bottom: 25px;
        }
        
        .input-section-2, .output-section-2 { 
            background: #f8f9fa; 
            padding: 20px; 
            border-radius: 12px; 
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }
        
        body.dark-theme .input-section-2,
        body.dark-theme .output-section-2 {
            background: #4a5568;
            border-color: #718096;
        }
        
        .section-title-2 { 
            color: #0c2461; 
            margin-bottom: 12px; 
            font-size: 15px; 
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        
        body.dark-theme .section-title-2 {
            color: #e2e8f0;
        }
        
        .data-input-2 textarea { 
            width: 100%; 
            height: 140px; 
            padding: 12px; 
            border: 2px solid #4a69bd; 
            border-radius: 8px; 
            font-size: 13px; 
            resize: vertical; 
            margin-bottom: 12px;
            font-family: 'Courier New', monospace;
            background: white;
            color: #333;
            transition: all 0.3s ease;
        }
        
        body.dark-theme .data-input-2 textarea {
            background: #2d3748;
            border-color: #718096;
            color: #e2e8f0;
        }
        
        .data-input-2 textarea:focus {
            border-color: #4a69bd;
            outline: none;
            box-shadow: 0 0 0 3px rgba(74, 105, 189, 0.1);
        }
        
        body.dark-theme .data-input-2 textarea:focus {
            box-shadow: 0 0 0 3px rgba(74, 105, 189, 0.2);
        }
        
        .controls-2 { 
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .control-group-2 {
            display: flex;
            flex-direction: column;
        }
        
        .control-group-2 label {
            font-size: 12px;
            color: #1e3799;
            margin-bottom: 4px;
            font-weight: 600;
        }
        
        body.dark-theme .control-group-2 label {
            color: #a0aec0;
        }
        
        .control-group-2 input, .control-group-2 select {
            padding: 8px 10px;
            border: 2px solid #4a69bd;
            border-radius: 6px;
            font-size: 13px;
            background: white;
            color: #333;
            transition: all 0.3s ease;
        }
        
        body.dark-theme .control-group-2 input,
        body.dark-theme .control-group-2 select {
            background: #2d3748;
            border-color: #718096;
            color: #e2e8f0;
        }
        
        .button-group-2 { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr);
            gap: 8px; 
            margin-bottom: 12px;
        }
        
        .button-2 { 
            padding: 10px 12px; 
            border: none; 
            border-radius: 6px; 
            font-size: 12px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            color: white;
        }
        
        .btn-run-2 { 
            background: linear-gradient(135deg, #009688, #00796B);
            grid-column: span 2;
        }
        
        .btn-stop-2 {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            grid-column: span 2;
        }
        
        .btn-continue-2 {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
        }
        
        .btn-clear-2 { 
            background: linear-gradient(135deg, #f44336, #f44336);
        }
        
        .btn-clear-output-2 {
            background: linear-gradient(135deg, #f44336, #f44336);
        }
        
        .btn-copy-2 {
            background: linear-gradient(135deg, #1abc9c, #16a085);
        }
        
        .button-2:hover:not(:disabled) { 
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .button-2:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .stats-2 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .stat-box-2 {
            background: #e8f4fc;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid #3498db;
            transition: all 0.3s ease;
        }
        
        body.dark-theme .stat-box-2 {
            background: #2d3748;
            border-color: #4a69bd;
        }
        
        .stat-label-2 {
            font-size: 10px;
            color: #3498db;
            margin-bottom: 2px;
        }
        
        body.dark-theme .stat-label-2 {
            color: #a0aec0;
        }
        
        .stat-value-2 {
            font-size: 14px;
            font-weight: bold;
            color: #0c2461;
        }
        
        body.dark-theme .stat-value-2 {
            color: #e2e8f0;
        }
        
        .result-box-2 { 
            background: #0d1b2a; 
            color: #e2e8f0; 
            padding: 15px; 
            border-radius: 10px; 
            font-family: 'Consolas', 'Courier New', monospace; 
            white-space: pre; 
            line-height: 1.3;
            border: 2px solid #1e3799;
            font-size: 12px;
            overflow-y: auto;
            height: 500px;
        }
        
        .info-status-2 {
            background: #e8f4fc;
            border: 1px solid #3498db;
            border-radius: 8px;
            padding: 10px 12px;
            margin-top: 10px;
            font-size: 12px;
            line-height: 1.4;
            color: #0c2461;
            transition: all 0.3s ease;
        }
        
        body.dark-theme .info-status-2 {
            background: #4a5568;
            border-color: #667eea;
            color: #e2e8f0;
        }
        
        .info-status-2 .warning {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .info-status-2 .success {
            color: #27ae60;
            font-weight: bold;
        }
        
        .info-status-2 .info-line-2 {
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
        }
        
        .info-status-2 .label-2 {
            color: #3498db;
            font-weight: 600;
        }
        
        body.dark-theme .info-status-2 .label-2 {
            color: #a0aec0;
        }
        
        .info-status-2 .value-2 {
            font-weight: bold;
        }
        
        .progress-bar-2 {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        body.dark-theme .progress-bar-2 {
            background: #4a5568;
        }
        
        .progress-fill-2 {
            height: 100%;
            background: linear-gradient(90deg, #2ecc71, #3498db);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .auto-continue-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            transition: all 0.3s ease;
        }
        
        body.dark-theme .auto-continue-checkbox {
            background: #4a5568;
            border-color: #718096;
        }
        
        .auto-continue-checkbox input {
            width: 16px;
            height: 16px;
        }
        
        .auto-continue-checkbox label {
            font-size: 12px;
            color: #495057;
            font-weight: 600;
            cursor: pointer;
        }
        
        body.dark-theme .auto-continue-checkbox label {
            color: #e2e8f0;
        }
        
        /* ========== SHARED COMPONENTS ========== */
        .copy-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #2ecc71;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            transform: translateX(150%);
            transition: transform 0.3s ease;
        }
        
        .copy-notification.show {
            transform: translateX(0);
        }
        
        .version-info {
            text-align: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
            color: #6c757d;
            font-size: 12px;
        }
        
        body.dark-theme .version-info {
            border-top-color: #718096;
            color: #a0aec0;
        }
        
        /* ========== RESPONSIVE DESIGN ========== */
        @media (max-width: 1100px) {
            .grid-container-1,
            .grid-container-2 {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .main-container {
                padding: 20px;
                border-radius: 15px;
            }
            
            .tab-buttons {
                flex-direction: column;
            }
            
            .tab-btn {
                padding: 12px 15px;
                font-size: 14px;
            }
            
            .button-group-2 {
                grid-template-columns: 1fr 1fr;
            }
            
            .btn-run-2, .btn-stop-2 {
                grid-column: span 1;
            }
            
            .controls-2 {
                grid-template-columns: 1fr;
            }
            
            .stats-2 {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .result-box-2 {
                height: 400px;
            }
            
            .button-group-1 {
                flex-direction: column;
            }
            
            .button-group-double-1 {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
        }
        
        @media (max-width: 480px) {
            .button-group-2 {
                grid-template-columns: 1fr;
            }
            
            .tab-btn {
                font-size: 13px;
                padding: 10px 12px;
            }
            
            .data-input-1 textarea {
                height: 150px;
            }
            
            .result-box-1 {
                max-height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- HEADER -->
        <div class="header">
            <h1>üí° PREDIKSI TOOLS üí°</h1>
            <div class="subtitle">Mencari Rumus Otomatis & Semi-Auto</div>
        </div>
        
        <!-- THEME TOGGLE -->
        <div class="theme-toggle">
            <button id="themeButton">
                <span id="themeIcon">üåô</span>
                <span id="themeText">Mode Gelap</span>
            </button>
        </div>
        
        <!-- TAB SYSTEM -->
        <div class="tab-container">
            <div class="tab-buttons">
                <button class="tab-btn" data-tab="program2">
                    <span>üîç</span>
                    <span>Rumus Otomatis</span>
                </button>
                <button class="tab-btn active" data-tab="program1">
                    <span>‚è≥</span>
                    <span>Rumus Semi-Auto</span>
                </button>
            </div>
            
            <!-- PROGRAM 1 CONTENT -->
            <div id="program1" class="tab-content active">
                <div class="grid-container-1">
                    <div class="input-section-1">
                        <div class="data-input-1">
                            <textarea id="inputData1" placeholder="Masukkan data dengan format:
8603 = 30 ai
2436 = 74 ai
...
4467 = 

ATAU

8603 = 30 ai
2436 = 74 ai
======
A3mb-A5m9.(ty)
Js6ml+E2ty.(mb)
J3D4mb-C5.(ix)
J4D2ml+K3.(ty)
A3+Js2-C1m8.(ty)"></textarea>
                            <div class="input-info-1" id="inputInfo1">0 angka + 0 rumus terdeteksi</div>
                        </div>
                        
                        <div class="formula-label-1">Rumus Terdeteksi:</div>
                        <div class="formula-display-1" id="detectedFormula1">Tidak ada rumus</div>
                        
                        <div class="history-info-1" id="historyInfo1">Butuh 0 hari history. Data terbaru (bawah) membutuhkan data sebelumnya (atas) untuk perhitungan.</div>
                        
                        <div class="button-group-1">
                            <button class="button-1 btn-calculate-1" onclick="Program1.calculateFormula()">üßÆ HITUNG RUMUS</button>
                            <button class="button-1 btn-clear-1" onclick="Program1.clearAll()">üóëÔ∏è HAPUS SEMUA</button>
                        </div>
                        
                    </div>

                    <div class="output-section-1">
                        <div class="section-title-1">üì§ HASIL OUTPUT</div>
                        <div class="result-box-1" id="resultOutput1">// Hasil perhitungan akan muncul di sini
// Support 1 - 6 digit:

// 8603 = <span style="color: #FF6B6B; font-weight: bold; background: rgba(0,0,0,0.1); padding: 1px 3px; border-radius: 3px;">3</span><span style="color: #4ECDC4; font-weight: bold; background: rgba(0,0,0,0.1); padding: 1px 3px; border-radius: 3px;">5</span>678901234
// 2436 = <span style="color: #FF6B6B; font-weight: bold; background: rgba(0,0,0,0.1); padding: 1px 3px; border-radius: 3px;">6</span><span style="color: #4ECDC4; font-weight: bold; background: rgba(0,0,0,0.1); padding: 1px 3px; border-radius: 3px;">8</span>901234567
// 5678 = <span style="color: #FF6B6B; font-weight: bold; background: rgba(0,0,0,0.1); padding: 1px 3px; border-radius: 3px;">9</span><span style="color: #4ECDC4; font-weight: bold; background: rgba(0,0,0,0.1); padding: 1px 3px; border-radius: 3px;">0</span>123456789
// ======
// Js6ml+E2ty.(mb)

// ... dan seterusnya untuk setiap rumus</div>
                        <br>
                        <div class="button-group-double-1">
                            <button class="button-1 btn-copy-1" onclick="Program1.copyOutput()">üìã SALIN OUTPUT</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- PROGRAM 2 CONTENT -->
            <div id="program2" class="tab-content">
                <div class="grid-container-2">
                    <div class="input-section-2">
                        <div class="section-title-2">üì• INPUT DATA</div>
                        
                        <div class="data-input-2">
                            <textarea id="numbers2" placeholder="Masukkan angka 4D (satu per baris):
6834
6176
2243
1563
6271
2518
4892
7361"></textarea>
                            
                            <div class="stats-2">
                                <div class="stat-box-2">
                                    <div class="stat-label-2">DATA</div>
                                    <div class="stat-value-2" id="dataCount2">0</div>
                                </div>
                                <div class="stat-box-2">
                                    <div class="stat-label-2">KOMBINASI</div>
                                    <div class="stat-value-2" id="formulaCount2">0</div>
                                </div>
                                <div class="stat-box-2">
                                    <div class="stat-label-2">HASIL</div>
                                    <div class="stat-value-2" id="foundCount2">0</div>
                                </div>
                                <div class="stat-box-2">
                                    <div class="stat-label-2">PROSES</div>
                                    <div class="stat-value-2" id="processedCount2">0</div>
                                </div>
                            </div>
                            
                            <div class="progress-bar-2">
                                <div class="progress-fill-2" id="progressFill2"></div>
                            </div>
                        </div>
                        
                        <div class="controls-2">
                            <div class="control-group-2">
                                <label>Hari Prediksi</label>
                                <input type="text" id="daysToPredict2" value="16" pattern="[0-9]*" maxlength="2" title="1-50 hari">
                            </div>
                            <div class="control-group-2">
                                <label>Digit Prediksi</label>
                                <input type="text" id="digitCount2" value="3" pattern="[1-7]" maxlength="1" title="1-7 digit">
                            </div>
                            <div class="control-group-2">
                                <label>Patah</label>
                                <input type="text" id="patah2" value="" pattern="[0-5]*" maxlength="1" placeholder="Kosong = 0" title="0-5 patah">
                            </div>
                            <div class="control-group-2">
                                <label>Prediksi Bagian</label>
                                <select id="targetType2">
                                    <option value="all">Semua (Auto Detect)</option>
                                    <option value="A">AS (Ribuan)</option>
                                    <option value="C">COP (Ratusan)</option>
                                    <option value="K">KEPALA (Puluhan)</option>
                                    <option value="E">EKOR (Satuan)</option>
                                    <option value="J">JUMLAH (K+E)</option>
                                    <option value="AC">AC (2D Depan)</option>
                                    <option value="CK">CK (2D Tengah)</option>
                                    <option value="KE" selected>KE (2D Belakang)</option>
                                    <option value="CB">CB (4D Lengkap)</option>
                                </select>
                            </div>
                            <div class="control-group-2">
                                <label>Mode</label>
                                <select id="searchMode2">
                                    <option value="full">LENGKAP</option>
                                    <option value="quick">CEPAT</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="auto-continue-checkbox">
                            <input type="checkbox" id="autoContinue2">
                            <label for="autoContinue2">Auto-continue semua sesi (pause 5 detik antar sesi)</label>
                        </div>
                
                        <div style="margin-top: 20px;"></div>
                
                        <div class="button-group-2">
                            <button class="button-2 btn-run-2" onclick="Program2.startSearch()" id="runBtn2">üöÄ CARI RUMUS</button>
                            <button class="button-2 btn-stop-2" onclick="Program2.stopSearch()" id="stopBtn2" disabled>‚èπÔ∏è STOP</button>
                            <button class="button-2 btn-continue-2" onclick="Program2.continueSearch()" id="continueBtn2" disabled>‚ñ∂Ô∏è LANJUT</button>
                            <button class="button-2 btn-clear-2" onclick="Program2.clearAll()">üóëÔ∏è HAPUS DATA</button>
                        </div>
                        
                        <div class="info-status-2" id="infoStatus2">
                            <!-- Akan diisi oleh JavaScript -->
                        </div>
                    </div>
                    
                    <div class="output-section-2">
                        <div class="section-title-2">üìä HASIL REAL-TIME</div>
                        <div class="result-box-2" id="resultOutput2"></div>
                        <div class="button-group-2" style="margin-top:10px;">
                            <button class="button-2 btn-clear-output-2" onclick="Program2.clearOutput()">üóëÔ∏è HAPUS OUTPUT</button>
                            <button class="button-2 btn-copy-2" onclick="Program2.copyOutput()">üìã SALIN</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SHARED COPY NOTIFICATION -->
    <div class="copy-notification" id="copyNotification">
        ‚úÖ Output berhasil disalin ke clipboard!
    </div>

    <script>
        // ========== TAB SYSTEM ==========
        document.querySelectorAll('.tab-btn').forEach(button => {
            button.addEventListener('click', () => {
                // Remove active class from all tabs
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Hide all tab contents
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // Activate clicked tab
                button.classList.add('active');
                const tabId = button.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');
                
                // Save active tab to localStorage
                localStorage.setItem('activeTab', tabId);
                
                // Optional: Pause Program 2 if running when switching tabs
                if (tabId === 'program1' && Program2 && Program2.isSearching) {
                    Program2.stopSearch();
                    showNotification('‚è∏Ô∏è Auto Prediksi di-pause karena pindah tab');
                }
            });
        });
        
        // Restore active tab on page load
        document.addEventListener('DOMContentLoaded', () => {
            const savedTab = localStorage.getItem('activeTab') || 'program1';
            const tabButton = document.querySelector(`.tab-btn[data-tab="${savedTab}"]`);
            if (tabButton) {
                tabButton.click();
            }
        });
        
        // ========== DARK MODE TOGGLE ==========
        const themeButton = document.getElementById('themeButton');
        const themeIcon = document.getElementById('themeIcon');
        const themeText = document.getElementById('themeText');
        
        function getPreferredTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) return savedTheme;
            
            // Check system preference
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                return 'dark';
            }
            
            return 'light';
        }
        
        function setTheme(theme) {
            if (theme === 'dark') {
                document.body.classList.add('dark-theme');
                themeIcon.textContent = '‚òÄÔ∏è';
                themeText.textContent = 'Mode Terang';
            } else {
                document.body.classList.remove('dark-theme');
                themeIcon.textContent = 'üåô';
                themeText.textContent = 'Mode Gelap';
            }
            localStorage.setItem('theme', theme);
        }
        
        function toggleTheme() {
            const isDark = document.body.classList.contains('dark-theme');
            setTheme(isDark ? 'light' : 'dark');
        }
        
        // Initialize theme
        document.addEventListener('DOMContentLoaded', () => {
            const preferredTheme = getPreferredTheme();
            setTheme(preferredTheme);
            
            themeButton.addEventListener('click', toggleTheme);
            
            // Watch for system theme changes
            if (window.matchMedia) {
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                    if (!localStorage.getItem('theme')) {
                        setTheme(e.matches ? 'dark' : 'light');
                    }
                });
            }
        });
        
        // ========== SHARED FUNCTIONS ==========
        function showNotification(message) {
            const notification = document.getElementById('copyNotification');
            notification.textContent = message;
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
// ========== PROGRAM 1: KEY KALKULATOR (FIXED & UPDATED) ==========
const Program1 = {
    // ========== TABEL MISTIK YANG BENAR (DARI KOREKSI ANDA) ==========
    mistikTables: {
        'IX': {'0':'5','1':'6','2':'7','3':'8','4':'9','5':'0','6':'1','7':'2','8':'3','9':'4'},
        'TY': {'0':'7','1':'4','2':'9','3':'6','4':'1','5':'8','6':'3','7':'0','8':'5','9':'2'},
        'ML': {'0':'1','1':'0','2':'5','3':'8','4':'7','5':'2','6':'9','7':'4','8':'3','9':'6'},
        'MB': {'0':'8','1':'7','2':'6','3':'9','4':'5','5':'4','6':'2','7':'1','8':'0','9':'3'},
        'M0': {'0':'6','1':'5','2':'8','3':'7','4':'9','5':'1','6':'1','7':'3','8':'2','9':'4'},
        'M1': {'0':'1','1':'0','2':'9','3':'8','4':'7','5':'6','6':'5','7':'4','8':'3','9':'2'},
        'M2': {'0':'2','1':'8','2':'0','3':'9','4':'7','5':'6','6':'5','7':'4','8':'1','9':'3'},
        'M3': {'0':'3','1':'2','2':'1','3':'0','4':'9','5':'8','6':'7','7':'6','8':'5','9':'4'},
        'M4': {'0':'6','1':'5','2':'3','3':'2','4':'7','5':'1','6':'0','7':'4','8':'9','9':'8'},
        'M5': {'0':'5','1':'4','2':'3','3':'2','4':'1','5':'0','6':'9','7':'8','8':'7','9':'6'},
        'M6': {'0':'6','1':'8','2':'4','3':'5','4':'2','5':'3','6':'1','7':'9','8':'1','9':'7'},
        'M7': {'0':'7','1':'6','2':'5','3':'4','4':'3','5':'2','6':'1','7':'0','8':'9','9':'8'},
        'M8': {'0':'8','1':'7','2':'6','3':'5','4':'9','5':'3','6':'2','7':'1','8':'0','9':'4'},
        'M9': {'0':'9','1':'8','2':'7','3':'6','4':'5','5':'4','6':'3','7':'2','8':'1','9':'0'},
        'M10': {'0':'4','1':'2','2':'1','3':'8','4':'0','5':'6','6':'5','7':'9','8':'3','9':'7'}
    },

    dataHistory: [],
    currentFormulas: [],
    formulaPatterns: [],
    originalInputData: [],
    aiHistory: [],
    processComponentDepth: 0,
    maxComponentDepth: 10,

    // ========== FUNGSI UTAMA YANG DIPERBAIKI ==========
    calculateFormula: function() {
        const inputData = document.getElementById('inputData1').value.trim();
        
        if (!inputData) {
            this.showMessage('Masukkan data terlebih dahulu!', 'error');
            return;
        }
        
        try {
            // Reset depth counter
            this.processComponentDepth = 0;
            
            const parsedData = this.parseInputData(inputData);
            
            if (this.currentFormulas.length === 0) {
                this.showMessage('Tidak ada rumus yang terdeteksi!', 'error');
                return;
            }
            
            // Validasi semua rumus
            const invalidFormulas = [];
            for (let formula of this.currentFormulas) {
                try {
                    this.validateFormula(formula);
                } catch (error) {
                    invalidFormulas.push(`${formula}: ${error.message}`);
                }
            }
            
            if (invalidFormulas.length > 0) {
                throw new Error(`Rumus tidak valid:\n${invalidFormulas.join('\n')}`);
            }
            
            // Hitung dan tampilkan
            this.displayAllFormulaResults();
            this.showMessage(`‚úÖ Perhitungan berhasil! ${this.currentFormulas.length} rumus diproses.`, 'success');
            
        } catch (error) {
            this.showMessage(`‚ùå Error: ${error.message}`, 'error');
            console.error('Calculation error:', error);
            
            document.getElementById('resultOutput1').innerHTML = 
                `// ERROR: ${error.message}\n` +
                `// Pastikan rumus valid dan data cukup\n` +
                `// Contoh: C2ix+K1.(m0)`;
        }
    },

    // ========== PARSING YANG DIPERBAIKI ==========
    parseInputData: function(inputData) {
        this.dataHistory = [];
        this.currentFormulas = [];
        this.formulaPatterns = [];
        this.originalInputData = [];
        this.aiHistory = [];
        
        const lines = inputData.split('\n');
        let separatorIndex = -1;
        let separatorType = 'none';
        
        // Deteksi separator
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            
            if (line === '======' || line.startsWith('======')) {
                separatorIndex = i;
                separatorType = 'equals';
                break;
            }
            
            if (line === '' && i > 0) {
                const prevLine = lines[i-1].trim();
                if (prevLine === '') {
                    separatorIndex = i - 1;
                    separatorType = 'double-empty';
                    break;
                }
                
                const nextLine = i < lines.length - 1 ? lines[i+1].trim() : '';
                if (nextLine !== '' && !nextLine.match(/^\d{4}\s*=/) && 
                    (nextLine.match(/[A-Za-z]/) || nextLine.includes('(') || nextLine.includes(')'))) {
                    separatorIndex = i;
                    separatorType = 'single-empty';
                    break;
                }
            }
        }
        
        // Parse data angka (sebelum separator)
        const dataLines = separatorIndex >= 0 ? lines.slice(0, separatorIndex) : lines;
        
        for (let line of dataLines) {
            line = line.trim();
            if (line === '') continue;
            
            const numberMatch = line.match(/(\d{4})/);
            if (numberMatch) {
                const number = numberMatch[1];
                
                // Parse angka menjadi komponen
                this.dataHistory.push({
                    number: number,
                    as: parseInt(number[0]),
                    cop: parseInt(number[1]),
                    kepala: parseInt(number[2]),
                    ekor: parseInt(number[3]),
                    jumlah: this.reduceToSingleDigit(parseInt(number[2]) + parseInt(number[3]))
                });
                
                // Simpan data original dengan AI
                const originalMatch = line.match(/(\d{4})\s*=\s*(\d+)\s*(\w*)/);
                if (originalMatch) {
                    this.originalInputData.push({
                        number: originalMatch[1],
                        ai: originalMatch[2] || '',
                        suffix: originalMatch[3] || 'ai'
                    });
                } else {
                    this.originalInputData.push({
                        number: number,
                        ai: '',
                        suffix: 'ai'
                    });
                }
            }
        }
        
        // Parse rumus dan pola (setelah separator)
        const tempFormulas = [];
        const tempPatterns = [];
        
        if (separatorIndex >= 0 && separatorIndex < lines.length - 1) {
            const formulaStartIndex = separatorIndex + (separatorType === 'double-empty' ? 2 : 1);
            const formulaLines = lines.slice(formulaStartIndex);
            
            for (let line of formulaLines) {
                line = line.trim();
                if (line === '' || line.includes('//')) continue;
                
                // Cek jika baris adalah pola N
                if (line.match(/^N\d+(?:N\d+)*$/)) {
                    if (tempFormulas.length > 0) {
                        const lastIndex = tempFormulas.length - 1;
                        if (!tempPatterns[lastIndex]) {
                            tempPatterns[lastIndex] = line;
                        }
                    }
                    continue;
                }
                
                // Cek jika baris adalah rumus
                if (this.looksLikeFormula(line)) {
                    let formulaOnly = line;
                    let pattern = null;
                    
                    // Pisahkan rumus dan pola jika ada di baris yang sama
                    const spaceIndex = line.indexOf(' ');
                    if (spaceIndex !== -1) {
                        formulaOnly = line.substring(0, spaceIndex).trim();
                        const afterSpace = line.substring(spaceIndex + 1).trim();
                        
                        if (afterSpace.match(/^N\d+(?:N\d+)*$/)) {
                            pattern = afterSpace;
                        } else {
                            // Jika bukan pola N, mungkin ada spasi sebelum .(
                            formulaOnly = line.replace(/\s+\.\(/, '.(');
                        }
                    }
                    
                    formulaOnly = formulaOnly.replace(/\s+\.\(/, '.(');
                    
                    if (this.looksLikeFormula(formulaOnly)) {
                        tempFormulas.push(formulaOnly);
                        tempPatterns.push(pattern);
                    }
                }
            }
        }
        
        this.currentFormulas = tempFormulas;
        this.formulaPatterns = tempPatterns;
        
        this.updateFormulaDisplay();
        
        // Update info history
        if (this.currentFormulas.length > 0) {
            const maxDaysNeeded = this.currentFormulas.map(formula => this.findMaxDayInFormula(formula));
            const maxDay = Math.max(...maxDaysNeeded);
            document.getElementById('historyInfo1').textContent = 
                `Butuh ${maxDay} hari sebelumnya. ${this.currentFormulas.length} rumus terdeteksi.`;
        } else {
            document.getElementById('historyInfo1').textContent = 
                'Masukkan rumus setelah "======"';
        }
        
        return {
            data: this.dataHistory,
            formulas: this.currentFormulas
        };
    },

    looksLikeFormula: function(line) {
        if (!line.match(/[A-Za-z]/)) return false;
        if (line.includes('//')) return false;
        if (line.match(/^\d{4}/)) return false;
        
        const components = ['A','C','K','E','J','Js','J3D','J4D'];
        return components.some(comp => line.includes(comp));
    },

    // ========== VALIDASI FORMULA YANG DIPERBAIKI ==========
    validateFormula: function(formula) {
        if (!formula.match(/[A-Za-z]/)) {
            throw new Error(`Rumus tidak valid: ${formula}`);
        }
        
        // PERBAIKAN: Validasi offset 0 yang lebih spesifik
        // Hanya cari offset 0 dalam komponen, bukan di mistik
        const baseFormula = formula.replace(/\.\([^)]+\)$/, ''); // Hapus mistik final
        const components = baseFormula.split(/([+\-])/).filter(c => c.trim());
        
        for (let comp of components) {
            if (comp !== '+' && comp !== '-') {
                // PERBAIKAN: Regex yang lebih spesifik untuk offset 0
                const offsetMatch = comp.match(/^(A|C|K|E|J|Js|J3D|J4D)(0)(?![a-zA-Z])/);
                if (offsetMatch) {
                    throw new Error(`Offset 0 tidak diperbolehkan: ${comp} dalam ${formula}`);
                }
            }
        }
        
        // Cek tabel mistik final
        const finalMistikMatch = formula.match(/\.\((\w+)\)/);
        if (finalMistikMatch && !this.mistikTables[finalMistikMatch[1].toUpperCase()]) {
            throw new Error(`Tabel mistik final tidak dikenal: ${finalMistikMatch[1]}`);
        }
        
        // Cek komponen sama dengan operator minus
        if (components.length === 3) {
            const [comp1, operator, comp2] = components;
            const cleanComp1 = comp1.replace(/\d+[a-zA-Z]*$/, '');
            const cleanComp2 = comp2.replace(/\d+[a-zA-Z]*$/, '');
            
            if (cleanComp1 === cleanComp2 && operator === '-') {
                throw new Error(`Pengurangan komponen sama tidak valid: ${comp1}-${comp2}`);
            }
        }
        
        return true;
    },

    updateFormulaDisplay: function() {
        const formulaDisplay = document.getElementById('detectedFormula1');
        
        if (this.currentFormulas.length === 0) {
            formulaDisplay.textContent = 'Tidak ada rumus';
        } else {
            formulaDisplay.innerHTML = this.currentFormulas.map((formula, index) => 
                `<div style="margin-bottom: 5px; padding: 3px 0;">
                    <span style="color: #FFD700; font-weight: bold;">R${index + 1}:</span> ${formula}
                    ${this.formulaPatterns[index] ? `<br><small style="color: #4ECDC4;">Pola: ${this.formulaPatterns[index]}</small>` : ''}
                </div>`
            ).join('');
        }
        
        // Update input info
        document.getElementById('inputInfo1').textContent = 
            `${this.dataHistory.length} angka + ${this.currentFormulas.length} rumus`;
    },

    // ========== PERHITUNGAN AI YANG DIPERBAIKI ==========
    displayAllFormulaResults: function() {
        const output = document.getElementById('resultOutput1');
        let outputHTML = '';
        let hasError = false;
        
        for (let i = 0; i < this.currentFormulas.length; i++) {
            try {
                const formula = this.currentFormulas[i];
                const results = this.calculateAIForSingleFormula(formula);
                
                // Gunakan AI dari input sebagai highlight untuk rumus pertama
                let highlightData = [];
                if (i === 0) {
                    highlightData = this.originalInputData.map(item => item.ai);
                }
                
                const customPattern = this.formulaPatterns[i];
                const formulaOutput = this.generateRotatedOutput(results, formula, highlightData, customPattern);
                outputHTML += formulaOutput;
                
                if (i < this.currentFormulas.length - 1) {
                    outputHTML += '\n\n';
                }
            } catch (error) {
                outputHTML += `// ERROR pada rumus ${i+1}: ${this.currentFormulas[i]}\n`;
                outputHTML += `// ${error.message}\n`;
                outputHTML += '======\n';
                outputHTML += this.currentFormulas[i] + '\n\n';
                hasError = true;
            }
        }
        
        output.innerHTML = outputHTML;
        
        if (hasError) {
            this.showMessage('Ada error dalam perhitungan, lihat output untuk detail', 'warning');
        }
    },

    calculateAIForSingleFormula: function(formula) {
        const results = [];
        const maxDayNeeded = this.findMaxDayInFormula(formula);
        
        this.aiHistory = [];
        
        for (let i = 0; i < this.dataHistory.length; i++) {
            // Hanya hitung jika ada cukup data sebelumnya
            if (i >= maxDayNeeded - 1) { // PERBAIKAN: -1 karena offset 1 = data terbaru
                try {
                    const aiResult = this.calculateSingleAI(formula, i);
                    results.push({
                        number: this.dataHistory[i].number,
                        ai: aiResult,
                        canCalculate: true
                    });
                    this.aiHistory[i] = aiResult;
                } catch (error) {
                    results.push({
                        number: this.dataHistory[i].number,
                        ai: '',
                        canCalculate: false,
                        error: error.message
                    });
                    this.aiHistory[i] = null;
                }
            } else {
                results.push({
                    number: this.dataHistory[i].number,
                    ai: '',
                    canCalculate: false
                });
                this.aiHistory[i] = null;
            }
        }
        
        return results;
    },

    // ========== PERBAIKAN PENTING: OFFSET YANG BENAR ==========
    calculateSingleAI: function(formula, currentDayIndex) {
        console.log(`\n=== Hitung ${formula} untuk ${this.dataHistory[currentDayIndex].number} ===`);
        
        let workingFormula = formula;
        let finalConversion = null;
        
        // Ekstrak mistik final
        const finalMatch = workingFormula.match(/\.\((\w+)\)/);
        if (finalMatch) {
            finalConversion = finalMatch[1].toUpperCase();
            workingFormula = workingFormula.replace(/\.\((\w+)\)/, '');
            console.log(`Mistik final: ${finalConversion}`);
        }
        
        // Split komponen
        const components = workingFormula.split(/([+\-])/).filter(c => c.trim());
        let total = 0;
        let currentOperator = '+';
        
        console.log(`Komponen:`, components);
        
        for (let i = 0; i < components.length; i++) {
            const component = components[i].trim();
            
            if (component === '+' || component === '-') {
                currentOperator = component;
                continue;
            }
            
            if (component) {
                const value = this.processComponent(component, currentDayIndex);
                console.log(`${currentOperator} ${component} = ${value}`);
                
                if (currentOperator === '+') {
                    total += value;
                } else if (currentOperator === '-') {
                    total -= value;
                }
            }
        }
        
        console.log(`Total awal: ${total}`);
        
        if (total < 0) {
            total = Math.abs(total);
            console.log(`Total abs: ${total}`);
        }
        
        // Aplikasi mistik final jika ada
        if (finalConversion) {
            const before = total;
            total = parseInt(this.convertMistik(total.toString(), finalConversion));
            console.log(`Mistik ${finalConversion}: ${before} ‚Üí ${total}`);
        }
        
        const finalResult = this.reduceToSingleDigit(total);
        console.log(`Hasil akhir: ${finalResult}`);
        
        return finalResult;
    },

    // ========== PERBAIKAN PENTING: LOGIKA OFFSET YANG BENAR ==========
    processComponent: function(component, currentDayIndex) {
        // Recursion depth check
        if (this.processComponentDepth > this.maxComponentDepth) {
            throw new Error(`Max recursion depth exceeded: ${component}`);
        }
        
        this.processComponentDepth++;
        
        try {
            // PERBAIKAN: Regex yang menerima mistik dengan angka lebih dari 1 digit
            // Contoh: C10m10, A1ix, K5m9
            const match = component.match(/^(A|C|K|E|J|Js|J3D|J4D)(\d+)([a-zA-Z]+\d*)?$/);
            if (!match) {
                throw new Error(`Format komponen tidak valid: ${component}`);
            }
            
            const type = match[1];
            const dayOffset = parseInt(match[2]);  // offset hari (1 = data terbaru)
            const mistik = match[3] || '';        // mistik seperti m10, ix, m0, m9, dll
            
            if (dayOffset === 0) {
                throw new Error(`Offset 0 tidak diperbolehkan: ${component}`);
            }
            
            // PERBAIKAN: offset n = data ke-n dari TERBARU (1-based)
            // currentDayIndex adalah index data saat ini (0-based)
            // offset 1 = data terbaru (currentDayIndex)
            // offset 2 = data kemarin (currentDayIndex - 1)
            // offset 3 = data 2 hari lalu (currentDayIndex - 2)
            const targetDayIndex = currentDayIndex - (dayOffset - 1);
            
            if (targetDayIndex < 0) {
                throw new Error(`Data tidak tersedia untuk ${component} (butuh ${dayOffset} hari dari terbaru)`);
            }
            
            const data = this.dataHistory[targetDayIndex];
            console.log(`${component}: offset ${dayOffset} = ${data.number} (index ${targetDayIndex})`);
            
            let value;
            
            switch(type) {
                case 'A': 
                    value = data.as; 
                    console.log(`AS dari ${data.number}: ${value}`);
                    break;
                case 'C': 
                    value = data.cop; 
                    console.log(`COP dari ${data.number}: ${value}`);
                    break;
                case 'K': 
                    value = data.kepala; 
                    console.log(`KEPALA dari ${data.number}: ${value}`);
                    break;
                case 'E': 
                    value = data.ekor; 
                    console.log(`EKOR dari ${data.number}: ${value}`);
                    break;
                case 'J': 
                    value = data.jumlah; 
                    console.log(`JUMLAH dari ${data.number}: ${value}`);
                    break;
                case 'Js': 
                    value = Math.abs(data.kepala - data.ekor);
                    value = this.reduceToSingleDigit(value);
                    console.log(`Js (|K-E|) dari ${data.number}: ${value}`);
                    break;
                case 'J3D':
                    value = data.cop + data.kepala + data.ekor;
                    value = this.reduceToSingleDigit(value);
                    console.log(`J3D (C+K+E) dari ${data.number}: ${value}`);
                    break;
                case 'J4D':
                    value = data.as + data.cop + data.kepala + data.ekor;
                    value = this.reduceToSingleDigit(value);
                    console.log(`J4D (A+C+K+E) dari ${data.number}: ${value}`);
                    break;
                default: 
                    throw new Error(`Tipe komponen tidak dikenali: ${type}`);
            }
            
            // Aplikasi mistik komponen jika ada
            if (mistik) {
                const before = value;
                value = parseInt(this.convertMistik(value.toString(), mistik.toUpperCase()));
                console.log(`Mistik ${mistik}: ${before} ‚Üí ${value}`);
            }
            
            return value;
        } finally {
            this.processComponentDepth--;
        }
    },

    convertMistik: function(number, table) {
        const tableUpper = table.toUpperCase();
        
        if (!this.mistikTables[tableUpper]) {
            console.warn(`Tabel mistik tidak ditemukan: ${table}, menggunakan angka asli`);
            return this.reduceToSingleDigit(parseInt(number)).toString();
        }
        
        const digit = this.reduceToSingleDigit(parseInt(number)).toString();
        
        if (this.mistikTables[tableUpper][digit] === undefined) {
            console.warn(`Angka ${digit} tidak ada di tabel ${table}, menggunakan angka asli`);
            return digit;
        }
        
        return this.mistikTables[tableUpper][digit];
    },

    reduceToSingleDigit: function(num) {
        let result = Math.abs(num);
        let safetyCounter = 0;
        const MAX_ITERATIONS = 100;
        
        while (result > 9 && safetyCounter < MAX_ITERATIONS) {
            result = result.toString().split('').reduce((sum, digit) => sum + parseInt(digit), 0);
            safetyCounter++;
        }
        
        if (safetyCounter >= MAX_ITERATIONS) {
            console.warn(`reduceToSingleDigit mungkin infinite loop: ${num}`);
            return 0;
        }
        
        return result;
    },

    findMaxDayInFormula: function(formula) {
        let maxDay = 0;
        let workingFormula = formula.replace(/\.\((\w+)\)/, '');
        
        // PERBAIKAN: Regex yang hanya menangkap offset, bukan mistik
        const componentRegex = /(A|C|K|E|J|Js|J3D|J4D)(\d+)(?![a-zA-Z])/g;
        let match;
        
        while ((match = componentRegex.exec(workingFormula)) !== null) {
            const day = parseInt(match[2]);
            if (day > maxDay) {
                maxDay = day;
            }
        }
        
        return maxDay;
    },

    // ========== GENERATE OUTPUT ==========
    generateRotatedOutput: function(results, formula, highlightData, customPattern) {
        let output = '';
        let inheritedPositions = null;
        
        // Parse custom pattern jika ada
        let customHighlightPositions = null;
        if (customPattern) {
            customHighlightPositions = [];
            const steps = customPattern.match(/N(\d)/g);
            if (steps) {
                for (let step of steps) {
                    const pos = parseInt(step.substring(1));
                    if (pos >= 0 && pos <= 9 && !customHighlightPositions.includes(pos)) {
                        customHighlightPositions.push(pos);
                    }
                }
                customHighlightPositions.sort((a, b) => a - b);
            }
        }
        
        for (let i = 0; i < results.length; i++) {
            const result = results[i];
            
            if (result.canCalculate) {
                const highlightAI = highlightData[i] || '';
                
                const rotatedResult = this.formatAIWithColorAndInheritance(
                    result.ai, 
                    highlightAI, 
                    customPattern ? customHighlightPositions : inheritedPositions,
                    customPattern ? true : false
                );
                
                output += `${result.number} = ${rotatedResult.rotatedDigits} ai\n`;
                
                inheritedPositions = rotatedResult.highlightPositions;
            } else {
                output += `${result.number} = \n`;
                inheritedPositions = null;
            }
        }
        
        output += '======\n';
        
        // Generate pola dari highlight jika tidak ada custom pattern
        if (!customPattern && inheritedPositions) {
            customPattern = this.convertPositionsToPattern(inheritedPositions);
        }
        
        output += customPattern ? `${formula} ${customPattern}` : formula;
        
        return output;
    },

    formatAIWithColorAndInheritance: function(calculatedAI, highlightAI, highlightPositions, useCustomPattern = false) {
        let rotatedDigits = '';
        const allDigits = '0123456789';
        const startIndex = allDigits.indexOf(calculatedAI.toString());
        
        for (let i = 0; i < allDigits.length; i++) {
            const actualIndex = (startIndex + i) % allDigits.length;
            rotatedDigits += allDigits[actualIndex];
        }
        
        // Hitung positions dari highlight jika tidak pakai custom pattern
        if (!useCustomPattern && highlightAI && highlightAI.trim() !== '' && !highlightPositions) {
            highlightPositions = [];
            const highlightDigits = highlightAI.toString().split('');
            
            for (let digit of highlightDigits) {
                if (digit >= '0' && digit <= '9') {
                    const position = rotatedDigits.indexOf(digit);
                    if (position !== -1 && !highlightPositions.includes(position)) {
                        highlightPositions.push(position);
                    }
                }
            }
            
            if (highlightPositions.length > 0) {
                highlightPositions.sort((a, b) => a - b);
            } else {
                highlightPositions = null;
            }
        }
        
        let result = '';
        let colorIndex = 0;
        const highlightColors = [
            '#FF6B6B',
            '#4ECDC4',
            '#45B7D1',
            '#96CEB4'
        ];
        
        for (let i = 0; i < rotatedDigits.length; i++) {
            const digit = rotatedDigits[i];
            
            if (highlightPositions && highlightPositions.includes(i)) {
                const color = highlightColors[colorIndex % highlightColors.length];
                result += `<span style="color: ${color}; font-weight: bold;">${digit}</span>`;
                colorIndex++;
            } else {
                result += digit;
            }
        }
        
        return {
            rotatedDigits: result,
            highlightPositions: highlightPositions
        };
    },

    convertPositionsToPattern: function(positions) {
        if (!positions || positions.length === 0) return 'N0N1';
        
        let pattern = 'N' + positions[0];
        for (let i = 1; i < positions.length; i++) {
            const jump = positions[i] - positions[i-1];
            pattern += 'N' + jump;
        }
        
        return pattern;
    },

    // ========== FUNGSI BANTUAN ==========
    copyOutput: function() {
        const outputElement = document.getElementById('resultOutput1');
        let copyText = '';
        
        const lines = outputElement.innerHTML.split('\n');
        let dataLines = [];
        let currentFormula = '';
        let currentPattern = 'N0N1';
        let waitingForFormula = false;
        
        for (let line of lines) {
            line = line.trim();
            
            const numberMatch = line.match(/(\d{4})\s*=/);
            if (numberMatch) {
                const number = numberMatch[1];
                
                const regex = /<span[^>]*>(\d)<\/span>/g;
                let match;
                let highlightedDigits = '';
                
                while ((match = regex.exec(line)) !== null) {
                    highlightedDigits += match[1];
                }
                
                if (highlightedDigits) {
                    const suffix = this.determineMajoritySuffix();
                    dataLines.push(`${number} = ${highlightedDigits} ${suffix}`);
                } else {
                    dataLines.push(`${number} = `);
                }
            }
            
            if (line === '======') {
                waitingForFormula = true;
                continue;
            }
            
            if (waitingForFormula && line && !line.includes('//') && !line.includes('<')) {
                const formulaMatch = line.match(/^([A-Za-z0-9+\-\.\(\)]+)(?:\s+(N\d+(?:N\d+)*))?$/);
                if (formulaMatch) {
                    currentFormula = formulaMatch[1];
                    currentPattern = formulaMatch[2] || 'N0N1';
                } else {
                    currentFormula = line;
                }
                waitingForFormula = false;
            }
        }
        
        copyText = dataLines.join('\n');
        if (currentFormula) {
            copyText += '\n======\n';
            copyText += `${currentFormula} ${currentPattern}`;
        }
        
        if (!copyText || copyText.includes('Hasil perhitungan akan muncul di sini')) {
            this.showMessage('Tidak ada output yang bisa disalin!', 'error');
            return;
        }
        
        navigator.clipboard.writeText(copyText).then(() => {
            showNotification('‚úÖ Output berhasil disalin!');
        }).catch(err => {
            const textArea = document.createElement('textarea');
            textArea.value = copyText;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            showNotification('‚úÖ Output berhasil disalin!');
        });
    },

    determineMajoritySuffix: function() {
        const suffixCount = {};
        
        for (const item of this.originalInputData) {
            if (item.suffix && item.suffix !== 'ai') {
                suffixCount[item.suffix] = (suffixCount[item.suffix] || 0) + 1;
            }
        }
        
        let majoritySuffix = 'ai';
        let maxCount = 0;
        
        for (const [suffix, count] of Object.entries(suffixCount)) {
            if (count > maxCount) {
                maxCount = count;
                majoritySuffix = suffix;
            }
        }
        
        return majoritySuffix;
    },

    clearAll: function() {
        document.getElementById('inputData1').value = '';
        document.getElementById('resultOutput1').innerHTML = 
            `// Hasil perhitungan akan muncul di sini\n` +
            `// Format input:\n` +
            `// 8603 = 30 ai\n` +
            `// 2436 = 74 ai\n` +
            `// ...\n` +
            `// ======\n` +
            `// C2ix+K1.(m0)\n` +
            `// atau\n` +
            `// C2ix+K1.(m0) N0N1`;
        
        this.showMessage('Data dihapus', 'info');
        
        this.dataHistory = [];
        this.currentFormulas = [];
        this.formulaPatterns = [];
        this.originalInputData = [];
        this.aiHistory = [];
        this.processComponentDepth = 0;
        
        this.updateFormulaDisplay();
        document.getElementById('inputInfo1').textContent = '0 angka + 0 rumus terdeteksi';
        document.getElementById('historyInfo1').textContent = 'Masukkan rumus setelah "======"';
    },

    showMessage: function(message, type) {
        // Buat notifikasi
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 10000;
            animation: slideIn 0.3s ease;
        `;
        
        if (type === 'error') {
            notification.style.background = '#f44336';
        } else if (type === 'success') {
            notification.style.background = '#4CAF50';
        } else if (type === 'warning') {
            notification.style.background = '#FF9800';
        } else {
            notification.style.background = '#2196F3';
        }
        
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 3000);
    },

    updateInputInfo: function() {
        const input = document.getElementById('inputData1').value.trim();
        const parsed = this.parseInputData(input);
        document.getElementById('inputInfo1').textContent = 
            `${this.dataHistory.length} angka + ${this.currentFormulas.length} rumus`;
    },

    init: function() {
        document.getElementById('inputData1').addEventListener('input', () => {
            this.updateInputInfo();
        });
        
        document.getElementById('inputData1').addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') {
                this.calculateFormula();
            }
        });
        
        // Load saved data
        const savedData = localStorage.getItem('program1_data');
        if (savedData) {
            try {
                const data = JSON.parse(savedData);
                document.getElementById('inputData1').value = data.inputData || '';
                this.updateInputInfo();
            } catch (e) {
                console.error('Error loading data:', e);
            }
        }
        
        // Auto-save
        setInterval(() => {
            const inputData = document.getElementById('inputData1').value;
            if (inputData.trim()) {
                localStorage.setItem('program1_data', JSON.stringify({
                    inputData: inputData,
                    timestamp: Date.now()
                }));
            }
        }, 10000);
        
        this.updateInputInfo();
    }
};

        // ========== PROGRAM 2: AUTO PREDIKSI MOD+ (FULLY FIXED AUTO-CONTINUE) ==========
        const Program2 = {
            // Tabel mistik
            mistikTables: {
                'IX': {'0':'5','1':'6','2':'7','3':'8','4':'9','5':'0','6':'1','7':'2','8':'3','9':'4'},
                'ML': {'0':'1','1':'0','2':'5','3':'8','4':'7','5':'2','6':'9','7':'4','8':'3','9':'6'},
                'MB': {'0':'8','1':'7','2':'6','3':'9','4':'5','5':'4','6':'2','7':'1','8':'0','9':'3'},
                'TY': {'0':'7','1':'4','2':'9','3':'6','4':'1','5':'8','6':'3','7':'0','8':'5','9':'2'},
                'M9': {'0':'9','1':'8','2':'7','3':'6','4':'5','5':'4','6':'3','7':'2','8':'1','9':'0'}
            },

            // KONSTANTA
            COMBINATIONS_PER_SESSION: 30000000,
            BATCH_SIZE: 500000,

            // VARIABEL GLOBAL
            dataHistory: [],
            aiFormulas: [],
            allPatterns: [],
            foundResults: [],
            uniqueAIFormulas: new Set(),
            isSearching: false,
            stopRequested: false,
            startTime: null,
            currentPatahLimit: 0,
            totalCombinations: 0,
            currentSession: 0,
            totalSessions: 0,
            processedInSession: 0,
            totalProcessed: 0,
            currentFormulaIndex: 0,
            currentPatternIndex: 0,
            testPriorityOrder: ['A', 'C', 'K', 'E', 'J', 'AC', 'CK', 'KE', 'CB'],

// =============================================
// FUNGSI UTAMA
// =============================================
            updateDataCount: function() {
                const input = document.getElementById('numbers2').value.trim();
                const lines = input.split('\n').map(l => l.trim()).filter(l => /^\d{4}$/.test(l));
                const count = lines.length;
                
                document.getElementById('dataCount2').textContent = count;
                this.updateStatusInfo();
                return count;
            },

            validateNumberInput: function(input, min, max) {
                let value = input.value.replace(/[^\d]/g, '');
                
                if (value === '') {
                    input.value = '';
                    return false;
                }
                
                let numValue = parseInt(value);
                if (numValue < min) numValue = min;
                if (numValue > max) numValue = max;
                
                input.value = numValue;
                this.updateStatusInfo();
                return true;
            },

            validateTextareaInput: function(textarea) {
                const original = textarea.value;
                let cleaned = '';
                
                const lines = original.split('\n');
                for (let line of lines) {
                    let cleanLine = line.replace(/[^\d]/g, '');
                    if (cleanLine.length > 4) cleanLine = cleanLine.substring(0, 4);
                    if (cleanLine.length === 4) {
                        cleaned += cleanLine + '\n';
                    }
                }
                
                cleaned = cleaned.trim();
                if (cleaned !== original) {
                    textarea.value = cleaned;
                }
                
                this.updateDataCount();
            },

            reduceToSingleDigit: function(num) {
                let n = Math.abs(num);
                while (n > 9) n = n.toString().split('').reduce((sum, d) => sum + parseInt(d), 0);
                return n;
            },

            convertMistik: function(number, table) {
                const digit = this.reduceToSingleDigit(parseInt(number)).toString();
                return this.mistikTables[table]?.[digit] || digit;
            },

// =============================================
// FUNGSI PERHITUNGAN
// =============================================
            processComponent: function(component, currentDayIndex, data) {
                const match = component.match(/^(A|C|K|E|J|Js|J3D|J4D)(\d{1,2})(\w*)$/);
                if (!match) throw new Error(`Komponen tidak valid: ${component}`);
                
                const [_, type, dayStr, mistik] = match;
                const dayOffset = parseInt(dayStr);
                const targetDayIndex = currentDayIndex - (dayOffset - 1);
                
                if (targetDayIndex < 0) throw new Error(`Data tidak cukup untuk ${component}`);
                
                const d = data[targetDayIndex];
                let val;
                
                switch(type) {
                    case 'A': val = parseInt(d[0]); break;
                    case 'C': val = parseInt(d[1]); break;
                    case 'K': val = parseInt(d[2]); break;
                    case 'E': val = parseInt(d[3]); break;
                    case 'J':  
                        val = parseInt(d[2]) + parseInt(d[3]);
                        val = this.reduceToSingleDigit(val);
                        break;
                    case 'Js': 
                        val = Math.abs(parseInt(d[2]) - parseInt(d[3]));
                        val = this.reduceToSingleDigit(val);
                        break;
                    case 'J3D':
                        val = parseInt(d[1]) + parseInt(d[2]) + parseInt(d[3]);
                        val = this.reduceToSingleDigit(val);
                        break;
                    case 'J4D':
                        val = parseInt(d[0]) + parseInt(d[1]) + parseInt(d[2]) + parseInt(d[3]);
                        val = this.reduceToSingleDigit(val);
                        break;
                    default: throw new Error(`Komponen tidak dikenal: ${type}`);
                }
                
                if (mistik) {
                    const m = mistik.toUpperCase();
                    if (['IX','ML','MB','TY','M9'].includes(m)) {
                        val = parseInt(this.convertMistik(val, m));
                    }
                }
                
                return val;
            },

            calculateAI: function(formula, idx, data) {
                let workingFormula = formula;
                let finalMistik = null;
                
                const finalMatch = workingFormula.match(/\.\((\w+)\)$/);
                if (finalMatch) {
                    finalMistik = finalMatch[1].toUpperCase();
                    workingFormula = workingFormula.replace(/\.\((\w+)\)$/, '');
                }
                
                const parts = workingFormula.split(/([+\-])/).filter(p => p.trim());
                let total = 0;
                let currentOp = '+';
                
                for (let part of parts) {
                    if (part === '+' || part === '-') {
                        currentOp = part;
                        continue;
                    }
                    
                    const val = this.processComponent(part.trim(), idx, data);
                    
                    if (currentOp === '+') {
                        total += val;
                    } else {
                        total -= val;
                    }
                }
                
                if (finalMistik && ['IX','ML','MB','TY','M9'].includes(finalMistik)) {
                    total = parseInt(this.convertMistik(total, finalMistik));
                }
                
                return this.reduceToSingleDigit(total);
            },

            generateRotation: function(ai) {
                const rotation = [];
                for (let i = 0; i < 10; i++) {
                    rotation.push((ai + i) % 10);
                }
                return rotation;
            },

            applyPatternToRotation: function(rotation, pattern) {
                const steps = pattern.match(/N(\d)/g);
                if (!steps || steps.length === 0) return '';
                
                const startPos = parseInt(steps[0].substring(1));
                let currentPosition = startPos;
                let result = rotation[currentPosition].toString();
                
                for (let i = 1; i < steps.length; i++) {
                    const jump = parseInt(steps[i].substring(1));
                    currentPosition = (currentPosition + jump) % 10;
                    result += rotation[currentPosition].toString();
                }
                
                return result;
            },

            getTargetDigits: function(nextData, targetType) {
                switch(targetType) {
                    case 'A': return nextData[0];
                    case 'C': return nextData[1];
                    case 'K': return nextData[2];
                    case 'E': return nextData[3];
                    case 'J': 
                        const k = parseInt(nextData[2]);
                        const e = parseInt(nextData[3]);
                        const sum = k + e;
                        return this.reduceToSingleDigit(sum).toString();
                    case 'AC': return nextData[0] + nextData[1];
                    case 'CK': return nextData[1] + nextData[2];
                    case 'KE': return nextData[2] + nextData[3];
                    case 'CB': return nextData;
                    default: return nextData;
                }
            },

            checkPrediction: function(predictionDigits, targetDigits, targetType) {
                if (['A', 'C', 'K', 'E', 'J'].includes(targetType)) {
                    for (let digit of predictionDigits) {
                        if (digit === targetDigits) {
                            return { hit: true, matchedDigit: digit };
                        }
                    }
                    return { hit: false, matchedDigit: '' };
                }
                
                else if (['AC', 'CK', 'KE', 'CB'].includes(targetType)) {
                    for (let digit of targetDigits) {
                        if (predictionDigits.includes(digit)) {
                            return { hit: true, matchedDigit: digit };
                        }
                    }
                    return { hit: false, matchedDigit: '' };
                }
                
                return { hit: false, matchedDigit: '' };
            },

// =============================================
// FUNGSI TESTING (PATAH LIMIT)
// =============================================
            testSingleTargetType: function(aiFormula, pattern, data, daysToTest, patahLimit, targetType) {
                if (data.length < daysToTest + 1) return null;
                
                let hits = 0;
                let attempts = 0;
                let patah = 0;
                const predictions = [];
                
                const startTestIndex = data.length - daysToTest;
                
                for (let i = 0; i < daysToTest; i++) {
                    const inputIndex = startTestIndex + i - 1;
                    const targetIndex = startTestIndex + i;
                    
                    if (inputIndex < 0 || targetIndex >= data.length) break;
                    
                    try {
                        const ai = this.calculateAI(aiFormula, inputIndex, data);
                        const rotation = this.generateRotation(ai);
                        const pred = this.applyPatternToRotation(rotation, pattern);
                        
                        const targetData = data[targetIndex];
                        const targetDigits = this.getTargetDigits(targetData, targetType);
                        
                        const check = this.checkPrediction(pred, targetDigits, targetType);
                        
                        predictions.push({
                            input: data[inputIndex],
                            prediction: pred,
                            target: targetDigits,
                            hit: check.hit,
                            matchedDigit: check.matchedDigit,
                            ai: ai
                        });
                        
                        attempts++;
                        
                        if (check.hit) {
                            hits++;
                        } else {
                            patah++;
                            // STRICT PATAH LIMIT ENFORCEMENT
                            if (patah > patahLimit) {
                                return null; // Immediately stop jika melebihi patah limit
                            }
                        }
                        
                    } catch (e) {
                        return null;
                    }
                }
                
                if (attempts < daysToTest) return null;
                
                // Double check patah limit
                if (patah > patahLimit) return null;
                
                return {
                    fullFormula: `${aiFormula} ${pattern}`, // Include pattern in full formula
                    aiFormula,
                    pattern,
                    targetType,
                    hits,
                    attempts,
                    patah,
                    accuracy: hits / attempts,
                    predictions,
                    passed: patah <= patahLimit
                };
            },

            testCombination: function(aiFormula, pattern, data, daysToTest, patahLimit, targetType) {
                if (targetType === 'all') {
                    for (const type of this.testPriorityOrder) {
                        const result = this.testSingleTargetType(aiFormula, pattern, data, daysToTest, patahLimit, type);
                        if (result && result.passed) {
                            result.targetType = type;
                            return result;
                        }
                    }
                    return null;
                } else {
                    return this.testSingleTargetType(aiFormula, pattern, data, daysToTest, patahLimit, targetType);
                }
            },

// =============================================
// GENERATE KOMBINASI
// =============================================
            generateAIFormulas: function(mode, dataLength, daysToTest) {
                const comps = ['A','C','K','E','J','Js','J3D','J4D'];
                const maxOffset = Math.max(1, Math.min(10, dataLength - daysToTest - 3));
                const offsets = [];
                
                for (let i = 1; i <= maxOffset; i++) {
                    offsets.push(i.toString());
                }
                
                if (offsets.length === 0) offsets.push('1');
                
                const formulas = new Set();
                
                if (mode === 'full') {
                    const mistiks = ['', 'ix','ml','mb','ty','m9'];
                    const finals = ['', '.(ix)', '.(ml)', '.(mb)', '.(ty)', '.(m9)'];
                    
                    for (let c of comps) {
                        for (let o of offsets) {
                            for (let m of mistiks) {
                                for (let f of finals) {
                                    formulas.add(`${c}${o}${m}${f}`);
                                }
                            }
                        }
                    }
                    
                    for (let c1 of comps) {
                        for (let o1 of offsets) {
                            for (let m1 of mistiks) {
                                for (let op of ['+', '-']) {
                                    for (let c2 of comps) {
                                        for (let o2 of offsets) {
                                            for (let m2 of mistiks) {
                                                for (let f of finals) {
                                                    formulas.add(`${c1}${o1}${m1}${op}${c2}${o2}${m2}${f}`);
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                } else {
                    for (let c of comps) {
                        for (let o of offsets) {
                            formulas.add(`${c}${o}`);
                        }
                    }
                    
                    for (let c1 of ['A','C','K','E','J']) {
                        for (let o1 of offsets.slice(0, 5)) {
                            for (let op of ['+', '-']) {
                                for (let c2 of ['A','C','K','E','J']) {
                                    for (let o2 of offsets.slice(0, 5)) {
                                        formulas.add(`${c1}${o1}${op}${c2}${o2}`);
                                    }
                                }
                            }
                        }
                    }
                }
                
                return Array.from(formulas);
            },

            generatePatterns: function(digitCount) {
                const patterns = [];
                
                function generate(current, depth) {
                    if (depth === digitCount) {
                        patterns.push('N' + current.join('N'));
                        return;
                    }
                    
                    for (let n = 0; n <= 9; n++) {
                        generate([...current, n], depth + 1);
                    }
                }
                
                generate([], 0);
                return patterns;
            },

// =============================================
// SISTEM PENCARIAN
// =============================================
            startSearch: function() {
                if (this.isSearching) return;
                
                try {
                    const input = document.getElementById('numbers2').value.trim();
                    const digitCount = parseInt(document.getElementById('digitCount2').value) || 3;
                    const daysToPredict = parseInt(document.getElementById('daysToPredict2').value) || 16;
                    const searchMode = document.getElementById('searchMode2').value;
                    const targetType = document.getElementById('targetType2').value;
                    
                    const patahInput = document.getElementById('patah2').value;
                    if (patahInput === '') {
                        this.currentPatahLimit = 0;
                    } else {
                        this.currentPatahLimit = parseInt(patahInput);
                        if (isNaN(this.currentPatahLimit) || this.currentPatahLimit < 0 || this.currentPatahLimit > 5) {
                            alert('Patah harus 0 sampai 5!');
                            return;
                        }
                    }
                    
                    if (!input) {
                        alert('Masukkan data terlebih dahulu!');
                        return;
                    }
                    
                    if (isNaN(digitCount) || digitCount < 1 || digitCount > 7) {
                        alert('Digit Prediksi harus 1 sampai 7!');
                        return;
                    }
                    
                    if (isNaN(daysToPredict) || daysToPredict < 1 || daysToPredict > 50) {
                        alert('Hari Prediksi harus 1 sampai 50!');
                        return;
                    }
                    
                    const lines = input.split('\n').map(l => l.trim()).filter(l => /^\d{4}$/.test(l));
                    this.dataHistory = lines;
                    
                    if (lines.length < daysToPredict + 1) {
                        alert(`Data tidak cukup!\n\nData: ${lines.length} angka\nButuh minimal: ${daysToPredict + 1} angka`);
                        return;
                    }
                    
                    // GENERATE KOMBINASI
                    this.aiFormulas = this.generateAIFormulas(searchMode, lines.length, daysToPredict);
                    this.allPatterns = this.generatePatterns(digitCount);
                    
                    this.totalCombinations = this.aiFormulas.length * this.allPatterns.length;
                    this.totalSessions = Math.ceil(this.totalCombinations / this.COMBINATIONS_PER_SESSION);
                    
                    // RESET STATE
                    this.isSearching = true;
                    this.stopRequested = false;
                    this.foundResults = [];
                    this.uniqueAIFormulas.clear();
                    this.currentSession = 0;
                    this.processedInSession = 0;
                    this.totalProcessed = 0;
                    this.currentFormulaIndex = 0;
                    this.currentPatternIndex = 0;
                    this.startTime = new Date();
                    
                    // UPDATE UI
                    document.getElementById('runBtn2').disabled = true;
                    document.getElementById('stopBtn2').disabled = false;
                    document.getElementById('continueBtn2').disabled = true;
                    document.getElementById('foundCount2').textContent = '0';
                    document.getElementById('processedCount2').textContent = '0';
                    document.getElementById('formulaCount2').textContent = this.totalCombinations.toLocaleString();
                    document.getElementById('progressFill2').style.width = '0%';
                    
                    // TAMPILKAN INFO AWAL
                    let output = `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
                    output += `Data: ${lines.length} angka | Prediksi: ${daysToPredict} hari\n`;
                    output += `Mode: ${searchMode === 'full' ? 'LENGKAP' : 'CEPAT'}\n`;
                    output += `Digit: ${digitCount} | Target: ${this.getTargetTypeName(targetType)}\n`;
                    output += `Patah: ${this.currentPatahLimit}x\n`;
                    output += `Kombinasi: ${this.totalCombinations.toLocaleString()}\n`;
                    output += `Sesi: ${this.totalSessions} sesi (@${this.COMBINATIONS_PER_SESSION.toLocaleString()})\n`;
                    output += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;
                    
                    document.getElementById('resultOutput2').textContent = output;
                    
                    // Save progress sebelum mulai
                    this.saveProgress();
                    
                    // MULAI SESI PERTAMA
                    this.startNewSession();
                    
                } catch (error) {
                    alert('Terjadi error: ' + error.message);
                    this.resetSearchState();
                }
            },

            startNewSession: function() {
                if (!this.isSearching || this.stopRequested) {
                    return;
                }
                
                this.currentSession++;
                this.processedInSession = 0;
                
                // Update UI
                this.updateProgress();
                this.updateProgressWithMessage(`üöÄ Memulai sesi ${this.currentSession}...`);
                
                // Mulai proses batch
                setTimeout(() => {
                    this.processBatch();
                }, 500);
            },

            processBatch: function() {
                if (this.stopRequested || !this.isSearching) {
                    this.finishSession();
                    return;
                }
                
                if (this.currentFormulaIndex >= this.aiFormulas.length) {
                    this.finishSearch();
                    return;
                }
                
                const daysToPredict = parseInt(document.getElementById('daysToPredict2').value) || 16;
                const targetType = document.getElementById('targetType2').value;
                
                let processedInBatch = 0;
                
                for (let i = 0; i < this.BATCH_SIZE; i++) {
                    if (this.stopRequested) break;
                    
                    if (this.processedInSession >= this.COMBINATIONS_PER_SESSION) {
                        this.finishSession();
                        return;
                    }
                    
                    if (this.currentFormulaIndex >= this.aiFormulas.length) {
                        this.finishSearch();
                        return;
                    }
                    
                    const aiFormula = this.aiFormulas[this.currentFormulaIndex];
                    const pattern = this.allPatterns[this.currentPatternIndex];
                    
                    try {
                        const result = this.testCombination(aiFormula, pattern, this.dataHistory, daysToPredict, this.currentPatahLimit, targetType);
                        
                        if (result && result.passed) {
                            const normalizedAIFormula = this.normalizeAIFormula(aiFormula);
                            
                            if (!this.uniqueAIFormulas.has(normalizedAIFormula)) {
                                this.uniqueAIFormulas.add(normalizedAIFormula);
                                this.foundResults.push(result);
                                document.getElementById('foundCount2').textContent = this.foundResults.length;
                                this.displayResult(result);
                            }
                        }
                    } catch (e) {
                        // Skip error
                    }
                    
                    this.processedInSession++;
                    this.totalProcessed++;
                    processedInBatch++;
                    
                    this.currentPatternIndex++;
                    if (this.currentPatternIndex >= this.allPatterns.length) {
                        this.currentPatternIndex = 0;
                        this.currentFormulaIndex++;
                    }
                    
                    if (this.processedInSession % 1000 === 0) {
                        this.updateProgress();
                    }
                }
                
                document.getElementById('processedCount2').textContent = this.totalProcessed.toLocaleString();
                
                if (this.isSearching && !this.stopRequested) {
                    setTimeout(() => {
                        this.processBatch();
                    }, 1);
                }
            },

            normalizeAIFormula: function(aiFormula) {
                let baseFormula = aiFormula.replace(/\.\([^)]+\)$/, '');
                
                if (baseFormula.includes('+') || baseFormula.includes('-')) {
                    const parts = baseFormula.split(/([+\-])/).filter(p => p.trim());
                    
                    if (parts.length === 3) {
                        const [comp1, operator, comp2] = parts;
                        const sorted = [comp1, comp2].sort();
                        return sorted[0] + operator + sorted[1];
                    }
                }
                
                return baseFormula;
            },

            finishSession: function() {
                if (!this.isSearching) return;
                
                if (this.currentFormulaIndex >= this.aiFormulas.length) {
                    this.finishSearch();
                    return;
                }
                
                const autoContinue = document.getElementById('autoContinue2').checked;
                
                if (autoContinue) {
                    // Save progress dulu
                    this.saveProgress();
                    
                    // Cleanup memory tapi JANGAN reset kombinasi
                    this.cleanupMemory();
                    
                    // Tampilkan status
                    this.updateProgressWithMessage(`‚è∏Ô∏è Sesi ${this.currentSession} selesai. Auto-continue dalam 5 detik...`);
                    
                    // Reset flag dulu
                    this.isSearching = false;
                    this.stopRequested = false;
                    
                    // Update UI state
                    document.getElementById('runBtn2').disabled = true;
                    document.getElementById('stopBtn2').disabled = true;
                    document.getElementById('continueBtn2').disabled = true;
                    
                    // Set timeout untuk next session
                    setTimeout(() => {
                        // Reset search state untuk sesi baru
                        this.stopRequested = false;
                        this.isSearching = true;
                        
                        // JANGAN regenerate combinations!
                        // Tetap gunakan kombinasi yang sama
                        
                        // Reset hanya processedInSession untuk counter sesi baru
                        this.processedInSession = 0;
                        
                        // Update UI
                        document.getElementById('stopBtn2').disabled = false;
                        
                        // Mulai sesi baru
                        this.startNewSession();
                    }, 5000);
                    
                } else {
                    this.isSearching = false;
                    this.stopRequested = false;
                    
                    document.getElementById('runBtn2').disabled = false;
                    document.getElementById('stopBtn2').disabled = true;
                    document.getElementById('continueBtn2').disabled = false;
                    
                    this.saveProgress();
                    
                    this.updateProgressWithMessage(`‚è∏Ô∏è Sesi ${this.currentSession} selesai. Klik LANJUT untuk sesi ${this.currentSession + 1}`);
                }
                
                this.updateProgress();
            },

            continueSearch: function() {
                if (this.isSearching) {
                    alert('Proses sedang berjalan!');
                    return;
                }
                
                if (this.currentFormulaIndex >= this.aiFormulas.length) {
                    alert('Pencarian sudah selesai!');
                    this.finishSearch();
                    return;
                }
                
                // Reset state
                this.isSearching = true;
                this.stopRequested = false;
                
                // Update UI
                document.getElementById('runBtn2').disabled = true;
                document.getElementById('stopBtn2').disabled = false;
                document.getElementById('continueBtn2').disabled = true;
                
                this.updateProgressWithMessage(`‚ñ∂Ô∏è Melanjutkan sesi ${this.currentSession}...`);
                
                // Mulai sesi dengan delay kecil
                setTimeout(() => {
                    this.startNewSession();
                }, 100);
            },

            stopSearch: function() {
                if (!this.isSearching) {
                    return;
                }
                
                this.stopRequested = true;
                this.isSearching = false;
                
                // Save progress
                this.saveProgress();
                
                // Update UI
                document.getElementById('runBtn2').disabled = false;
                document.getElementById('stopBtn2').disabled = true;
                document.getElementById('continueBtn2').disabled = false;
                
                // Tampilkan status
                const sessionProgress = (this.processedInSession / this.COMBINATIONS_PER_SESSION) * 100;
                this.updateProgressWithMessage(`‚èπÔ∏è Proses dihentikan (sesi ${this.currentSession}: ${Math.round(sessionProgress)}%). ${this.foundResults.length} rumus ditemukan.`);
                
                this.updateProgress();
            },

            finishSearch: function() {
                this.isSearching = false;
                this.stopRequested = false;
                
                document.getElementById('runBtn2').disabled = false;
                document.getElementById('stopBtn2').disabled = true;
                document.getElementById('continueBtn2').disabled = true;
                
                const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
                let output = document.getElementById('resultOutput2').textContent;
                
                output += `\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
                output += `Waktu: ${elapsed} detik\n`;
                output += `Total diproses: ${this.totalProcessed.toLocaleString()}\n`;
                output += `Rumus ditemukan: ${this.foundResults.length}\n`;
                output += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;
                
                if (this.foundResults.length > 0) {
                    output += `üèÜ RUMUS TERBAIK:\n`;
                    this.foundResults.sort((a, b) => {
                        if (a.patah !== b.patah) return a.patah - b.patah;
                        return b.accuracy - a.accuracy;
                    });
                    
                    const best = this.foundResults[0];
                    output += `Formula: ${best.fullFormula}\n`;
                    output += `Target: ${this.getTargetTypeName(best.targetType)}\n`;
                    output += `‚úÖ ${best.hits}/${best.attempts} | ‚ùå ${best.patah}x\n`;
                } else {
                    output += `üòû TIDAK ADA RUMUS YANG MEMENUHI KRITERIA\n`;
                    output += `Coba kurangi "Patah" atau tambah data input.\n`;
                }
                
                document.getElementById('resultOutput2').textContent = output;
                
                localStorage.removeItem('program2_progress');
            },


// =============================================
// TAMPILAN HASIL (DENGAN POLA N)
// =============================================
            displayResult: function(result) {
                const targetDisplayNames = {
                    'A': 'AS', 'C': 'COP', 'K': 'KEPALA', 'E': 'EKOR',
                    'J': 'JUMLAH', 'AC': 'AC', 'CK': 'CK', 'KE': 'KE', 'CB': 'CB'
                };
                
                const targetSuffix = {
                    'A': 'a', 'C': 'c', 'K': 'k', 'E': 'e',
                    'J': 'j', 'AC': 'ac', 'CK': 'ck', 'KE': 'ai', 'CB': 'cb'
                };
                
                let output = document.getElementById('resultOutput2').textContent;
                
                const resultNumber = this.foundResults.length;
                
                let resultText = `\nüéØ HASIL #${resultNumber}\n`;
                resultText += `Target: ${targetDisplayNames[result.targetType] || result.targetType}\n`;
                
                // Tampilkan prediksi sebelumnya
                for (let i = 0; i < result.predictions.length; i++) {
                    const p = result.predictions[i];
                    const suffix = targetSuffix[result.targetType] || 'ai';
                    // SELALU tampilkan suffix, baik HIT maupun PATAH
                    const mark = p.hit ? ` ${suffix} ‚úÖ` : ` ${suffix} ‚ùå`;
                    resultText += `${p.input} = ${p.prediction}${mark}\n`;
                }
                
                const lastIndex = this.dataHistory.length - 1;
                const currentInput = this.dataHistory[lastIndex];
                let latestPrediction = '?';
                let actualTarget = '?';
                let nextMark = ` ${targetSuffix[result.targetType] || 'ai'} ‚ùå`; // Default dengan suffix
                let statusSuffix = targetSuffix[result.targetType] || 'ai';
                
                try {
                    const ai = this.calculateAI(result.aiFormula, lastIndex, this.dataHistory);
                    const rotation = this.generateRotation(ai);
                    const pred = this.applyPatternToRotation(rotation, result.pattern);
                    latestPrediction = pred;
                    
                    // CARI DATA BERIKUTNYA UNTUK VERIFIKASI
                    if (lastIndex + 1 < this.dataHistory.length) {
                        const nextData = this.dataHistory[lastIndex + 1];
                        actualTarget = this.getTargetDigits(nextData, result.targetType);
                        
                        // CEK APAKAH PREDIKSI BENAR
                        const check = this.checkPrediction(pred, actualTarget, result.targetType);
                        
                        // SELALU gunakan suffix, baik HIT maupun PATAH
                        if (check.hit) {
                            nextMark = ` ${statusSuffix} ‚úÖ`;
                        } else {
                            nextMark = ` ${statusSuffix} ‚ùå`;
                        }
                        
                        // UPDATE STATISTIK
                        result.attempts += 1;
                        if (check.hit) {
                            result.hits += 1;
                        } else {
                            result.patah += 1;
                        }
                        result.accuracy = result.hits / result.attempts;
                    } else {
                        // JIKA BELUM ADA DATA BERIKUTNYA (PREDIKSI MASA DEPAN)
                        actualTarget = pred;
                        // Prediksi masa depan selalu dianggap HIT untuk display
                        nextMark = ` ${statusSuffix} ‚úÖ`;
                    }
                    
                    // FORMAT KONSISTEN: selalu dengan suffix
                    resultText += `${currentInput} = ${pred}${nextMark}\n`;
                    
                } catch (e) {
                    resultText += `${currentInput} = ? ${statusSuffix} ‚ùå\n`;
                }
                
                resultText += `======\n`;
                resultText += `${result.fullFormula}\n`;
                resultText += `‚úÖ ${result.hits}/${result.attempts} | ‚ùå ${result.patah}x\n`;
                
                output += resultText;
                document.getElementById('resultOutput2').textContent = output;
                
                // SIMPAN DATA UNTUK COPY (format berbeda)
                result.copyData = [];
                const suffix = targetSuffix[result.targetType] || 'ai';
                
                for (let i = 0; i < result.predictions.length; i++) {
                    const p = result.predictions[i];
                    // Copy data: suffix untuk hit, 'x' untuk patah
                    const status = p.hit ? suffix : 'x';
                    result.copyData.push(`${p.input} = ${p.prediction} ${status}`);
                }
                
                if (latestPrediction !== '?') {
                    // Untuk copy data: gunakan suffix jika hit, 'x' jika patah
                    const copyStatus = (lastIndex + 1 < this.dataHistory.length) ? 
                        (nextMark.includes('‚úÖ') ? suffix : 'x') : suffix;
                    result.copyData.push(`${currentInput} = ${latestPrediction} ${copyStatus}`);
                }
                
                const resultBox = document.getElementById('resultOutput2');
                resultBox.scrollTop = resultBox.scrollHeight;
            },

// =============================================
// COPY OUTPUT
// =============================================
            copyOutput: function() {
                let copyText = '';
                
                for (let i = 0; i < this.foundResults.length; i++) {
                    const result = this.foundResults[i];
                    
                    if (result.copyData) {
                        if (i > 0) copyText += '\n\n';
                        copyText += result.copyData.join('\n') + '\n';
                    }
                    
                    copyText += `======\n`;
                    copyText += `${result.fullFormula}\n`; // Already includes pola N!
                }
                
                if (!copyText) {
                    copyText = document.getElementById('resultOutput2').textContent;
                }
                
                navigator.clipboard.writeText(copyText).then(() => {
                    showNotification('‚úÖ Output berhasil disalin!');
                }).catch(() => {
                    const ta = document.createElement('textarea');
                    ta.value = copyText;
                    document.body.appendChild(ta);
                    ta.select();
                    document.execCommand('copy');
                    document.body.removeChild(ta);
                    showNotification('‚úÖ Output berhasil disalin!');
                });
            },

// =============================================
// MEMORY MANAGEMENT
// =============================================
            cleanupMemory: function() {
                // Cleanup memory tapi JANGAN reset data penting
                if (window.gc) {
                    try { window.gc(); } catch(e) {}
                }
            },

            saveProgress: function() {
                if (this.foundResults.length === 0 && this.totalProcessed === 0) return;
                
                const progressData = {
                    version: '1.0',
                    timestamp: Date.now(),
                    dataHistory: this.dataHistory,
                    aiFormulas: this.aiFormulas, // SIMPAN kombinasi
                    allPatterns: this.allPatterns, // SIMPAN pola
                    foundResults: this.foundResults.map(r => ({
                        fullFormula: r.fullFormula,
                        aiFormula: r.aiFormula,
                        pattern: r.pattern,
                        targetType: r.targetType,
                        hits: r.hits,
                        attempts: r.attempts,
                        patah: r.patah,
                        accuracy: r.accuracy,
                        copyData: r.copyData // Simpan juga copy data
                    })),
                    uniqueAIFormulas: Array.from(this.uniqueAIFormulas), // Convert Set to Array
                    currentSession: this.currentSession,
                    processedInSession: this.processedInSession,
                    totalProcessed: this.totalProcessed,
                    totalCombinations: this.totalCombinations,
                    currentFormulaIndex: this.currentFormulaIndex,
                    currentPatternIndex: this.currentPatternIndex,
                    settings: {
                        daysToPredict: document.getElementById('daysToPredict2').value,
                        digitCount: document.getElementById('digitCount2').value,
                        patah: document.getElementById('patah2').value,
                        targetType: document.getElementById('targetType2').value,
                        searchMode: document.getElementById('searchMode2').value,
                        autoContinue: document.getElementById('autoContinue2').checked
                    }
                };
                
                try {
                    const jsonString = JSON.stringify(progressData);
                    localStorage.setItem('program2_progress', jsonString);
                } catch (e) {
                    console.warn('Gagal menyimpan progress:', e);
                }
            },

            loadProgress: function() {
                const saved = localStorage.getItem('program2_progress');
                
                if (!saved) return false;
                
                try {
                    const progressData = JSON.parse(saved);
                    
                    // Cek versi
                    if (progressData.version !== '1.0') {
                        console.warn('Versi data tidak kompatibel');
                        return false;
                    }
                    
                    // Restore SEMUA data termasuk kombinasi
                    this.dataHistory = progressData.dataHistory || [];
                    this.aiFormulas = progressData.aiFormulas || []; // LOAD kombinasi
                    this.allPatterns = progressData.allPatterns || []; // LOAD pola
                    this.foundResults = progressData.foundResults || [];
                    this.uniqueAIFormulas = new Set(progressData.uniqueAIFormulas || []); // Convert back to Set
                    this.currentSession = progressData.currentSession || 0;
                    this.processedInSession = progressData.processedInSession || 0;
                    this.totalProcessed = progressData.totalProcessed || 0;
                    this.totalCombinations = progressData.totalCombinations || 0;
                    this.currentFormulaIndex = progressData.currentFormulaIndex || 0;
                    this.currentPatternIndex = progressData.currentPatternIndex || 0;
                    
                    // Restore settings
                    if (progressData.settings) {
                        document.getElementById('daysToPredict2').value = progressData.settings.daysToPredict || '16';
                        document.getElementById('digitCount2').value = progressData.settings.digitCount || '3';
                        document.getElementById('patah2').value = progressData.settings.patah || '';
                        document.getElementById('targetType2').value = progressData.settings.targetType || 'all';
                        document.getElementById('searchMode2').value = progressData.settings.searchMode || 'full';
                        document.getElementById('autoContinue2').checked = progressData.settings.autoContinue || false;
                    }
                    
                    // Restore UI
                    document.getElementById('dataCount2').textContent = this.dataHistory.length;
                    document.getElementById('foundCount2').textContent = this.foundResults.length;
                    document.getElementById('processedCount2').textContent = this.totalProcessed.toLocaleString();
                    document.getElementById('formulaCount2').textContent = this.totalCombinations.toLocaleString();
                    
                    // Update progress bar
                    const progress = (this.totalProcessed / this.totalCombinations) * 100;
                    document.getElementById('progressFill2').style.width = `${Math.min(progress, 100)}%`;
                    
                    // Tampilkan hasil yang sudah ada
                    this.displayLoadedResults();
                    
                    this.updateStatusInfo();
                    
                    // Tampilkan notifikasi
                    const date = new Date(progressData.timestamp).toLocaleString();
                    this.updateProgressWithMessage(`üíæ Progress ditemukan (tersimpan: ${date})`);
                    
                    return true;
                    
                } catch (error) {
                    console.error('Error loading progress:', error);
                    localStorage.removeItem('program2_progress');
                    return false;
                }
            },

            displayLoadedResults: function() {
                let output = `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
                output += `üíæ PROGRESS DIMUAT\n`;
                output += `Data: ${this.dataHistory.length} angka\n`;
                output += `Sesi: ${this.currentSession}\n`;
                output += `Diproses: ${this.totalProcessed.toLocaleString()}\n`;
                output += `Ditemukan: ${this.foundResults.length} rumus\n`;
                output += `Progress: ${Math.round((this.totalProcessed / this.totalCombinations) * 100)}%\n`;
                output += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;
                
                // Tampilkan 5 hasil terbaik
                if (this.foundResults.length > 0) {
                    output += `üèÜ HASIL TERBAIK YANG TERSIMPAN:\n`;
                    const bestResults = [...this.foundResults]
                        .sort((a, b) => {
                            if (a.patah !== b.patah) return a.patah - b.patah;
                            return b.accuracy - a.accuracy;
                        })
                        .slice(0, 5);
                    
                    bestResults.forEach((result, index) => {
                        output += `${index + 1}. ${result.fullFormula}\n`;
                        output += `   Target: ${this.getTargetTypeName(result.targetType)}\n`;
                        output += `   ‚úÖ ${result.hits}/${result.attempts} | ‚ùå ${result.patah}x\n\n`;
                    });
                }
                
                document.getElementById('resultOutput2').textContent = output;
            },

// =============================================
// FUNGSI BANTUAN
// =============================================
            updateProgress: function() {
                const progress = (this.totalProcessed / this.totalCombinations) * 100;
                document.getElementById('progressFill2').style.width = `${Math.min(progress, 100)}%`;
                
                const sessionProgress = (this.processedInSession / this.COMBINATIONS_PER_SESSION) * 100;
                
                const statusDiv = document.getElementById('infoStatus2');
                let html = `
                    <div class="info-line-2">
                        <span class="label-2">Sesi:</span>
                        <span class="value-2">${this.currentSession}/${this.totalSessions}</span>
                    </div>
                    <div class="info-line-2">
                        <span class="label-2">Progress Sesi:</span>
                        <span class="value-2">${Math.round(sessionProgress)}%</span>
                    </div>
                    <div class="info-line-2">
                        <span class="label-2">Total Progress:</span>
                        <span class="value-2">${Math.round(progress)}%</span>
                    </div>
                    <div class="info-line-2">
                        <span class="label-2">Ditemukan:</span>
                        <span class="value-2">${this.foundResults.length} rumus</span>
                    </div>
                    <div class="info-line-2">
                        <span class="label-2">Diproses:</span>
                        <span class="value-2">${this.totalProcessed.toLocaleString()}</span>
                    </div>
                `;
                
                // Tambah info memory jika available
                if (performance && performance.memory) {
                    const mem = performance.memory;
                    const usedMB = Math.round(mem.usedJSHeapSize / (1024 * 1024));
                    const totalMB = Math.round(mem.jsHeapSizeLimit / (1024 * 1024));
                    
                    html += `
                        <div class="info-line-2">
                            <span class="label-2">Memory:</span>
                            <span class="value-2 ${usedMB > totalMB * 0.7 ? 'warning' : ''}">
                                ${usedMB}MB / ${totalMB}MB
                            </span>
                        </div>
                    `;
                }
                
                // Tambah mode auto-continue jika aktif
                if (document.getElementById('autoContinue2').checked && this.isSearching) {
                    html += `
                        <div class="info-line-2">
                            <span class="label-2">Mode:</span>
                            <span class="value-2" style="color:#2ecc71">AUTO-CONTINUE</span>
                        </div>
                    `;
                }
                
                statusDiv.innerHTML = html;
            },

            updateProgressWithMessage: function(message) {
                const statusDiv = document.getElementById('infoStatus2');
                statusDiv.innerHTML = `
                    <div style="color: #3498db; font-weight: bold; margin-bottom: 5px;">
                        ${message}
                    </div>
                    ${statusDiv.innerHTML}
                `;
            },

            getTargetTypeName: function(type) {
                const names = {
                    'A': 'AS', 'C': 'COP', 'K': 'KEPALA', 'E': 'EKOR',
                    'J': 'JUMLAH', 'AC': 'AC', 'CK': 'CK', 'KE': 'KE', 
                    'CB': 'CB', 'all': 'Semua'
                };
                return names[type] || type;
            },

            updateStatusInfo: function() {
                const statusDiv = document.getElementById('infoStatus2');
                
                const input = document.getElementById('numbers2').value.trim();
                const lines = input.split('\n').map(l => l.trim()).filter(l => /^\d{4}$/.test(l));
                const dataCount = lines.length;
                
                const daysToPredict = parseInt(document.getElementById('daysToPredict2').value) || 16;
                const digitCount = parseInt(document.getElementById('digitCount2').value) || 3;
                const patah = document.getElementById('patah2').value;
                const mode = document.getElementById('searchMode2').value;
                const targetType = document.getElementById('targetType2').value;
                
                if (!this.isSearching) {
                    let html = '<div class="info-line-2">';
                    html += `<span class="label-2">Data:</span>`;
                    html += `<span class="value-2">${dataCount} angka</span>`;
                    html += '</div>';
                    
                    html += '<div class="info-line-2">';
                    html += `<span class="label-2">Prediksi:</span>`;
                    html += `<span class="value-2">${daysToPredict} hari</span>`;
                    html += '</div>';
                    
                    html += '<div class="info-line-2">';
                    html += `<span class="label-2">Target:</span>`;
                    html += `<span class="value-2">${this.getTargetTypeName(targetType)}</span>`;
                    html += '</div>';
                    
                    html += '<div class="info-line-2">';
                    html += `<span class="label-2">Patah:</span>`;
                    html += `<span class="value-2">${patah === '' ? '0' : patah}x</span>`;
                    html += '</div>';
                    
                    // Tampilkan progress tersimpan jika ada
                    const saved = localStorage.getItem('program2_progress');
                    if (saved) {
                        try {
                            const data = JSON.parse(saved);
                            const date = new Date(data.timestamp).toLocaleString();
                            html += '<div class="info-line-2">';
                            html += `<span class="label-2" style="color:#2ecc71">Progress Tersimpan:</span>`;
                            html += `<span class="value-2" style="color:#2ecc71">${date}</span>`;
                            html += '</div>';
                        } catch (e) {}
                    }
                    
                    statusDiv.innerHTML = html;
                }
            },

            clearAll: function() {
                if (this.isSearching) {
                    alert('Hentikan proses terlebih dahulu!');
                    return;
                }
                
                if (!confirm('Hapus SEMUA data dan hasil?')) return;
                
                document.getElementById('numbers2').value = '';
                document.getElementById('resultOutput2').textContent = '';
                
                document.getElementById('dataCount2').textContent = '0';
                document.getElementById('formulaCount2').textContent = '0';
                document.getElementById('processedCount2').textContent = '0';
                document.getElementById('foundCount2').textContent = '0';
                document.getElementById('progressFill2').style.width = '0%';
                
                document.getElementById('daysToPredict2').value = '16';
                document.getElementById('digitCount2').value = '3';
                document.getElementById('patah2').value = '';
                document.getElementById('targetType2').value = 'all';
                document.getElementById('searchMode2').value = 'full';
                document.getElementById('autoContinue2').checked = false;
                
                this.resetSearchState();
                this.updateStatusInfo();
                
                // Hapus saved progress
                localStorage.removeItem('program2_progress');
            },

            clearOutput: function() {
                if (this.isSearching) {
                    alert('Hentikan proses terlebih dahulu!');
                    return;
                }
                
                if (!confirm('Hapus semua hasil output?')) return;
                
                document.getElementById('resultOutput2').textContent = '';
            },

            resetSearchState: function() {
                this.dataHistory = [];
                this.aiFormulas = [];
                this.allPatterns = [];
                this.foundResults = [];
                this.uniqueAIFormulas.clear();
                this.isSearching = false;
                this.stopRequested = false;
                this.currentPatahLimit = 0;
                this.totalCombinations = 0;
                this.currentSession = 0;
                this.totalSessions = 0;
                this.processedInSession = 0;
                this.totalProcessed = 0;
                this.currentFormulaIndex = 0;
                this.currentPatternIndex = 0;
            },

            init: function() {
                const daysInput = document.getElementById('daysToPredict2');
                daysInput.addEventListener('input', () => {
                    this.validateNumberInput(daysInput, 1, 50);
                });
                
                const digitInput = document.getElementById('digitCount2');
                digitInput.addEventListener('input', () => {
                    this.validateNumberInput(digitInput, 1, 7);
                });
                
                const patahInput = document.getElementById('patah2');
                patahInput.addEventListener('input', () => {
                    let value = patahInput.value.replace(/[^\d]/g, '');
                    if (value === '') {
                        patahInput.value = '';
                    } else {
                        let numValue = parseInt(value);
                        if (numValue > 5) numValue = 5;
                        patahInput.value = numValue;
                    }
                    this.updateStatusInfo();
                });
                
                const numbersTextarea = document.getElementById('numbers2');
                numbersTextarea.addEventListener('input', () => {
                    this.validateTextareaInput(numbersTextarea);
                });
                
                const inputsToWatch = ['daysToPredict2', 'digitCount2', 'patah2', 'targetType2', 'searchMode2', 'autoContinue2'];
                inputsToWatch.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('change', () => this.updateStatusInfo());
                    }
                });
                
                this.updateDataCount();
                
                // Load saved progress jika ada
                setTimeout(() => {
                    if (this.loadProgress()) {
                        // Tampilkan dialog untuk melanjutkan
                        setTimeout(() => {
                            if (confirm('Ada progress tersimpan. Ingin melanjutkan dari sebelumnya?\n\nKlik OK untuk melanjutkan, Cancel untuk mulai baru.')) {
                                // User ingin melanjutkan
                                this.updateProgressWithMessage('Klik "CARI RUMUS" untuk melanjutkan dari progress tersimpan');
                            } else {
                                // User ingin mulai baru
                                localStorage.removeItem('program2_progress');
                                this.resetSearchState();
                                this.updateStatusInfo();
                            }
                        }, 1000);
                    }
                }, 500);
                
                // Auto-save input data
                setInterval(() => {
                    const inputData = document.getElementById('numbers2').value;
                    if (inputData.trim()) {
                        localStorage.setItem('program2_input', inputData);
                    }
                }, 10000);
                
                // Load saved input data
                const savedInput = localStorage.getItem('program2_input');
                if (savedInput) {
                    document.getElementById('numbers2').value = savedInput;
                    this.updateDataCount();
                }
                
                // Page visibility change handler
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden && this.isSearching) {
                        // Auto-save dan pause jika pindah tab
                        this.saveProgress();
                        if (this.isSearching) {
                            this.stopSearch();
                            showNotification('üíæ Progress otomatis disimpan (pindah tab)');
                        }
                    }
                });
                
                // Before page unload
                window.addEventListener('beforeunload', (event) => {
                    if (this.isSearching) {
                        this.saveProgress();
                        // Optional: Tampilkan warning
                        event.preventDefault();
                        event.returnValue = 'Progress sedang berjalan. Tutup halaman?';
                    }
                });
            }
        };

        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize tab system
            const savedTab = localStorage.getItem('activeTab') || 'program1';
            const tabButton = document.querySelector(`.tab-btn[data-tab="${savedTab}"]`);
            if (tabButton) {
                tabButton.click();
            }
            
            // Initialize both programs
            Program1.init();
            Program2.init();
            
            // Show welcome message
            setTimeout(() => {
                const firstVisit = !localStorage.getItem('prediksi_tools_visited');
                if (firstVisit) {
                    showNotification('Selamat datang di Prediksi Tools! Pilih tab untuk mulai.');
                    localStorage.setItem('prediksi_tools_visited', 'true');
                }
            }, 1000);
        });
    </script>
</body>
</html>
