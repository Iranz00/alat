<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RUMUS OTOMATIS - RAN</title>
    <style>
        /* ========== GLOBAL RESET & FONTS ========== */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body { 
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            overflow-x: hidden;
            transition: all 0.3s ease;
        }
        
        /* ========== DARK MODE THEME ========== */
        body.dark-theme {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            color: #e2e8f0;
        }
        
        /* ========== MAIN CONTAINER ========== */
        .main-container { 
            max-width: 1400px; 
            width: 100%;
            margin: 0 auto; 
            background: white; 
            border-radius: 20px; 
            padding: 30px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
        }
        
        body.dark-theme .main-container {
            background: #2d3748;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        
        /* ========== HEADER ========== */
        .header { 
            text-align: center; 
            margin-bottom: 30px; 
            padding-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }
        
        body.dark-theme .header {
            border-bottom-color: #4a5568;
        }
        
        .header h1 { 
            color: #2d3748; 
            margin-bottom: 10px; 
            font-size: 2.8rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            transition: all 0.3s ease;
        }
        
        body.dark-theme .header h1 {
            color: #e2e8f0;
        }
        
        .subtitle { 
            text-align: center; 
            color: #718096; 
            font-size: 18px; 
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
            transition: all 0.3s ease;
        }
        
        body.dark-theme .subtitle {
            color: #a0aec0;
        }
        
        /* ========== THEME TOGGLE ========== */
        .theme-toggle {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .theme-toggle button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .theme-toggle button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        body.dark-theme .theme-toggle button {
            background: linear-gradient(135deg, #764ba2, #667eea);
        }
        
        /* ========== MAIN GRID LAYOUT ========== */
        .main-grid { 
            display: grid; 
            grid-template-columns: 1fr 1.2fr; 
            gap: 30px; 
            margin-bottom: 30px;
        }
        
        @media (max-width: 1100px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* ========== INPUT SECTION ========== */
        .input-section, .output-section { 
            background: #f8f9fa; 
            padding: 25px; 
            border-radius: 15px; 
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }
        
        body.dark-theme .input-section,
        body.dark-theme .output-section {
            background: #4a5568;
            border-color: #718096;
        }
        
        .section-title { 
            color: #2d3748; 
            margin-bottom: 20px; 
            font-size: 22px; 
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }
        
        body.dark-theme .section-title {
            color: #e2e8f0;
        }
        
        /* ========== DATA INPUT AREA ========== */
        .data-input {
            margin-bottom: 20px;
        }
        
        .data-input textarea { 
            width: 100%; 
            height: 180px; 
            padding: 15px; 
            border: 2px solid #e2e8f0; 
            border-radius: 12px; 
            font-size: 16px; 
            resize: vertical; 
            margin-bottom: 15px;
            font-family: 'Courier New', monospace;
            transition: all 0.3s ease;
            background: white;
            color: #333;
            line-height: 1.4;
        }
        
        body.dark-theme .data-input textarea {
            background: #2d3748;
            border-color: #718096;
            color: #e2e8f0;
        }
        
        .data-input textarea:focus { 
            border-color: #667eea; 
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        body.dark-theme .data-input textarea:focus {
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }
        
        /* ========== DATA STATISTICS ========== */
        .data-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .data-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .stat-box {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        
        body.dark-theme .stat-box {
            background: #2d3748;
            border-color: #4a5568;
        }
        
        .stat-label {
            font-size: 13px;
            color: #718096;
            margin-bottom: 5px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        body.dark-theme .stat-label {
            color: #a0aec0;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2d3748;
        }
        
        body.dark-theme .stat-value {
            color: #e2e8f0;
        }
        
        /* ========== PROGRESS BAR ========== */
        .progress-container {
            margin-bottom: 20px;
        }
        
        .progress-bar {
            width: 100%;
            height: 12px;
            background: #e0e0e0;
            border-radius: 6px;
            margin-top: 5px;
            overflow: hidden;
            position: relative;
        }
        
        body.dark-theme .progress-bar {
            background: #4a5568;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 6px;
        }
        
        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #718096;
            margin-bottom: 5px;
        }
        
        body.dark-theme .progress-text {
            color: #a0aec0;
        }
        
        /* ========== CONTROLS ========== */
        .controls { 
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
        }
        
        .control-group label {
            font-size: 14px;
            color: #2d3748;
            margin-bottom: 8px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        body.dark-theme .control-group label {
            color: #e2e8f0;
        }
        
        .control-group input, .control-group select {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            color: #333;
            transition: all 0.3s ease;
            font-family: inherit;
        }
        
        body.dark-theme .control-group input,
        body.dark-theme .control-group select {
            background: #2d3748;
            border-color: #718096;
            color: #e2e8f0;
        }
        
        .control-group input:focus,
        .control-group select:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        body.dark-theme .control-group input:focus,
        body.dark-theme .control-group select:focus {
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }
        
        /* ========== BUTTONS ========== */
        .button-group { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr);
            gap: 12px; 
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .button-group {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 480px) {
            .button-group {
                grid-template-columns: 1fr;
            }
        }
        
        .action-button { 
            padding: 16px; 
            border: none; 
            border-radius: 10px; 
            font-size: 14px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: white;
            min-height: 55px;
        }
        
        .action-button:hover:not(:disabled) { 
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        
        .action-button:active:not(:disabled) {
            transform: translateY(-1px);
        }
        
        .action-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        .btn-search { 
            background: linear-gradient(135deg, #4CAF50, #45a049);
            grid-column: span 2;
        }
        
        .btn-stop {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            grid-column: span 2;
        }
        
        .btn-continue {
            background: linear-gradient(135deg, #2196F3, #1976D2);
        }
        
        .btn-clear { 
            background: linear-gradient(135deg, #FF9800, #F57C00);
        }
        
        .btn-clear-output {
            background: linear-gradient(135deg, #f44336, #d32f2f);
        }
        
        .btn-copy {
            background: linear-gradient(135deg, #009688, #00796B);
        }
        
        /* ========== AUTO CONTINUE CHECKBOX ========== */
        .auto-continue-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        
        body.dark-theme .auto-continue-checkbox {
            background: #2d3748;
            border-color: #4a5568;
        }
        
        .auto-continue-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #4CAF50;
            cursor: pointer;
        }
        
        .auto-continue-checkbox label {
            font-size: 14px;
            color: #2d3748;
            font-weight: 600;
            cursor: pointer;
            flex: 1;
        }
        
        body.dark-theme .auto-continue-checkbox label {
            color: #e2e8f0;
        }
        
        /* ========== STATUS INFO ========== */
        .status-info {
            background: #e3f2fd;
            border: 2px solid #2196F3;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            font-size: 14px;
            line-height: 1.6;
            color: #0d47a1;
            transition: all 0.3s ease;
        }
        
        body.dark-theme .status-info {
            background: #2d3748;
            border-color: #667eea;
            color: #e2e8f0;
        }
        
        .info-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        body.dark-theme .info-line {
            border-bottom-color: rgba(255,255,255,0.05);
        }
        
        .info-label {
            color: #1976D2;
            font-weight: 600;
            min-width: 140px;
        }
        
        body.dark-theme .info-label {
            color: #90caf9;
        }
        
        .info-value {
            font-weight: bold;
            text-align: right;
            flex: 1;
        }
        
        .info-warning {
            color: #f44336;
            font-weight: bold;
        }
        
        .info-success {
            color: #4CAF50;
            font-weight: bold;
        }
        
        /* ========== RESULT DISPLAY ========== */
        .result-display { 
            background: #1a202c; 
            color: #e2e8f0; 
            padding: 20px; 
            border-radius: 12px; 
            font-family: 'Consolas', 'Courier New', monospace; 
            white-space: pre; 
            line-height: 1.4;
            border: 2px solid #2d3748;
            font-size: 13px;
            overflow-y: auto;
            height: 520px;
            margin-bottom: 20px;
        }
        
        .result-display::-webkit-scrollbar {
            width: 10px;
        }
        
        .result-display::-webkit-scrollbar-track {
            background: #2d3748;
            border-radius: 5px;
        }
        
        .result-display::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 5px;
        }
        
        .result-display::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
        
        body.dark-theme .result-display {
            background: #1a202c;
            border-color: #4a5568;
        }
        
        /* ========== OUTPUT BUTTONS ========== */
        .output-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        @media (max-width: 480px) {
            .output-buttons {
                grid-template-columns: 1fr;
            }
        }
        
        /* ========== NOTIFICATION ========== */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
            z-index: 1000;
            transform: translateX(150%);
            transition: transform 0.3s ease;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.error {
            background: #f44336;
        }
        
        .notification.warning {
            background: #FF9800;
        }
        
        .notification.info {
            background: #2196F3;
        }
        
        /* ========== FOOTER ========== */
        .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e9ecef;
            color: #718096;
            font-size: 13px;
            line-height: 1.6;
        }
        
        body.dark-theme .footer {
            border-top-color: #4a5568;
            color: #a0aec0;
        }
        
        .version {
            font-weight: bold;
            color: #667eea;
            font-size: 14px;
        }
        
        body.dark-theme .version {
            color: #90caf9;
        }
        
        /* ========== RESPONSIVE DESIGN ========== */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .main-container {
                padding: 20px;
                border-radius: 15px;
            }
            
            .header h1 {
                font-size: 2.2rem;
            }
            
            .controls {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .input-section, .output-section {
                padding: 20px;
            }
            
            .result-display {
                height: 400px;
                font-size: 12px;
            }
        }
        
        @media (max-width: 480px) {
            .controls {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .data-stats {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                grid-template-columns: 1fr;
            }
            
            .btn-search, .btn-stop {
                grid-column: span 1;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- HEADER -->
        <div class="header">
            <h1>üîç RUMUS OTOMATIS </h1>
        </div>
        
        <!-- THEME TOGGLE -->
        <div class="theme-toggle">
            <button id="themeButton">
                <span id="themeIcon">üåô</span>
                <span id="themeText">Mode Gelap</span>
            </button>
        </div>
        
        <!-- MAIN CONTENT -->
        <div class="main-grid">
            <!-- INPUT SECTION -->
            <div class="input-section">
                <div class="section-title">üì• INPUT DATA</div>
                
                <div class="data-input">
                    <textarea id="inputNumbers" placeholder="Masukkan angka 4D (satu per baris)"></textarea>
                    
                    <!-- DATA STATISTICS -->
                    <div class="data-stats">
                        <div class="stat-box">
                            <div class="stat-label">DATA</div>
                            <div class="stat-value" id="dataCount">0</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">KOMBINASI</div>
                            <div class="stat-value" id="formulaCount">0</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">HASIL</div>
                            <div class="stat-value" id="foundCount">0</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">PROSES</div>
                            <div class="stat-value" id="processedCount">0</div>
                        </div>
                    </div>
                    
                    <!-- PROGRESS BAR -->
                    <div class="progress-container">
                        <div class="progress-text">
                            <span>Progress</span>
                            <span id="progressPercent">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                    </div>
                </div>
                
                <!-- CONTROLS -->
                <div class="controls">
                    <div class="control-group">
                        <label>üìÖ Hari Prediksi</label>
                        <input type="text" id="daysToPredict" value="16" pattern="[0-9]*" maxlength="2" title="1-50 hari">
                    </div>
                    <div class="control-group">
                        <label>üî¢ Digit Prediksi</label>
                        <input type="text" id="digitCount" value="3" pattern="[1-7]" maxlength="1" title="1-7 digit">
                    </div>
                    <div class="control-group">
                        <label>‚ùå Patah</label>
                        <input type="text" id="patahLimit" value="" pattern="[0-5]*" maxlength="1" placeholder="Kosong = 0" title="0-5 patah">
                    </div>
                    <div class="control-group">
                        <label>üéØ Target Prediksi</label>
                        <select id="targetType">
                            <option value="A">AS (Ribuan)</option>
                            <option value="C">COP (Ratusan)</option>
                            <option value="K">KEPALA (Puluhan)</option>
                            <option value="E">EKOR (Satuan)</option>
                            <option value="J">JUMLAH (K+E)</option>
                            <option value="AC">AC (2D Depan)</option>
                            <option value="CK">CK (2D Tengah)</option>
                            <option value="KE" selected>KE (2D Belakang)</option>
                            <option value="CB">CB (4D Lengkap)</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>‚ö° Mode Pencarian</label>
                        <select id="searchMode">
                            <option value="full">LENGKAP</option>
                            <option value="quick">CEPAT</option>
                        </select>
                    </div>
                </div>
                
                <!-- AUTO CONTINUE -->
                <div class="auto-continue-checkbox">
                    <input type="checkbox" id="autoContinue">
                    <label for="autoContinue">Auto-continue semua sesi (pause 5 detik antar sesi)</label>
                </div>
                
                <!-- ACTION BUTTONS -->
                <div class="button-group">
                    <button class="action-button btn-search" onclick="startSearch()" id="searchBtn">
                        <span>üöÄ</span>
                        <span>CARƒ∞ RUMUS</span>
                    </button>
                    <button class="action-button btn-stop" onclick="stopSearch()" id="stopBtn" disabled>
                        <span>‚èπÔ∏è</span>
                        <span>STOP</span>
                    </button>
                    <button class="action-button btn-continue" onclick="continueSearch()" id="continueBtn" disabled>
                        <span>‚ñ∂Ô∏è</span>
                        <span>LANJUT</span>
                    </button>
                    <button class="action-button btn-clear" onclick="clearAllData()">
                        <span>üóëÔ∏è</span>
                        <span>HAPUS DATA</span>
                    </button>
                </div>
                
                <!-- STATUS INFO -->
                <div class="status-info" id="statusInfo">
                    <!-- Akan diisi oleh JavaScript -->
                </div>
            </div>
            
            <!-- OUTPUT SECTION -->
            <div class="output-section">
                <div class="section-title">üìä HASIL REAL-TIME</div>
                
                <div class="result-display" id="resultOutput"></div>
                
                <div class="output-buttons">
                    <button class="action-button btn-clear-output" onclick="clearOutput()">
                        <span>üóëÔ∏è</span>
                        <span>HAPUS OUTPUT</span>
                    </button>
                    <button class="action-button btn-copy" onclick="copyOutput()">
                        <span>üìã</span>
                        <span>SALIN HASIL</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- FOOTER -->
        <div class="footer">
            <div class="version">Prediksi Tools - Rumus Otomatis</div>
            <div>¬© RAN</div>
        </div>
    </div>

    <!-- NOTIFICATION -->
    <div class="notification" id="notification"></div>

    <script>
    // =============================================
    // GLOBAL VARIABLES AND CONSTANTS
    // =============================================

    const RumusOtomatis = {
        mistikTables: {
            'IX': {'0':'5','1':'6','2':'7','3':'8','4':'9','5':'0','6':'1','7':'2','8':'3','9':'4'},
            'ML': {'0':'1','1':'0','2':'5','3':'8','4':'7','5':'2','6':'9','7':'4','8':'3','9':'6'},
            'MB': {'0':'8','1':'7','2':'6','3':'9','4':'5','5':'4','6':'2','7':'1','8':'0','9':'3'},
            'TY': {'0':'7','1':'4','2':'9','3':'6','4':'1','5':'8','6':'3','7':'0','8':'5','9':'2'},
            'M9': {'0':'9','1':'8','2':'7','3':'6','4':'5','5':'4','6':'3','7':'2','8':'1','9':'0'}
        },

        COMBINATIONS_PER_SESSION: 30000000,
        BATCH_SIZE: 500000,

        dataHistory: [],
        aiFormulas: [],
        allPatterns: [],
        foundResults: [],
        uniqueAIFormulas: new Set(),
        isSearching: false,
        stopRequested: false,
        startTime: null,
        currentPatahLimit: 0,
        totalCombinations: 0,
        currentSession: 0,
        totalSessions: 0,
        processedInSession: 0,
        totalProcessed: 0,
        currentFormulaIndex: 0,
        currentPatternIndex: 0,

        // ========== INITIALIZATION ==========
        init: function() {
            this.setupTheme();
            this.setupEventListeners();
            this.updateDataCount();
            this.loadProgress();
            this.updateStatusInfo();
        },

        // ========== THEME MANAGEMENT ==========
        setupTheme: function() {
            const themeButton = document.getElementById('themeButton');
            const themeIcon = document.getElementById('themeIcon');
            const themeText = document.getElementById('themeText');
            
            function getPreferredTheme() {
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme) return savedTheme;
                
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    return 'dark';
                }
                
                return 'light';
            }

            function setTheme(theme) {
                if (theme === 'dark') {
                    document.body.classList.add('dark-theme');
                    themeIcon.textContent = '‚òÄÔ∏è';
                    themeText.textContent = 'Mode Terang';
                } else {
                    document.body.classList.remove('dark-theme');
                    themeIcon.textContent = 'üåô';
                    themeText.textContent = 'Mode Gelap';
                }
                localStorage.setItem('theme', theme);
            }

            function toggleTheme() {
                const isDark = document.body.classList.contains('dark-theme');
                setTheme(isDark ? 'light' : 'dark');
            }

            setTheme(getPreferredTheme());
            themeButton.addEventListener('click', toggleTheme);
            
            if (window.matchMedia) {
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                    if (!localStorage.getItem('theme')) {
                        setTheme(e.matches ? 'dark' : 'light');
                    }
                });
            }
        },

        // ========== EVENT LISTENERS ==========
        setupEventListeners: function() {
            const daysInput = document.getElementById('daysToPredict');
            daysInput.addEventListener('input', () => {
                this.validateNumberInput(daysInput, 1, 50);
            });
            
            const digitInput = document.getElementById('digitCount');
            digitInput.addEventListener('input', () => {
                this.validateNumberInput(digitInput, 1, 7);
            });
            
            const patahInput = document.getElementById('patahLimit');
            patahInput.addEventListener('input', () => {
                let value = patahInput.value.replace(/[^\d]/g, '');
                if (value === '') {
                    patahInput.value = '';
                } else {
                    let numValue = parseInt(value);
                    if (numValue > 5) numValue = 5;
                    patahInput.value = numValue;
                }
                this.updateStatusInfo();
            });
            
            const numbersTextarea = document.getElementById('inputNumbers');
            numbersTextarea.addEventListener('input', () => {
                this.validateTextareaInput(numbersTextarea);
            });
            
            const inputsToWatch = ['daysToPredict', 'digitCount', 'patahLimit', 'targetType', 'searchMode', 'autoContinue'];
            inputsToWatch.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', () => this.updateStatusInfo());
                }
            });
            
            this.updateDataCount();
        },

        // ========== INPUT VALIDATION ==========
        validateNumberInput: function(input, min, max) {
            let value = input.value.replace(/[^\d]/g, '');
            
            if (value === '') {
                input.value = '';
                return false;
            }
            
            let numValue = parseInt(value);
            if (numValue < min) numValue = min;
            if (numValue > max) numValue = max;
            
            input.value = numValue;
            this.updateStatusInfo();
            return true;
        },

        validateTextareaInput: function(textarea) {
            const original = textarea.value;
            let cleaned = '';
            
            const lines = original.split('\n');
            for (let line of lines) {
                let cleanLine = line.replace(/[^\d]/g, '');
                if (cleanLine.length > 4) cleanLine = cleanLine.substring(0, 4);
                if (cleanLine.length === 4) {
                    cleaned += cleanLine + '\n';
                }
            }
            
            cleaned = cleaned.trim();
            if (cleaned !== original) {
                textarea.value = cleaned;
            }
            
            this.updateDataCount();
        },

        updateDataCount: function() {
            const input = document.getElementById('inputNumbers').value.trim();
            const lines = input.split('\n').map(l => l.trim()).filter(l => /^\d{4}$/.test(l));
            const count = lines.length;
            
            document.getElementById('dataCount').textContent = count;
            this.updateStatusInfo();
            return count;
        },

        // ========== UTILITY FUNCTIONS ==========
        reduceToSingleDigit: function(num) {
            let n = Math.abs(num);
            while (n > 9) n = n.toString().split('').reduce((sum, d) => sum + parseInt(d), 0);
            return n;
        },

        convertMistik: function(number, table) {
            const digit = this.reduceToSingleDigit(parseInt(number)).toString();
            return this.mistikTables[table]?.[digit] || digit;
        },

        getTargetTypeName: function(type) {
            const names = {
                'A': 'AS', 'C': 'COP', 'K': 'KEPALA', 'E': 'EKOR',
                'J': 'JUMLAH', 'AC': 'AC', 'CK': 'CK', 'KE': 'KE', 
                'CB': 'CB'
            };
            return names[type] || type;
        },

        getSuffixForTargetType: function(targetType) {
            const suffixMap = {
                'A': 'a',      'C': 'c',      'K': 'k',      'E': 'e',
                'J': 'j',      'AC': 'ac',    'CK': 'ck',    'KE': 'ai',
                'CB': 'cb'
            };
            return suffixMap[targetType] || 'ai';
        },

        // ========== CORE CALCULATION FUNCTIONS ==========
        processComponent: function(component, currentDayIndex, data) {
            const match = component.match(/^(A|C|K|E|J|Js|J3D|J4D)(\d{1,2})(\w*)$/);
            if (!match) throw new Error(`Komponen tidak valid: ${component}`);
            
            const [_, type, dayStr, mistik] = match;
            const dayOffset = parseInt(dayStr);
            const targetDayIndex = currentDayIndex - (dayOffset - 1);
            
            if (targetDayIndex < 0) throw new Error(`Data tidak cukup untuk ${component}`);
            
            const d = data[targetDayIndex];
            let val;
            
            switch(type) {
                case 'A': val = parseInt(d[0]); break;
                case 'C': val = parseInt(d[1]); break;
                case 'K': val = parseInt(d[2]); break;
                case 'E': val = parseInt(d[3]); break;
                case 'J':  
                    val = parseInt(d[2]) + parseInt(d[3]);
                    val = this.reduceToSingleDigit(val);
                    break;
                case 'Js': 
                    val = Math.abs(parseInt(d[2]) - parseInt(d[3]));
                    val = this.reduceToSingleDigit(val);
                    break;
                case 'J3D':
                    val = parseInt(d[1]) + parseInt(d[2]) + parseInt(d[3]);
                    val = this.reduceToSingleDigit(val);
                    break;
                case 'J4D':
                    val = parseInt(d[0]) + parseInt(d[1]) + parseInt(d[2]) + parseInt(d[3]);
                    val = this.reduceToSingleDigit(val);
                    break;
                default: throw new Error(`Komponen tidak dikenal: ${type}`);
            }
            
            if (mistik) {
                const m = mistik.toUpperCase();
                if (['IX','ML','MB','TY','M9'].includes(m)) {
                    val = parseInt(this.convertMistik(val, m));
                }
            }
            
            return val;
        },

        calculateAI: function(formula, idx, data) {
            let workingFormula = formula;
            let finalMistik = null;
            
            const finalMatch = workingFormula.match(/\.\((\w+)\)$/);
            if (finalMatch) {
                finalMistik = finalMatch[1].toUpperCase();
                workingFormula = workingFormula.replace(/\.\((\w+)\)$/, '');
            }
            
            const parts = workingFormula.split(/([+\-])/).filter(p => p.trim());
            let total = 0;
            let currentOp = '+';
            
            for (let part of parts) {
                if (part === '+' || part === '-') {
                    currentOp = part;
                    continue;
                }
                
                const val = this.processComponent(part.trim(), idx, data);
                
                if (currentOp === '+') {
                    total += val;
                } else {
                    total -= val;
                }
            }
            
            if (finalMistik && ['IX','ML','MB','TY','M9'].includes(finalMistik)) {
                total = parseInt(this.convertMistik(total, finalMistik));
            }
            
            return this.reduceToSingleDigit(total);
        },

        generateRotation: function(ai) {
            const rotation = [];
            for (let i = 0; i < 10; i++) {
                rotation.push((ai + i) % 10);
            }
            return rotation;
        },

        applyPatternToRotation: function(rotation, pattern) {
            const steps = pattern.match(/N(\d)/g);
            if (!steps || steps.length === 0) return '';
            
            const startPos = parseInt(steps[0].substring(1));
            let currentPosition = startPos;
            let result = rotation[currentPosition].toString();
            
            for (let i = 1; i < steps.length; i++) {
                const jump = parseInt(steps[i].substring(1));
                currentPosition = (currentPosition + jump) % 10;
                result += rotation[currentPosition].toString();
            }
            
            return result;
        },

        getTargetDigits: function(nextData, targetType) {
            switch(targetType) {
                case 'A': return nextData[0];
                case 'C': return nextData[1];
                case 'K': return nextData[2];
                case 'E': return nextData[3];
                case 'J': 
                    const k = parseInt(nextData[2]);
                    const e = parseInt(nextData[3]);
                    const sum = k + e;
                    return this.reduceToSingleDigit(sum).toString();
                case 'AC': return nextData[0] + nextData[1];
                case 'CK': return nextData[1] + nextData[2];
                case 'KE': return nextData[2] + nextData[3];
                case 'CB': return nextData;
                default: return nextData;
            }
        },

        checkPrediction: function(predictionDigits, targetDigits, targetType) {
            if (['A', 'C', 'K', 'E', 'J'].includes(targetType)) {
                for (let digit of predictionDigits) {
                    if (digit === targetDigits) {
                        return { hit: true, matchedDigit: digit };
                    }
                }
                return { hit: false, matchedDigit: '' };
            }
            
            else if (['AC', 'CK', 'KE', 'CB'].includes(targetType)) {
                for (let digit of targetDigits) {
                    if (predictionDigits.includes(digit)) {
                        return { hit: true, matchedDigit: digit };
                    }
                }
                return { hit: false, matchedDigit: '' };
            }
            
            return { hit: false, matchedDigit: '' };
        },

        // ========== FORMULA TESTING ==========
        testSingleTargetType: function(aiFormula, pattern, data, daysToTest, patahLimit, targetType) {
            if (data.length < daysToTest + 1) return null;
            
            let hits = 0;
            let attempts = 0;
            let patah = 0;
            const predictions = [];
            
            const startTestIndex = data.length - daysToTest;
            
            for (let i = 0; i < daysToTest; i++) {
                const inputIndex = startTestIndex + i - 1;
                const targetIndex = startTestIndex + i;
                
                if (inputIndex < 0 || targetIndex >= data.length) break;
                
                try {
                    const ai = this.calculateAI(aiFormula, inputIndex, data);
                    const rotation = this.generateRotation(ai);
                    const pred = this.applyPatternToRotation(rotation, pattern);
                    
                    const targetData = data[targetIndex];
                    const targetDigits = this.getTargetDigits(targetData, targetType);
                    
                    const check = this.checkPrediction(pred, targetDigits, targetType);
                    
                    predictions.push({
                        input: data[inputIndex],
                        prediction: pred,
                        target: targetDigits,
                        hit: check.hit,
                        matchedDigit: check.matchedDigit,
                        ai: ai
                    });
                    
                    attempts++;
                    
                    if (check.hit) {
                        hits++;
                    } else {
                        patah++;
                        if (patah > patahLimit) {
                            return null;
                        }
                    }
                    
                } catch (e) {
                    return null;
                }
            }
            
            if (attempts < daysToTest) return null;
            
            if (patah > patahLimit) return null;
            
            return {
                fullFormula: `${aiFormula} ${pattern}`,
                aiFormula,
                pattern,
                targetType,
                hits,
                attempts,
                patah,
                accuracy: hits / attempts,
                predictions,
                passed: patah <= patahLimit
            };
        },

        testCombination: function(aiFormula, pattern, data, daysToTest, patahLimit, targetType) {
            return this.testSingleTargetType(aiFormula, pattern, data, daysToTest, patahLimit, targetType);
        },

        // ========== FORMULA GENERATION ==========
        generateAIFormulas: function(mode, dataLength, daysToTest) {
            const comps = ['A','C','K','E','J','Js','J3D','J4D'];
            const maxOffset = Math.max(1, Math.min(10, dataLength - daysToTest - 3));
            const offsets = [];
            
            for (let i = 1; i <= maxOffset; i++) {
                offsets.push(i.toString());
            }
            
            if (offsets.length === 0) offsets.push('1');
            
            const formulas = new Set();
            
            if (mode === 'full') {
                const mistiks = ['', 'ix','ml','mb','ty','m9'];
                const finals = ['', '.(ix)', '.(ml)', '.(mb)', '.(ty)', '.(m9)'];
                
                for (let c of comps) {
                    for (let o of offsets) {
                        for (let m of mistiks) {
                            for (let f of finals) {
                                formulas.add(`${c}${o}${m}${f}`);
                            }
                        }
                    }
                }
                
                for (let c1 of comps) {
                    for (let o1 of offsets) {
                        for (let m1 of mistiks) {
                            for (let op of ['+', '-']) {
                                for (let c2 of comps) {
                                    for (let o2 of offsets) {
                                        for (let m2 of mistiks) {
                                            for (let f of finals) {
                                                formulas.add(`${c1}${o1}${m1}${op}${c2}${o2}${m2}${f}`);
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            } else {
                for (let c of comps) {
                    for (let o of offsets) {
                        formulas.add(`${c}${o}`);
                    }
                }
                
                for (let c1 of ['A','C','K','E','J']) {
                    for (let o1 of offsets.slice(0, 5)) {
                        for (let op of ['+', '-']) {
                            for (let c2 of ['A','C','K','E','J']) {
                                for (let o2 of offsets.slice(0, 5)) {
                                    formulas.add(`${c1}${o1}${op}${c2}${o2}`);
                                }
                            }
                        }
                    }
                }
            }
            
            return Array.from(formulas);
        },

        generatePatterns: function(digitCount) {
            const patterns = [];
            
            function generate(current, depth) {
                if (depth === digitCount) {
                    patterns.push('N' + current.join('N'));
                    return;
                }
                
                for (let n = 0; n <= 9; n++) {
                    generate([...current, n], depth + 1);
                }
            }
            
            generate([], 0);
            return patterns;
        },

        normalizeAIFormula: function(aiFormula) {
            let baseFormula = aiFormula.replace(/\.\([^)]+\)$/, '');
            
            if (baseFormula.includes('+') || baseFormula.includes('-')) {
                const parts = baseFormula.split(/([+\-])/).filter(p => p.trim());
                
                if (parts.length === 3) {
                    const [comp1, operator, comp2] = parts;
                    const sorted = [comp1, comp2].sort();
                    return sorted[0] + operator + sorted[1];
                }
            }
            
            return baseFormula;
        },

        // ========== SEARCH ENGINE  ==========
        startSearch: function() {
            if (this.isSearching) return;
            
            try {
                const input = document.getElementById('inputNumbers').value.trim();
                const digitCount = parseInt(document.getElementById('digitCount').value) || 3;
                const daysToPredict = parseInt(document.getElementById('daysToPredict').value) || 16;
                const searchMode = document.getElementById('searchMode').value;
                const targetType = document.getElementById('targetType').value;
                
                const patahInput = document.getElementById('patahLimit').value;
                if (patahInput === '') {
                    this.currentPatahLimit = 0;
                } else {
                    this.currentPatahLimit = parseInt(patahInput);
                    if (isNaN(this.currentPatahLimit) || this.currentPatahLimit < 0 || this.currentPatahLimit > 5) {
                        this.showNotification('Patah harus 0 sampai 5!', 'error');
                        return;
                    }
                }
                
                if (!input) {
                    this.showNotification('Masukkan data terlebih dahulu!', 'error');
                    return;
                }
                
                if (isNaN(digitCount) || digitCount < 1 || digitCount > 7) {
                    this.showNotification('Digit Prediksi harus 1 sampai 7!', 'error');
                    return;
                }
                
                if (isNaN(daysToPredict) || daysToPredict < 1 || daysToPredict > 50) {
                    this.showNotification('Hari Prediksi harus 1 sampai 50!', 'error');
                    return;
                }
                
                const lines = input.split('\n').map(l => l.trim()).filter(l => /^\d{4}$/.test(l));
                this.dataHistory = lines;
                
                if (lines.length < daysToPredict + 1) {
                    this.showNotification(
                        `Data tidak cukup!\n\nData: ${lines.length} angka\nButuh minimal: ${daysToPredict + 1} angka`,
                        'error'
                    );
                    return;
                }
                
                // GENERATE COMBINATIONS
                this.aiFormulas = this.generateAIFormulas(searchMode, lines.length, daysToPredict);
                this.allPatterns = this.generatePatterns(digitCount);
                
                this.totalCombinations = this.aiFormulas.length * this.allPatterns.length;
                this.totalSessions = Math.ceil(this.totalCombinations / this.COMBINATIONS_PER_SESSION);
                
                // RESET STATE
                this.isSearching = true;
                this.stopRequested = false;
                this.foundResults = [];
                this.uniqueAIFormulas.clear();
                this.currentSession = 0;
                this.processedInSession = 0;
                this.totalProcessed = 0;
                this.currentFormulaIndex = 0;
                this.currentPatternIndex = 0;
                this.startTime = new Date();
                
                // UPDATE UI
                document.getElementById('searchBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('continueBtn').disabled = true;
                document.getElementById('foundCount').textContent = '0';
                document.getElementById('processedCount').textContent = '0';
                document.getElementById('formulaCount').textContent = this.totalCombinations.toLocaleString();
                document.getElementById('progressFill').style.width = '0%';
                document.getElementById('progressPercent').textContent = '0%';
                
                // SHOW INITIAL INFO
                let output = `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
                output += `üìä PENCARIAN RUMUS DIMULAI\n`;
                output += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;
                output += `üìÖ Data: ${lines.length} angka\n`;
                output += `üéØ Prediksi: ${daysToPredict} hari\n`;
                output += `‚ö° Mode: ${searchMode === 'full' ? 'LENGKAP' : 'CEPAT'}\n`;
                output += `üî¢ Digit: ${digitCount} | Target: ${this.getTargetTypeName(targetType)}\n`;
                output += `‚ùå Patah: ${this.currentPatahLimit}x\n`;
                output += `üßÆ Kombinasi: ${this.totalCombinations.toLocaleString()}\n`;
                output += `üìà Sesi: ${this.totalSessions} sesi\n`;
                output += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;
                
                document.getElementById('resultOutput').textContent = output;
                
                // Save progress
                this.saveProgress();
                
                // START FIRST SESSION
                this.startNewSession();
                
            } catch (error) {
                this.showNotification('Terjadi error: ' + error.message, 'error');
                this.resetSearchState();
            }
        },

        startNewSession: function() {
            if (!this.isSearching || this.stopRequested) {
                return;
            }
            
            this.currentSession++;
            this.processedInSession = 0;
            
            // Update UI
            this.updateProgress();
            this.updateStatusInfo();
            
            // Show session start message
            let output = document.getElementById('resultOutput').textContent;
            output += `\nüöÄ Memulai sesi ${this.currentSession}...\n`;
            document.getElementById('resultOutput').textContent = output;
            
            // Start batch processing
            setTimeout(() => {
                this.processBatch();
            }, 500);
        },

        processBatch: function() {
            if (this.stopRequested || !this.isSearching) {
                this.finishSession();
                return;
            }
            
            if (this.currentFormulaIndex >= this.aiFormulas.length) {
                this.finishSearch();
                return;
            }
            
            const daysToPredict = parseInt(document.getElementById('daysToPredict').value) || 16;
            const targetType = document.getElementById('targetType').value;
            
            let processedInBatch = 0;
            
            for (let i = 0; i < this.BATCH_SIZE; i++) {
                if (this.stopRequested) break;
                    
                if (this.processedInSession >= this.COMBINATIONS_PER_SESSION) {
                    this.finishSession();
                    return;
                }
                
                if (this.currentFormulaIndex >= this.aiFormulas.length) {
                    this.finishSearch();
                    return;
                }
                
                const aiFormula = this.aiFormulas[this.currentFormulaIndex];
                const pattern = this.allPatterns[this.currentPatternIndex];
                
                try {
                    const result = this.testCombination(aiFormula, pattern, this.dataHistory, daysToPredict, this.currentPatahLimit, targetType);
                    
                    if (result && result.passed) {
                        const normalizedAIFormula = this.normalizeAIFormula(aiFormula);
                        
                        if (!this.uniqueAIFormulas.has(normalizedAIFormula)) {
                            this.uniqueAIFormulas.add(normalizedAIFormula);
                            this.foundResults.push(result);
                            document.getElementById('foundCount').textContent = this.foundResults.length;
                            this.displayResult(result);
                        }
                    }
                } catch (e) {
                    // Skip error
                }
                
                this.processedInSession++;
                this.totalProcessed++;
                processedInBatch++;
                
                this.currentPatternIndex++;
                if (this.currentPatternIndex >= this.allPatterns.length) {
                    this.currentPatternIndex = 0;
                    this.currentFormulaIndex++;
                }
                
                if (this.processedInSession % 1000 === 0) {
                    this.updateProgress();
                }
            }
            
            document.getElementById('processedCount').textContent = this.totalProcessed.toLocaleString();
            
            if (this.isSearching && !this.stopRequested) {
                setTimeout(() => {
                    this.processBatch();
                }, 1);
            }
        },

        finishSession: function() {
            if (!this.isSearching) return;
            
            if (this.currentFormulaIndex >= this.aiFormulas.length) {
                this.finishSearch();
                return;
            }
            
            const autoContinue = document.getElementById('autoContinue').checked;
            
            if (autoContinue) {
                // Save progress
                this.saveProgress();
                
                // Cleanup memory
                this.cleanupMemory();
                
                // Show status
                let output = document.getElementById('resultOutput').textContent;
                output += `\n‚è∏Ô∏è Sesi ${this.currentSession} selesai. Auto-continue dalam 5 detik...\n`;
                document.getElementById('resultOutput').textContent = output;
                
                // Reset flags
                this.isSearching = false;
                this.stopRequested = false;
                
                // Update UI
                document.getElementById('searchBtn').disabled = true;
                document.getElementById('stopBtn').disabled = true;
                document.getElementById('continueBtn').disabled = true;
                
                // Set timeout for next session
                setTimeout(() => {
                    this.stopRequested = false;
                    this.isSearching = true;
                    this.processedInSession = 0;
                    document.getElementById('stopBtn').disabled = false;
                    this.startNewSession();
                }, 5000);
                
            } else {
                this.isSearching = false;
                this.stopRequested = false;
                
                document.getElementById('searchBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
                document.getElementById('continueBtn').disabled = false;
                
                this.saveProgress();
                
                let output = document.getElementById('resultOutput').textContent;
                output += `\n‚è∏Ô∏è Sesi ${this.currentSession} selesai. Klik LANJUT untuk sesi ${this.currentSession + 1}\n`;
                document.getElementById('resultOutput').textContent = output;
            }
            
            this.updateProgress();
        },

        continueSearch: function() {
            if (this.isSearching) {
                this.showNotification('Proses sedang berjalan!', 'warning');
                return;
            }
            
            if (this.currentFormulaIndex >= this.aiFormulas.length) {
                this.showNotification('Pencarian sudah selesai!', 'info');
                this.finishSearch();
                return;
            }
            
            // Reset state
            this.isSearching = true;
            this.stopRequested = false;
            
            // Update UI
            document.getElementById('searchBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('continueBtn').disabled = true;
            
            let output = document.getElementById('resultOutput').textContent;
            output += `\n‚ñ∂Ô∏è Melanjutkan sesi ${this.currentSession}...\n`;
            document.getElementById('resultOutput').textContent = output;
            
            // Start session with small delay
            setTimeout(() => {
                this.startNewSession();
            }, 100);
        },

        stopSearch: function() {
            if (!this.isSearching) {
                return;
            }
            
            this.stopRequested = true;
            this.isSearching = false;
            
            // Save progress
            this.saveProgress();
            
            // Update UI
            document.getElementById('searchBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('continueBtn').disabled = false;
            
            // Show status
            const sessionProgress = (this.processedInSession / this.COMBINATIONS_PER_SESSION) * 100;
            let output = document.getElementById('resultOutput').textContent;
            output += `\n‚èπÔ∏è Proses dihentikan (sesi ${this.currentSession}: ${Math.round(sessionProgress)}%). ${this.foundResults.length} rumus ditemukan.\n`;
            document.getElementById('resultOutput').textContent = output;
            
            this.updateProgress();
            this.showNotification('Pencarian dihentikan. Progress telah disimpan.', 'info');
        },

        finishSearch: function() {
            this.isSearching = false;
            this.stopRequested = false;
            
            document.getElementById('searchBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('continueBtn').disabled = true;
            
            const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
            let output = document.getElementById('resultOutput').textContent;
            
            output += `\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
            output += `üèÅ PENCARIAN SELESAI\n`;
            output += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;
            output += `‚è±Ô∏è Waktu: ${elapsed} detik\n`;
            output += `üìä Total diproses: ${this.totalProcessed.toLocaleString()}\n`;
            output += `üéØ Rumus ditemukan: ${this.foundResults.length}\n`;
            output += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;
            
            if (this.foundResults.length > 0) {
                output += `üèÜ RUMUS TERBAIK:\n`;
                this.foundResults.sort((a, b) => {
                    if (a.patah !== b.patah) return a.patah - b.patah;
                    return b.accuracy - a.accuracy;
                });
                
                const best = this.foundResults[0];
                output += `üìù Formula: ${best.fullFormula}\n`;
                output += `üéØ Target: ${this.getTargetTypeName(best.targetType)}\n`;
                output += `‚úÖ ${best.hits}/${best.attempts} | ‚ùå ${best.patah}x\n`;
                output += `üìà Akurasi: ${(best.accuracy * 100).toFixed(1)}%\n`;
            } else {
                output += `üòû TIDAK ADA RUMUS YANG MEMENUHI KRITERIA\n`;
                output += `üí° Coba kurangi "Hari Prediksi" atau tambah digit prediksi.\n`;
            }
            
            document.getElementById('resultOutput').textContent = output;
            
            localStorage.removeItem('prediksi_progress');
            this.showNotification('Pencarian selesai! ' + this.foundResults.length + ' rumus ditemukan.', 'success');
        },

        // ========== RESULT DISPLAY ==========
        displayResult: function(result) {
            const suffix = this.getSuffixForTargetType(result.targetType);
            
            let output = document.getElementById('resultOutput').textContent;
            
            const resultNumber = this.foundResults.length;
            
            let resultText = `\nüéØ HASIL #${resultNumber}\n`;
            resultText += `Target: ${this.getTargetTypeName(result.targetType)}\n\n`;
            
            // Show previous predictions
            for (let i = 0; i < result.predictions.length; i++) {
                const p = result.predictions[i];
                const mark = p.hit ? ` ${suffix} ‚úÖ` : ` ${suffix} ‚ùå`;
                resultText += `${p.input} = ${p.prediction}${mark}\n`;
            }
            
            const lastIndex = this.dataHistory.length - 1;
            const currentInput = this.dataHistory[lastIndex];
            let latestPrediction = '?';
            let actualTarget = '?';
            let nextMark = ` ${suffix} ‚ùå`;
            
            try {
                const ai = this.calculateAI(result.aiFormula, lastIndex, this.dataHistory);
                const rotation = this.generateRotation(ai);
                const pred = this.applyPatternToRotation(rotation, result.pattern);
                latestPrediction = pred;
                
                // FIND NEXT DATA FOR VERIFICATION
                if (lastIndex + 1 < this.dataHistory.length) {
                    const nextData = this.dataHistory[lastIndex + 1];
                    actualTarget = this.getTargetDigits(nextData, result.targetType);
                    
                    // CHECK IF PREDICTION IS CORRECT
                    const check = this.checkPrediction(pred, actualTarget, result.targetType);
                    
                    if (check.hit) {
                        nextMark = ` ${suffix} ‚úÖ`;
                    } else {
                        nextMark = ` ${suffix} ‚ùå`;
                    }
                    
                    // UPDATE STATISTICS
                    result.attempts += 1;
                    if (check.hit) {
                        result.hits += 1;
                    } else {
                        result.patah += 1;
                    }
                    result.accuracy = result.hits / result.attempts;
                } else {
                    // IF NO NEXT DATA (FUTURE PREDICTION)
                    actualTarget = pred;
                    nextMark = ` ${suffix} ‚úÖ`;
                }
                
                resultText += `${currentInput} = ${pred}${nextMark}\n`;
                
            } catch (e) {
                resultText += `${currentInput} = ? ${suffix} ‚ùå\n`;
            }
            
            resultText += `======\n`;
            resultText += `${result.fullFormula}\n`;
            resultText += `‚úÖ ${result.hits}/${result.attempts} | ‚ùå ${result.patah}x\n\n`;
            
            output += resultText;
            document.getElementById('resultOutput').textContent = output;
            
            // Save data for copy
            result.copyData = [];
            
            for (let i = 0; i < result.predictions.length; i++) {
                const p = result.predictions[i];
                const status = p.hit ? suffix : 'x';
                result.copyData.push(`${p.input} = ${p.prediction} ${status}`);
            }
            
            if (latestPrediction !== '?') {
                const copyStatus = (lastIndex + 1 < this.dataHistory.length) ? 
                    (nextMark.includes('‚úÖ') ? suffix : 'x') : suffix;
                result.copyData.push(`${currentInput} = ${latestPrediction} ${copyStatus}`);
            }
            
            // Scroll to bottom
            const resultBox = document.getElementById('resultOutput');
            resultBox.scrollTop = resultBox.scrollHeight;
        },

        // ========== UI UPDATES ==========
        updateProgress: function() {
            const progress = (this.totalProcessed / this.totalCombinations) * 100;
            document.getElementById('progressFill').style.width = `${Math.min(progress, 100)}%`;
            document.getElementById('progressPercent').textContent = `${Math.round(progress)}%`;
            
            const sessionProgress = (this.processedInSession / this.COMBINATIONS_PER_SESSION) * 100;
            
            const statusDiv = document.getElementById('statusInfo');
            let html = '';
            
            if (this.isSearching) {
                html += `
                    <div class="info-line">
                        <span class="info-label">Sesi:</span>
                        <span class="info-value">${this.currentSession}/${this.totalSessions}</span>
                    </div>
                    <div class="info-line">
                        <span class="info-label">Progress Sesi:</span>
                        <span class="info-value">${Math.round(sessionProgress)}%</span>
                    </div>
                    <div class="info-line">
                        <span class="info-label">Total Progress:</span>
                        <span class="info-value">${Math.round(progress)}%</span>
                    </div>
                    <div class="info-line">
                        <span class="info-label">Ditemukan:</span>
                        <span class="info-value info-success">${this.foundResults.length} rumus</span>
                    </div>
                    <div class="info-line">
                        <span class="info-label">Diproses:</span>
                        <span class="info-value">${this.totalProcessed.toLocaleString()}</span>
                    </div>
                `;
                
                if (performance && performance.memory) {
                    const mem = performance.memory;
                    const usedMB = Math.round(mem.usedJSHeapSize / (1024 * 1024));
                    const totalMB = Math.round(mem.jsHeapSizeLimit / (1024 * 1024));
                    const memoryPercent = Math.round((usedMB / totalMB) * 100);
                    
                    html += `
                        <div class="info-line">
                            <span class="info-label">Memory:</span>
                            <span class="info-value ${memoryPercent > 70 ? 'info-warning' : ''}">
                                ${usedMB}MB / ${totalMB}MB (${memoryPercent}%)
                            </span>
                        </div>
                    `;
                }
                
                if (document.getElementById('autoContinue').checked) {
                    html += `
                        <div class="info-line">
                            <span class="info-label">Mode:</span>
                            <span class="info-value info-success">AUTO-CONTINUE</span>
                        </div>
                    `;
                }
                
            } else {
                html += `
                    <div class="info-line">
                        <span class="info-label">Status:</span>
                        <span class="info-value">Siap</span>
                    </div>
                    <div class="info-line">
                        <span class="info-label">Data:</span>
                        <span class="info-value">${this.dataHistory.length} angka</span>
                    </div>
                    <div class="info-line">
                        <span class="info-label">Hasil Tersimpan:</span>
                        <span class="info-value">${this.foundResults.length} rumus</span>
                    </div>
                `;
            }
            
            statusDiv.innerHTML = html;
        },

        updateStatusInfo: function() {
            if (!this.isSearching) {
                const input = document.getElementById('inputNumbers').value.trim();
                const lines = input.split('\n').map(l => l.trim()).filter(l => /^\d{4}$/.test(l));
                const dataCount = lines.length;
                
                const daysToPredict = parseInt(document.getElementById('daysToPredict').value) || 16;
                const digitCount = parseInt(document.getElementById('digitCount').value) || 3;
                const patah = document.getElementById('patahLimit').value;
                const targetType = document.getElementById('targetType').value;
                const searchMode = document.getElementById('searchMode').value;
                
                let html = `
                    <div class="info-line">
                        <span class="info-label">Data Tersedia:</span>
                        <span class="info-value">${dataCount} angka</span>
                    </div>
                    <div class="info-line">
                        <span class="info-label">Hari Prediksi:</span>
                        <span class="info-value">${daysToPredict} hari</span>
                    </div>
                    <div class="info-line">
                        <span class="info-label">Target:</span>
                        <span class="info-value">${this.getTargetTypeName(targetType)}</span>
                    </div>
                    <div class="info-line">
                        <span class="info-label">Batas Patah:</span>
                        <span class="info-value">${patah === '' ? '0' : patah}x</span>
                    </div>
                    <div class="info-line">
                        <span class="info-label">Mode Pencarian:</span>
                        <span class="info-value">${searchMode === 'full' ? 'LENGKAP' : 'CEPAT'}</span>
                    </div>
                `;
                
                if (this.foundResults.length > 0) {
                    html += `
                        <div class="info-line">
                            <span class="info-label info-success">Hasil Tersimpan:</span>
                            <span class="info-value info-success">${this.foundResults.length} rumus</span>
                        </div>
                    `;
                }
                
                document.getElementById('statusInfo').innerHTML = html;
            }
        },

        // ========== DATA MANAGEMENT ==========
        cleanupMemory: function() {
            if (window.gc) {
                try { window.gc(); } catch(e) {}
            }
        },

        autoSaveInput: function() {
            const inputData = document.getElementById('inputNumbers').value;
            if (inputData.trim()) {
                localStorage.setItem('prediksi_input', inputData);
            }
        },

        saveProgress: function() {
            if (this.foundResults.length === 0 && this.totalProcessed === 0) return;
            
            const progressData = {
                version: '2.1',
                timestamp: Date.now(),
                dataHistory: this.dataHistory,
                aiFormulas: this.aiFormulas,
                allPatterns: this.allPatterns,
                foundResults: this.foundResults.map(r => ({
                    fullFormula: r.fullFormula,
                    aiFormula: r.aiFormula,
                    pattern: r.pattern,
                    targetType: r.targetType,
                    hits: r.hits,
                    attempts: r.attempts,
                    patah: r.patah,
                    accuracy: r.accuracy,
                    copyData: r.copyData
                })),
                uniqueAIFormulas: Array.from(this.uniqueAIFormulas),
                currentSession: this.currentSession,
                processedInSession: this.processedInSession,
                totalProcessed: this.totalProcessed,
                totalCombinations: this.totalCombinations,
                currentFormulaIndex: this.currentFormulaIndex,
                currentPatternIndex: this.currentPatternIndex,
                settings: {
                    daysToPredict: document.getElementById('daysToPredict').value,
                    digitCount: document.getElementById('digitCount').value,
                    patah: document.getElementById('patahLimit').value,
                    targetType: document.getElementById('targetType').value,
                    searchMode: document.getElementById('searchMode').value,
                    autoContinue: document.getElementById('autoContinue').checked
                }
            };
            
            try {
                const jsonString = JSON.stringify(progressData);
                localStorage.setItem('prediksi_progress', jsonString);
            } catch (e) {
                console.warn('Gagal menyimpan progress:', e);
            }
        },

        loadProgress: function() {
            const saved = localStorage.getItem('prediksi_progress');
            
            if (!saved) {
                // Load saved input data
                const savedInput = localStorage.getItem('prediksi_input');
                if (savedInput) {
                    document.getElementById('inputNumbers').value = savedInput;
                    this.updateDataCount();
                }
                return false;
            }
            
            try {
                const progressData = JSON.parse(saved);
                
                if (progressData.version !== '2.1') {
                    console.warn('Versi data tidak kompatibel');
                    return false;
                }
                
                // Restore all data
                this.dataHistory = progressData.dataHistory || [];
                this.aiFormulas = progressData.aiFormulas || [];
                this.allPatterns = progressData.allPatterns || [];
                this.foundResults = progressData.foundResults || [];
                this.uniqueAIFormulas = new Set(progressData.uniqueAIFormulas || []);
                this.currentSession = progressData.currentSession || 0;
                this.processedInSession = progressData.processedInSession || 0;
                this.totalProcessed = progressData.totalProcessed || 0;
                this.totalCombinations = progressData.totalCombinations || 0;
                this.currentFormulaIndex = progressData.currentFormulaIndex || 0;
                this.currentPatternIndex = progressData.currentPatternIndex || 0;
                
                // Restore settings
                if (progressData.settings) {
                    document.getElementById('daysToPredict').value = progressData.settings.daysToPredict || '16';
                    document.getElementById('digitCount').value = progressData.settings.digitCount || '3';
                    document.getElementById('patahLimit').value = progressData.settings.patah || '';
                    document.getElementById('targetType').value = progressData.settings.targetType || 'KE';
                    document.getElementById('searchMode').value = progressData.settings.searchMode || 'full';
                    document.getElementById('autoContinue').checked = progressData.settings.autoContinue || false;
                }
                
                // Restore UI
                document.getElementById('dataCount').textContent = this.dataHistory.length;
                document.getElementById('foundCount').textContent = this.foundResults.length;
                document.getElementById('processedCount').textContent = this.totalProcessed.toLocaleString();
                document.getElementById('formulaCount').textContent = this.totalCombinations.toLocaleString();
                
                // Update progress bar
                const progress = (this.totalProcessed / this.totalCombinations) * 100;
                document.getElementById('progressFill').style.width = `${Math.min(progress, 100)}%`;
                document.getElementById('progressPercent').textContent = `${Math.round(progress)}%`;
                
                // Display loaded results
                this.displayLoadedResults();
                
                this.updateStatusInfo();
                
                // Show notification
                const date = new Date(progressData.timestamp).toLocaleString();
                this.showNotification(`Progress ditemukan (tersimpan: ${date})`, 'info');
                
                return true;
                
            } catch (error) {
                console.error('Error loading progress:', error);
                localStorage.removeItem('prediksi_progress');
                return false;
            }
        },

        displayLoadedResults: function() {
            let output = `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
            output += `üíæ PROGRESS DIMUAT\n`;
            output += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;
            output += `üìä Data: ${this.dataHistory.length} angka\n`;
            output += `üìà Sesi: ${this.currentSession}\n`;
            output += `‚öôÔ∏è Diproses: ${this.totalProcessed.toLocaleString()}\n`;
            output += `üéØ Ditemukan: ${this.foundResults.length} rumus\n`;
            output += `üìä Progress: ${Math.round((this.totalProcessed / this.totalCombinations) * 100)}%\n`;
            output += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;
            
            // Show 5 best results
            if (this.foundResults.length > 0) {
                output += `üèÜ HASIL TERBAIK YANG TERSIMPAN:\n`;
                const bestResults = [...this.foundResults]
                    .sort((a, b) => {
                        if (a.patah !== b.patah) return a.patah - b.patah;
                        return b.accuracy - a.accuracy;
                    })
                    .slice(0, 5);
                
                bestResults.forEach((result, index) => {
                    output += `${index + 1}. ${result.fullFormula}\n`;
                    output += `   Target: ${this.getTargetTypeName(result.targetType)}\n`;
                    output += `   ‚úÖ ${result.hits}/${result.attempts} | ‚ùå ${result.patah}x\n\n`;
                });
            }
            
            document.getElementById('resultOutput').textContent = output;
        },

        // ========== UI CONTROLS ==========
        clearAllData: function() {
            if (this.isSearching) {
                this.showNotification('Hentikan proses terlebih dahulu!', 'warning');
                return;
            }
            
            if (!confirm('Hapus SEMUA data dan hasil?')) return;
            
            document.getElementById('inputNumbers').value = '';
            document.getElementById('resultOutput').textContent = '';
            
            document.getElementById('dataCount').textContent = '0';
            document.getElementById('formulaCount').textContent = '0';
            document.getElementById('processedCount').textContent = '0';
            document.getElementById('foundCount').textContent = '0';
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('progressPercent').textContent = '0%';
            
            document.getElementById('daysToPredict').value = '16';
            document.getElementById('digitCount').value = '3';
            document.getElementById('patahLimit').value = '';
            document.getElementById('targetType').value = 'KE';
            document.getElementById('searchMode').value = 'full';
            document.getElementById('autoContinue').checked = false;
            
            this.resetSearchState();
            this.updateStatusInfo();
            
            localStorage.removeItem('prediksi_progress');
            localStorage.removeItem('prediksi_input');
            
            this.showNotification('Semua data telah dihapus.', 'info');
        },

        clearOutput: function() {
            if (this.isSearching) {
                this.showNotification('Hentikan proses terlebih dahulu!', 'warning');
                return;
            }
            
            if (!confirm('Hapus semua hasil output?')) return;
            
            document.getElementById('resultOutput').textContent = '';
            this.showNotification('Output telah dihapus.', 'info');
        },

        copyOutput: function() {
            let copyText = '';
            
            for (let i = 0; i < this.foundResults.length; i++) {
                const result = this.foundResults[i];
                
                if (result.copyData) {
                    if (i > 0) copyText += '\n\n';
                    
                    const suffix = this.getSuffixForTargetType(result.targetType);
                    
                    const updatedCopyData = result.copyData.map(line => {
                        return line.replace(/\s+(a|c|k|e|j|ac|ck|ai|cb|x|‚úÖ|‚ùå)$/, ` ${suffix}`) + 
                               (line.includes('‚úÖ') ? ' ‚úÖ' : line.includes('‚ùå') ? ' ‚ùå' : '');
                    });
                    
                    copyText += updatedCopyData.join('\n') + '\n';
                }
                
                copyText += `======\n`;
                copyText += `${result.fullFormula}\n`;
            }
            
            if (!copyText) {
                copyText = document.getElementById('resultOutput').textContent;
            }
            
            navigator.clipboard.writeText(copyText).then(() => {
                this.showNotification('Output berhasil disalin ke clipboard!', 'success');
            }).catch(() => {
                const ta = document.createElement('textarea');
                ta.value = copyText;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                this.showNotification('Output berhasil disalin ke clipboard!', 'success');
            });
        },

        // ========== NOTIFICATION SYSTEM ==========
        showNotification: function(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification';
            notification.classList.add(type);
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        },

        // ========== PAGE EVENT HANDLERS ==========
        handleVisibilityChange: function() {
            if (document.hidden && this.isSearching) {
                this.saveProgress();
                if (this.isSearching) {
                    this.stopSearch();
                    this.showNotification('Progress otomatis disimpan (pindah tab/ minimize)', 'info');
                }
            }
        },

        handleBeforeUnload: function(event) {
            if (this.isSearching) {
                this.saveProgress();
                event.preventDefault();
                event.returnValue = 'Progress sedang berjalan. Tutup halaman?';
            }
        },

        // ========== RESET STATE ==========
        resetSearchState: function() {
            this.dataHistory = [];
            this.aiFormulas = [];
            this.allPatterns = [];
            this.foundResults = [];
            this.uniqueAIFormulas.clear();
            this.isSearching = false;
            this.stopRequested = false;
            this.currentPatahLimit = 0;
            this.totalCombinations = 0;
            this.currentSession = 0;
            this.totalSessions = 0;
            this.processedInSession = 0;
            this.totalProcessed = 0;
            this.currentFormulaIndex = 0;
            this.currentPatternIndex = 0;
        }
    };

    // =============================================
    // GLOBAL FUNCTION WRAPPERS
    // =============================================
    function startSearch() { RumusOtomatis.startSearch(); }
    function stopSearch() { RumusOtomatis.stopSearch(); }
    function continueSearch() { RumusOtomatis.continueSearch(); }
    function clearAllData() { RumusOtomatis.clearAllData(); }
    function clearOutput() { RumusOtomatis.clearOutput(); }
    function copyOutput() { RumusOtomatis.copyOutput(); }

    // =============================================
    // INITIALIZATION
    // =============================================
    document.addEventListener('DOMContentLoaded', function() {
        RumusOtomatis.init();
        
        // Auto-save input data
        setInterval(() => RumusOtomatis.autoSaveInput(), 10000);
        
        // Page visibility change handler
        document.addEventListener('visibilitychange', () => RumusOtomatis.handleVisibilityChange());
        
        // Before page unload
        window.addEventListener('beforeunload', (e) => RumusOtomatis.handleBeforeUnload(e));
        
        // Welcome message
        setTimeout(() => {
            const firstVisit = !localStorage.getItem('rumus_otomatis_visited');
            if (firstVisit) {
                RumusOtomatis.showNotification('Selamat datang di Rumus Otomatis!', 'info');
                localStorage.setItem('rumus_otomatis_visited', 'true');
            }
        }, 1000);
    });
    </script>
</body>
</html>
