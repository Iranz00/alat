<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Key Kalkulator Multi Rumus - RAN</title>
<style>
/* CSS - Tetap sama */
* { 
    margin:0; 
    padding:0; 
    box-sizing:border-box; 
}
body { 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
    min-height:100vh; 
    padding:20px;
    display: flex;
    align-items: flex-start;
    justify-content: center;
}
.container { 
    max-width:1200px; 
    width:100%;
    margin:0 auto; 
    background:white; 
    border-radius:20px; 
    padding:30px; 
    box-shadow:0 20px 40px rgba(0,0,0,0.15);
}
.header { 
    text-align:center; 
    margin-bottom:25px; 
}
h1 { 
    color:#2d3748; 
    margin-bottom:8px; 
    font-size:2.2rem;
    font-weight:700;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}
.subtitle { 
    text-align:center; 
    color:#718096; 
    font-size:15px; 
    margin-bottom:25px;
    line-height:1.5;
}
.grid-container { 
    display:grid; 
    grid-template-columns:1fr 1fr; 
    gap:25px; 
    margin-bottom:25px;
}
.input-section, .output-section { 
    background:#f8f9fa; 
    padding:25px; 
    border-radius:15px; 
    border:2px solid #e9ecef;
    box-shadow: 0 5px 15px rgba(0,0,0,0.08);
}
.section-title { 
    color:#2d3748; 
    margin-bottom:20px; 
    font-size:18px; 
    font-weight:bold;
    display: flex;
    align-items: center;
    gap: 8px;
}
.data-input { 
    margin-bottom:20px;
}
.data-input textarea { 
    width:100%; 
    height:200px; 
    padding:15px; 
    border:2px solid #e2e8f0; 
    border-radius:12px; 
    font-size:15px; 
    resize:vertical; 
    margin-bottom:10px;
    font-family: 'Courier New', monospace;
    transition: all 0.3s ease;
    background: white;
}
.data-input textarea:focus { 
    border-color:#667eea; 
    outline:none;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}
.formula-display {
    background: #1a202c;
    color: #e2e8f0;
    padding: 15px;
    border-radius: 12px;
    font-family: 'Courier New', monospace;
    margin-bottom: 20px;
    border: 2px solid #2d3748;
    font-size: 14px;
    text-align: left;
    max-height: 150px;
    overflow-y: auto;
}
.button-group { 
    display:flex; 
    gap:12px; 
    margin-bottom:20px;
}
button { 
    padding:15px; 
    border:none; 
    border-radius:12px; 
    font-size:15px; 
    font-weight:600; 
    cursor:pointer; 
    transition:all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}
.btn-calculate { 
    background:linear-gradient(135deg, #4CAF50, #45a049);
    color:white;
    box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
}
.btn-clear { 
    background:linear-gradient(135deg, #ff6b6b, #ee5a52);
    color:white;
    box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
}
.btn-copy { 
    background:linear-gradient(135deg, #2196F3, #1976D2);
    color:white;
    box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
}
.btn-calculate:hover, .btn-clear:hover, .btn-copy:hover { 
    transform:translateY(-2px);
    box-shadow:0 6px 20px rgba(0,0,0,0.15);
}
.info { 
    background:#e3f2fd; 
    padding:18px; 
    border-radius:12px; 
    margin-bottom:20px; 
    text-align:center;
    font-weight:500;
    border-left:4px solid #2196F3;
    transition: all 0.3s ease;
}
.info.success {
    background:#e8f5e8;
    border-left-color:#4CAF50;
    color:#2e7d32;
}
.info.error {
    background:#ffebee;
    border-left-color:#f44336;
    color:#c62828;
}
.input-info { 
    text-align:center; 
    color:#718096; 
    font-size:13px; 
    margin-bottom:15px;
    font-weight: 500;
}
.result-box { 
    background:#1a202c; 
    color:#e2e8f0; 
    padding:25px; 
    border-radius:12px; 
    font-family:'Courier New',monospace; 
    min-height:200px; 
    white-space:pre-wrap; 
    line-height:1.6;
    border:1px solid #2d3748;
    font-size:14px;
    overflow-y: auto;
    max-height: 400px;
    position: relative;
}
.result-box::-webkit-scrollbar {
    width:8px;
}
.result-box::-webkit-scrollbar-track {
    background:#2d3748;
    border-radius:4px;
}
.result-box::-webkit-scrollbar-thumb {
    background:#4a5568;
    border-radius:4px;
}
.result-box::-webkit-scrollbar-thumb:hover {
    background:#718096;
}
.copy-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #4CAF50;
    color: white;
    padding: 15px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1000;
    transform: translateX(150%);
    transition: transform 0.3s ease;
}
.copy-notification.show {
    transform: translateX(0);
}
.formula-label {
    color: #a0aec0;
    font-size: 12px;
    margin-bottom: 5px;
    text-align: center;
}
.history-info {
    background: #e8f5e8;
    padding: 10px 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    font-size: 12px;
    color: #2e7d32;
    text-align: center;
    border-left: 4px solid #4CAF50;
}
.formula-item {
    margin-bottom: 5px;
    padding: 3px 0;
}
.formula-index {
    color: #FFD700;
    font-weight: bold;
}
@media (max-width: 768px) {
    .container {
        padding:20px;
    }
    .grid-container {
        grid-template-columns: 1fr;
        gap: 20px;
    }
}
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üîÆ KEY KALKULATOR FLEKSIBEL</h1>
        <div class="subtitle">Support 1-7 posisi, 1-5 digit, Xx/Xxx/Xxxx, warisan highlight</div>
    </div>

    <div class="grid-container">
        <div class="input-section">
            <div class="data-input">
                <textarea id="inputData" placeholder="Format fleksibel:
1. Single: 5902 = 59 e
2. Multi: 3872 = 68 . 06 . 04 . 83 ai
3. X value: 8221 = Xx . 591 ai
4. Support 1-7 posisi (berdasarkan jumlah titik)
5. Support 1-5 digit per posisi
6. Suffix bebas: e/k/a/ai
======
Rumus sesuai jumlah posisi (1-7 rumus)
Tipe data: A,C,K,E,J,Js,J3D,J4D
Contoh: A3mb-Js5m9.(ty)"></textarea>
                <div class="input-info" id="inputInfo">0 angka + 0 rumus terdeteksi</div>
            </div>
            
            <div class="formula-label">Rumus Terdeteksi:</div>
            <div class="formula-display" id="detectedFormula">Tidak ada rumus</div>
            
            <div class="history-info" id="historyInfo">Deteksi otomatis jumlah posisi dan rumus</div>
            
            <div class="button-group">
                <button class="btn-calculate" onclick="calculateFormula()">üßÆ HITUNG RUMUS</button>
                <button class="btn-clear" onclick="clearAll()">üóëÔ∏è HAPUS SEMUA</button>
            </div>
            
            <div class="info" id="info">Masukkan data, program auto-detect jumlah posisi berdasarkan titik (.)</div>
        </div>

        <div class="output-section">
            <div class="section-title">üì§ HASIL OUTPUT</div>
            <div class="result-box" id="resultOutput">// Output akan muncul di sini
// Format dipisah per rumus
// 
// === RUMUS 1 (POSISI 1) ===
// 3872 = 68 . 0123456789 ai
// ...
// ======
// A7mb+E7ty.(mb)
// 
// === RUMUS 2 (POSISI 2) ===
// 3872 = 06 . 0123456789 ai
// ...
// ======
// A8mb+C4.(mb)
// 
// ... dst untuk setiap rumus</div>
            <br>
            <div class="button-group">
                <button class="btn-copy" onclick="copyOutput()">üìã SALIN OUTPUT</button>
            </div>
        </div>
    </div>
</div>

<div class="copy-notification" id="copyNotification">
    ‚úÖ Output berhasil disalin ke clipboard!
</div>

<script>
// TABEL KONVERSI
const mistikTables = {
    'IX': {'0':'5', '1':'6', '2':'7', '3':'8', '4':'9', '5':'0', '6':'1', '7':'2', '8':'3', '9':'4'},
    'TY': {'0':'7', '1':'4', '2':'9', '3':'6', '4':'1', '5':'8', '6':'3', '7':'0', '8':'5', '9':'2'},
    'ML': {'0':'1', '1':'0', '2':'5', '3':'8', '4':'7', '5':'2', '6':'9', '7':'4', '8':'3', '9':'6'},
    'MB': {'0':'8', '1':'7', '2':'6', '3':'9', '4':'5', '5':'4', '6':'2', '7':'1', '8':'0', '9':'3'},
    'M0': {'0':'6', '1':'5', '2':'8', '3':'7', '4':'9', '5':'1', '6':'0', '7':'2', '8':'3', '9':'4'},
    'M1': {'0':'1', '1':'0', '2':'9', '3':'8', '4':'7', '5':'6', '6':'5', '7':'4', '8':'3', '9':'2'},
    'M2': {'0':'2', '1':'8', '2':'0', '3':'9', '4':'7', '5':'6', '6':'5', '7':'4', '8':'1', '9':'3'},
    'M3': {'0':'3', '1':'2', '2':'1', '3':'0', '4':'9', '5':'8', '6':'7', '7':'6', '8':'5', '9':'4'},
    'M4': {'0':'6', '1':'5', '2':'3', '3':'2', '4':'7', '5':'1', '6':'0', '7':'4', '8':'9', '9':'8'},
    'M5': {'0':'5', '1':'4', '2':'3', '3':'2', '4':'1', '5':'0', '6':'9', '7':'8', '8':'7', '9':'6'},
    'M6': {'0':'6', '1':'8', '2':'4', '3':'5', '4':'2', '5':'3', '6':'0', '7':'9', '8':'1', '9':'7'},
    'M7': {'0':'7', '1':'6', '2':'5', '3':'4', '4':'3', '5':'2', '6':'1', '7':'0', '8':'9', '9':'8'},
    'M8': {'0':'8', '1':'7', '2':'6', '3':'5', '4':'9', '5':'3', '6':'1', '7':'2', '8':'0', '9':'4'},
    'M9': {'0':'9', '1':'8', '2':'7', '3':'6', '4':'5', '5':'4', '6':'3', '7':'2', '8':'1', '9':'0'},
    'M10': {'0':'4', '1':'2', '2':'1', '3':'8', '4':'0', '5':'6', '6':'5', '7':'9', '8':'3', '9':'7'},
    'M11': {'0':'1', '1':'0', '2':'5', '3':'4', '4':'3', '5':'2', '6':'8', '7':'9', '8':'6', '9':'7'},
    'M12': {'0':'2', '1':'7', '2':'3', '3':'8', '4':'6', '5':'9', '6':'4', '7':'1', '8':'0', '9':'5'},
    'M13': {'0':'3', '1':'9', '2':'7', '3':'0', '4':'1', '5':'8', '6':'4', '7':'2', '8':'5', '9':'6'},
    'M14': {'0':'6', '1':'5', '2':'4', '3':'7', '4':'2', '5':'1', '6':'0', '7':'3', '8':'9', '9':'8'},
    'M15': {'0':'5', '1':'6', '2':'4', '3':'9', '4':'2', '5':'0', '6':'1', '7':'8', '8':'7', '9':'3'},
    'M16': {'0':'3', '1':'8', '2':'7', '3':'0', '4':'9', '5':'6', '6':'5', '7':'2', '8':'1', '9':'4'},
    'M17': {'0':'9', '1':'4', '2':'8', '3':'6', '4':'1', '5':'7', '6':'3', '7':'5', '8':'2', '9':'0'},
    'M18': {'0':'8', '1':'9', '2':'7', '3':'4', '4':'3', '5':'6', '6':'5', '7':'2', '8':'0', '9':'1'},
    'M19': {'0':'7', '1':'8', '2':'3', '3':'2', '4':'9', '5':'6', '6':'5', '7':'0', '8':'1', '9':'4'}
};

// Data global
let dataHistory = [];
let currentFormulas = [];
let maxPositions = 0;
let lastHighlights = [];

// ==================== FUNGSI UTAMA ====================

function calculateFormula() {
    const inputData = document.getElementById('inputData').value.trim();
    
    if (!inputData) {
        showInfo('Masukkan data terlebih dahulu!', 'error');
        return;
    }
    
    try {
        // Parse input
        parseInputData(inputData);
        
        if (currentFormulas.length === 0) {
            showInfo('Tidak ada rumus ditemukan!', 'error');
            return;
        }
        
        // Validasi jumlah rumus = jumlah posisi
        if (currentFormulas.length !== maxPositions) {
            showInfo(`Ditemukan ${maxPositions} posisi, butuh ${maxPositions} rumus. Ada ${currentFormulas.length} rumus.`, 'error');
            return;
        }
        
        // Generate output
        displayAllFormulaResults();
        showInfo(`Perhitungan berhasil! ${maxPositions} posisi, ${currentFormulas.length} rumus diproses`, 'success');
        
    } catch (error) {
        showInfo(`Error: ${error.message}`, 'error');
        console.error('Calculation error:', error);
    }
}

// ==================== PARSING INPUT ====================

function parseInputData(inputData) {
    dataHistory = [];
    currentFormulas = [];
    maxPositions = 0;
    lastHighlights = [];
    
    const lines = inputData.split('\n').map(l => l.trim()).filter(l => l);
    let foundSeparator = false;
    
    for (let line of lines) {
        if (line === '======' || line.startsWith('======')) {
            foundSeparator = true;
            continue;
        }
        
        if (foundSeparator) {
            // Parse rumus (normalize minus)
            const formula = normalizeFormula(line);
            if (formula) currentFormulas.push(formula);
            continue;
        }
        
        // Parse data angka
        const parsed = parseDataLine(line);
        if (parsed) {
            dataHistory.push(parsed);
            if (parsed.positionCount > maxPositions) {
                maxPositions = parsed.positionCount;
            }
        }
    }
    
    // Reverse dataHistory: index 0 = terbaru (paling bawah)
    dataHistory = dataHistory.reverse();
    
    // Update UI
    updateFormulaDisplay();
    updateInputInfo();
    
    document.getElementById('historyInfo').textContent = 
        `Deteksi: ${maxPositions} posisi, ${currentFormulas.length} rumus, ${dataHistory.length} data`;
    
    return { dataHistory, currentFormulas, maxPositions };
}

function parseDataLine(line) {
    // Pattern fleksibel: XXXX = value (dengan/tanpa suffix)
    const match = line.match(/^(\d{4})\s*=\s*(.*?)(?:\s+([a-zA-Z]{1,2}))?$/);
    if (!match) return null;
    
    const number = match[1];
    const valuePart = match[2].trim();
    const suffix = match[3] || 'ai';
    
    // Split by dots untuk dapat array values
    let rawValues = [];
    if (valuePart !== '') {
        rawValues = valuePart.split(/\s*\.\s*/)
            .map(v => v.trim())
            .filter(v => v !== '');
    }
    
    // Parse masing-masing value
    const values = rawValues.map(parseValue);
    const positionCount = values.length;
    
    // Extract komponen angka
    const as = parseInt(number[0]);
    const cop = parseInt(number[1]);
    const kepala = parseInt(number[2]);
    const ekor = parseInt(number[3]);
    const jumlah = reduceToSingleDigit(kepala + ekor);
    
    return {
        number: number,
        values: values,
        positionCount: positionCount,
        suffix: suffix,
        as: as,
        cop: cop,
        kepala: kepala,
        ekor: ekor,
        jumlah: jumlah,
        js: reduceToSingleDigit(Math.abs(kepala - ekor)),
        j3d: reduceToSingleDigit(cop + kepala + ekor),
        j4d: reduceToSingleDigit(as + cop + kepala + ekor)
    };
}

function parseValue(value) {
    value = value.trim();
    
    // Cek jika semua karakter adalah X/x
    if (/^[Xx]+$/i.test(value)) {
        return {
            type: 'X',
            original: value,
            digitCount: value.length, // 2, 3, 4, 5
            value: null
        };
    }
    
    // Cek jika angka 1-5 digit
    if (/^\d{1,5}$/.test(value)) {
        return {
            type: 'NUMBER',
            original: value,
            digitCount: value.length,
            value: value
        };
    }
    
    // Default null
    return {
        type: 'INVALID',
        value: null
    };
}

function normalizeFormula(formula) {
    // Normalize semua jenis minus ke hyphen
    return formula.replace(/[‚Äì‚àí]/g, '-').trim();
}

// ==================== PERHITUNGAN & HIGHLIGHT YANG BENAR ====================

function displayAllFormulaResults() {
    const output = document.getElementById('resultOutput');
    let allOutput = '';
    
    const positionNames = ['A', 'B', 'C', 'D', 'E', 'F', 'G'];
    lastHighlights = []; // Reset warisan horizontal
    
    for (let i = 0; i < currentFormulas.length; i++) {
        const formula = currentFormulas[i];
        const positionName = positionNames[i] || `POSISI ${i+1}`;
        
        allOutput += `=== RUMUS ${i+1} (${positionName}) ===\n`;
        
        // Ambil warisan horizontal dari posisi sebelumnya
        const horizontalInheritance = lastHighlights[i-1] || null;
        
        allOutput += generateOutputForFormula(formula, i, horizontalInheritance);
        
        if (i < currentFormulas.length - 1) {
            allOutput += '\n\n';
        }
    }
    
    output.innerHTML = allOutput;
}

function generateOutputForFormula(formula, positionIndex, horizontalInheritance) {
    let output = '';
    let verticalInheritance = horizontalInheritance; // Mulai dari warisan horizontal
    
    for (let i = 0; i < dataHistory.length; i++) {
        const data = dataHistory[i];
        const suffix = data.suffix;
        
        // Ambil value untuk posisi ini (isi dengan null jika tidak ada)
        let value = null;
        if (positionIndex < data.values.length) {
            value = data.values[positionIndex];
        }
        
        // Hitung dengan rumus
        const calculatedAI = calculateSingleAI(formula, i);
        
        // Format dengan highlight YANG BENAR
        const formatted = formatWithHighlightCorrect(
            calculatedAI,
            value,
            verticalInheritance
        );
        
        output += `${data.number} = ${formatted.displayed} ${suffix}\n`;
        verticalInheritance = formatted.highlightPositions;
    }
    
    // Simpan highlight terakhir untuk warisan horizontal ke posisi berikutnya
    lastHighlights[positionIndex] = verticalInheritance;
    
    output += '======\n';
    output += formula;
    
    return output;
}

// FUNGSI HIGHLIGHT YANG BENAR
function formatWithHighlightCorrect(calculatedAI, inputValue, inheritedPositions) {
    // Buat rotasi 0-9 dimulai dari calculatedAI
    const rotated = generateRotation(calculatedAI);
    
    // Tentukan highlight positions dengan LOGIKA YANG BENAR
    let highlightPositions = null;
    let highlightedValue = '';
    
    // CASE 1: Ada input angka eksplisit
    if (inputValue && inputValue.type === 'NUMBER' && inputValue.value) {
        highlightPositions = [];
        for (let digit of inputValue.value) {
            const pos = rotated.indexOf(digit);
            if (pos !== -1 && !highlightPositions.includes(pos)) {
                highlightPositions.push(pos);
            }
        }
        highlightPositions.sort((a, b) => a - b);
        highlightedValue = inputValue.value;
    }
    // CASE 2: Ada input X
    else if (inputValue && inputValue.type === 'X') {
        const xCount = Math.min(inputValue.digitCount, 5);
        
        // Jika ada warisan, pakai warisan
        if (inheritedPositions) {
            highlightPositions = inheritedPositions.slice(0, xCount);
            highlightedValue = highlightPositions.map(pos => rotated[pos]).join('');
        } 
        // Jika tidak ada warisan, buat dari calculatedAI (ambil digit pertama)
        else {
            highlightPositions = [];
            for (let i = 0; i < xCount; i++) {
                highlightPositions.push(i);
            }
            highlightedValue = rotated.substring(0, xCount);
        }
    }
    // CASE 3: Tidak ada input tapi ada warisan
    else if (inheritedPositions) {
        highlightPositions = [...inheritedPositions];
        highlightedValue = highlightPositions.map(pos => rotated[pos]).join('');
    }
    // CASE 4: Tidak ada input dan tidak ada warisan -> tidak ada highlight
    
    // Format rotasi dengan highlight
    let formattedRotation = '';
    for (let i = 0; i < rotated.length; i++) {
        if (highlightPositions && highlightPositions.includes(i)) {
            formattedRotation += `<span style="color:#FF6B6B;font-weight:bold">${rotated[i]}</span>`;
        } else {
            formattedRotation += rotated[i];
        }
    }
    
    // Format output akhir
    let finalDisplay = formattedRotation;
    if (highlightedValue) {
        finalDisplay = `${highlightedValue} . ${formattedRotation}`;
    }
    
    return {
        displayed: finalDisplay,
        highlightPositions: highlightPositions,
        highlightedValue: highlightedValue
    };
}

function generateRotation(calculatedAI) {
    const allDigits = '0123456789';
    const startIndex = allDigits.indexOf(calculatedAI.toString());
    let rotated = '';
    
    for (let i = 0; i < allDigits.length; i++) {
        const actualIndex = (startIndex + i) % allDigits.length;
        rotated += allDigits[actualIndex];
    }
    
    return rotated;
}

function calculateSingleAI(formula, currentDayIndex) {
    let workingFormula = formula;
    const finalConversion = workingFormula.match(/\.\((\w+)\)/);
    if (finalConversion) {
        workingFormula = workingFormula.replace(/\.\((\w+)\)/, '');
    }
    
    const components = workingFormula.split(/([+\-])/);
    let total = 0;
    let currentOperator = '+';
    
    for (let i = 0; i < components.length; i++) {
        const component = components[i].trim();
        
        if (component === '+' || component === '-') {
            currentOperator = component;
            continue;
        }
        
        if (component) {
            try {
                const value = processComponentCorrect(component, currentDayIndex);
                
                if (currentOperator === '+') {
                    total += value;
                } else if (currentOperator === '-') {
                    total -= value;
                }
            } catch (error) {
                console.warn(`Skip komponen ${component}: ${error.message}`);
            }
        }
    }
    
    if (total < 0) {
        total = Math.abs(total);
    }
    
    if (finalConversion) {
        const table = finalConversion[1].toUpperCase();
        const converted = convertMistik(total.toString(), table);
        total = parseInt(converted);
    }
    
    return reduceToSingleDigit(total);
}

function processComponentCorrect(component, currentDayIndex) {
    // Match type: A,C,K,E,J,JS,J3D,J4D
    const match = component.match(/^(JS|J3D|J4D|[AKCEJ])(\d+)(\w*)$/i);
    if (!match) {
        throw new Error(`Format komponen tidak valid: ${component}`);
    }
    
    const type = match[1].toUpperCase();
    const dayOffset = parseInt(match[2]);
    const conversion = match[3];
    
    // LOGIKA INDEX YANG BENAR:
    // currentDayIndex = 0 untuk baris PALING BAWAH (terbaru)
    // dayOffset = 1 -> ambil data saat ini (index 0)
    // dayOffset = 2 -> ambil 1 baris sebelumnya (index 1)
    const targetDayIndex = currentDayIndex + (dayOffset - 1);
    
    // Validasi index
    if (targetDayIndex >= dataHistory.length) {
        throw new Error(`Data tidak tersedia untuk ${type}${dayOffset}`);
    }
    
    if (targetDayIndex < 0) {
        throw new Error(`Index tidak valid: ${targetDayIndex}`);
    }
    
    const data = dataHistory[targetDayIndex];
    let value;
    
    switch(type) {
        case 'A': value = data.as; break;
        case 'K': value = data.kepala; break;
        case 'C': value = data.cop; break;
        case 'E': value = data.ekor; break;
        case 'J': value = data.jumlah; break;
        case 'JS': value = data.js; break;
        case 'J3D': value = data.j3d; break;
        case 'J4D': value = data.j4d; break;
        default: throw new Error(`Tipe tidak dikenal: ${type}`);
    }
    
    if (conversion) {
        const table = conversion.toUpperCase();
        value = parseInt(convertMistik(value.toString(), table));
    }
    
    return value;
}

function convertMistik(number, table) {
    if (!mistikTables[table]) {
        throw new Error(`Tabel mistik tidak ditemukan: ${table}`);
    }
    
    const digit = reduceToSingleDigit(parseInt(number)).toString();
    
    if (mistikTables[table][digit] === undefined) {
        throw new Error(`Angka ${digit} tidak ada di tabel ${table}`);
    }
    
    return mistikTables[table][digit];
}

function reduceToSingleDigit(num) {
    let result = num;
    while (result > 9) {
        result = result.toString().split('').reduce((sum, digit) => sum + parseInt(digit), 0);
    }
    return result;
}

// ==================== UI FUNCTIONS ====================

function updateFormulaDisplay() {
    const formulaDisplay = document.getElementById('detectedFormula');
    const positionNames = ['A', 'B', 'C', 'D', 'E', 'F', 'G'];
    
    if (currentFormulas.length === 0) {
        formulaDisplay.textContent = 'Tidak ada rumus';
    } else {
        formulaDisplay.innerHTML = currentFormulas.map((formula, index) => 
            `<div class="formula-item"><span class="formula-index">${positionNames[index] || index+1}:</span> ${formula}</div>`
        ).join('');
    }
}

function updateInputInfo() {
    const input = document.getElementById('inputData').value.trim();
    const lines = input.split('\n').filter(line => line.trim());
    
    let numberCount = 0;
    let formulaCount = 0;
    let foundSeparator = false;
    
    for (let line of lines) {
        if (line.includes('======')) {
            foundSeparator = true;
            continue;
        }
        
        if (!foundSeparator && line.match(/^\d{4}\s*=/)) {
            numberCount++;
        }
        
        if (foundSeparator && line.trim()) {
            formulaCount++;
        }
    }
    
    document.getElementById('inputInfo').textContent = 
        `${numberCount} angka + ${formulaCount} rumus terdeteksi`;
}

function copyOutput() {
    const outputElement = document.getElementById('resultOutput');
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = outputElement.innerHTML;
    
    let copyText = tempDiv.textContent;
    
    if (!copyText || copyText.includes('Output akan muncul di sini')) {
        showInfo('Tidak ada output yang bisa disalin!', 'error');
        return;
    }
    
    navigator.clipboard.writeText(copyText).then(() => {
        showCopyNotification();
    }).catch(err => {
        const textArea = document.createElement('textarea');
        textArea.value = copyText;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showCopyNotification();
    });
}

function clearAll() {
    document.getElementById('inputData').value = '';
    document.getElementById('resultOutput').innerHTML = `// Output akan muncul di sini
// Format dipisah per rumus
// 
// === RUMUS 1 (POSISI 1) ===
// 3872 = 68 . 0123456789 ai
// ...
// ======
// A7mb+E7ty.(mb)
// 
// === RUMUS 2 (POSISI 2) ===
// 3872 = 06 . 0123456789 ai
// ...
// ======
// A8mb+C4.(mb)
// 
// ... dst untuk setiap rumus`;
    document.getElementById('info').textContent = 'Masukkan data, program auto-detect jumlah posisi berdasarkan titik (.)';
    document.getElementById('inputInfo').textContent = '0 angka + 0 rumus terdeteksi';
    document.getElementById('detectedFormula').textContent = 'Tidak ada rumus';
    document.getElementById('historyInfo').textContent = 'Deteksi otomatis jumlah posisi dan rumus';
    dataHistory = [];
    currentFormulas = [];
    maxPositions = 0;
    lastHighlights = [];
}

function showInfo(message, type) {
    const infoDiv = document.getElementById('info');
    infoDiv.textContent = message;
    infoDiv.className = 'info';
    if (type === 'error') {
        infoDiv.classList.add('error');
    } else if (type === 'success') {
        infoDiv.classList.add('success');
    }
}

function showCopyNotification() {
    const notification = document.getElementById('copyNotification');
    notification.classList.add('show');
    setTimeout(() => {
        notification.classList.remove('show');
    }, 3000);
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('inputData').addEventListener('input', updateInputInfo);
    updateInputInfo();
});

document.getElementById('inputData').addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.key === 'Enter') {
        calculateFormula();
    }
});
</script>

</body>
</html>
