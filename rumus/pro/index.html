<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kalkulator Mistik Pro</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family: Arial,sans-serif; background: linear-gradient(135deg,#667eea,#764ba2); min-height:100vh; padding:20px; }
.container { max-width:1400px; margin:0 auto; background:white; border-radius:15px; padding:30px; box-shadow:0 10px 30px rgba(0,0,0,0.2); }
h1 { text-align:center; color:#333; margin-bottom:10px; }
.subtitle { text-align:center; color:#666; font-size:14px; margin-bottom:30px; }

.input-section { background:#f8f9fa; padding:25px; border-radius:10px; border:2px solid #e9ecef; margin-bottom:25px; }
.section-title { color:#333; margin-bottom:20px; font-size:18px; font-weight:bold; }
.data-input { margin-bottom:20px; }
.data-input textarea { width:100%; height:400px; padding:15px; border:2px solid #ddd; border-radius:8px; font-size:14px; resize:vertical; font-family:monospace; line-height:1.5; }
.data-input textarea:focus { border-color:#667eea; outline:none; }
.button-group { display:flex; gap:15px; margin-bottom:20px; }
button { flex:1; padding:15px; border:none; border-radius:8px; font-size:16px; font-weight:bold; cursor:pointer; transition:all 0.3s; }
.btn-calculate { background:#4CAF50;color:white; }
.btn-clear { background:#f44336;color:white; }
button:hover { opacity:0.9; transform:translateY(-2px); }
.info { background:#e3f2fd; padding:15px; border-radius:8px; margin-bottom:20px; text-align:center; }
.input-info { text-align:center; color:#666; font-size:14px; margin-bottom:15px; }

.output-section { background:#f8f9fa; padding:25px; border-radius:10px; border:2px solid #e9ecef; margin-bottom:25px; }
.result-box { background:#2d2d2d; color:#f8f8f2; padding:20px; border-radius:8px; font-family:'Courier New',monospace; min-height:300px; white-space:pre-wrap; line-height:1.5; font-size:14px; overflow-x:auto; user-select:all; -webkit-user-select:all; -moz-user-select:all; -ms-user-select:all; }

.pattern-analysis { background:#e8f5e8; padding:20px; border-radius:8px; margin-bottom:20px; border:1px solid #c8e6c9; }
.pattern-analysis h4 { color:#2e7d32; margin-bottom:15px; }
.pattern-item { margin-bottom:15px; padding:10px; background:#f1f8e9; border-radius:5px; }
.pattern-valid { border-left:4px solid #4CAF50; }
.pattern-invalid { border-left:4px solid #ff9800; background:#fff3e0; }
.pattern-details { margin-top:10px; padding:10px; background:#e8f5e8; border-radius:3px; font-size:12px; }
.debug-info { background:#ffebee; padding:15px; border-radius:8px; margin-top:15px; font-size:12px; color:#c62828; display:none; }

.explanation { background:#fff3cd; padding:20px; border-radius:8px; margin-top:25px; border:1px solid #ffeaa7; }
.explanation h3 { color:#856404; margin-bottom:15px; }
.explanation ul { color:#856404; padding-left:20px; }
.explanation li { margin-bottom:8px; }
</style>
</head>
<body>
<div class="container">
    <h1>üîÆ KALKULATOR MISTIK PRO</h1>
    <div class="subtitle">Pattern Detection Akurat - Abaikan Data Kosong di Awal</div>
    
    <div class="input-section">
        <div class="section-title">üì• INPUT DATA & RUMUS (Semua dalam satu kolom)</div>
        
        <div class="data-input">
            <textarea id="inputData" placeholder="Masukkan data dan rumus dalam format:&#10;6874 = 94 . 91 . 49 ai&#10;0489 = 83 . 35 . 49 ai&#10;...&#10;======&#10;A6ix+K8mb.(mb)&#10;A9‚ÄìC10.(ty)&#10;C8ix+E2ml.(ml)">6874 = 94 . 91 . 49 ai
0489 = 83 . 35 . 49 ai
2843 = 72 . 57 . 27 ai
3752 = 49 . 24 . 94 ai
8644 = 16 . 24 . 72 ai
2962 = 72 . 35 . 27 ai
6937 = 50 . 79 . 05 ai
0559 = 49 . 35 . 49 ai
8445 = 49 . 79 . 94 ai
2429 = 49 . 91 . 27 ai
5879 = 05 . 35 . 38 ai
9158 = 61 . 24 . 49 ai
5364 = 50 . 80 . 49 ai
2190 = 38 . 57 . 50 ai
3358 = 05 . 02 . 05 ai
1452 = 
======
A6ix+K8mb.(mb)
A9‚ÄìC10.(ty)
C8ix+E2ml.(ml)</textarea>
            <div class="input-info" id="inputInfo">Data dan rumus terdeteksi</div>
        </div>
        
        <div class="button-group">
            <button class="btn-calculate" onclick="calculateAdvanced()">üßÆ ANALISIS & HITUNG</button>
            <button class="btn-clear" onclick="clearAll()">üóëÔ∏è CLEAR</button>
        </div>
        
        <div class="info" id="info">Masukkan data dan rumus dalam satu kolom, lalu klik ANALISIS & HITUNG</div>
        <div class="pattern-analysis" id="patternAnalysis" style="display:none;">
            <h4>üîç ANALISIS PATTERN DITEMUKAN:</h4>
            <div id="patternResults"></div>
        </div>
        <div class="debug-info" id="debugInfo"></div>
    </div>

    <div class="output-section">
        <div class="section-title">üì§ HASIL PERHITUNGAN</div>
        <div class="result-box" id="resultOutput">
// Hasil perhitungan akan muncul di sini
// Format:
// 6874 = 94 . 91 . 49 ai
// 0489 = 83 . 35 . 49 ai  
// 2843 = 72 . 57 . 27 ai
// ...
// ======
// A6ix+K8mb.(mb) 
// A9‚ÄìC10.(ty) 
// C8ix+E2ml.(ml)
        </div>
    </div>
</div>

<script>
// Tabel konversi mistik
const mistikTables = {
    'IX': {'0':'5', '1':'6', '2':'7', '3':'8', '4':'9', '5':'0', '6':'1', '7':'2', '8':'3', '9':'4'},
    'TY': {'0':'7', '1':'4', '2':'9', '3':'6', '4':'1', '5':'8', '6':'3', '7':'0', '8':'5', '9':'2'},
    'ML': {'0':'1', '1':'0', '2':'5', '3':'8', '4':'7', '5':'2', '6':'9', '7':'4', '8':'3', '9':'6'},
    'MB': {'0':'8', '1':'7', '2':'6', '3':'9', '4':'5', '5':'4', '6':'2', '7':'1', '8':'0', '9':'3'},
    'M0': {'0':'6', '1':'5', '2':'7', '3':'8', '4':'9', '5':'1', '6':'0', '7':'2', '8':'3', '9':'4'},
    'M1': {'0':'1', '1':'0', '2':'9', '3':'8', '4':'7', '5':'6', '6':'5', '7':'4', '8':'3', '9':'2'},
    'M3': {'0':'3', '1':'2', '2':'1', '3':'0', '4':'9', '5':'8', '6':'7', '7':'6', '8':'5', '9':'4'},
    'M5': {'0':'5', '1':'4', '2':'3', '3':'2', '4':'1', '5':'0', '6':'9', '7':'8', '8':'7', '9':'6'},
    'M7': {'0':'7', '1':'6', '2':'5', '3':'4', '4':'3', '5':'2', '6':'1', '7':'0', '8':'9', '9':'8'},
    'M9': {'0':'9', '1':'8', '2':'7', '3':'6', '4':'5', '5':'4', '6':'3', '7':'2', '8':'1', '9':'0'}
};

let dataHistory = [];
let detectedPatterns = [];

// Fungsi naik dalam sistem siklik 0-9
function naikSiklik(digit, steps) {
    let result = parseInt(digit);
    for (let i = 0; i < steps; i++) {
        result = (result + 1) % 10;
    }
    return result;
}

function calculateAdvanced() {
    const inputData = document.getElementById('inputData').value.trim();
    
    if (!inputData) {
        showInfo('Masukkan data dan rumus terlebih dahulu!', 'error');
        return;
    }
    
    try {
        // Parse data input dan extract formulas
        const { parsedData, formulas } = parseCompleteInput(inputData);
        
        // Hitung BASE RESULT dengan program lama untuk semua data
        calculateBaseResults(parsedData, formulas);
        
        // Analisis pattern dari data yang ada
        detectPatterns(parsedData, formulas);
        
        // Calculate untuk data yang belum lengkap
        const results = calculateMissingData(parsedData, formulas);
        
        // Display result
        displayAdvancedResult(results, formulas);
        showInfo('Analisis pattern dan perhitungan berhasil!', 'success');
        
    } catch (error) {
        showInfo(`Error: ${error.message}`, 'error');
        console.error('Calculation error:', error);
    }
}

function parseCompleteInput(inputData) {
    const lines = inputData.split('\n').filter(line => line.trim());
    const parsedData = [];
    let formulas = [];
    let foundSeparator = false;
    
    for (let line of lines) {
        if (line.trim() === '======') {
            foundSeparator = true;
            continue;
        }
        
        if (!foundSeparator) {
            const match = line.match(/^(\d+)\s*=\s*(.*?)\s*$/);
            if (match) {
                const number = match[1];
                const resultsStr = match[2].trim();
                
                let results = [];
                let label = 'ai';
                
                if (resultsStr && resultsStr !== '') {
                    const parts = resultsStr.split(/\s+/);
                    let tempResults = [];
                    let tempLabel = '';
                    
                    for (let part of parts) {
                        if (part === '.') continue;
                        if (part.match(/^[a-z]+$/i)) {
                            tempLabel = part;
                        } else if (part.match(/^\d+$/)) {
                            tempResults.push(part);
                        }
                    }
                    
                    results = tempResults;
                    label = tempLabel || 'ai';
                }
                
                parsedData.push({
                    number: number,
                    results: results,
                    label: label,
                    components: extractComponents(number),
                    baseResults: []
                });
            }
        } else {
            if (line.trim() && !line.includes('======')) {
                formulas.push(line.trim());
            }
        }
    }
    
    if (!foundSeparator || formulas.length === 0) {
        formulas = ['A6ix+K8mb.(mb)', 'A9‚ÄìC10.(ty)', 'C8ix+E2ml.(ml)'];
    }
    
    return { parsedData, formulas };
}

function extractComponents(number) {
    const as = number[0];
    const cop = number[1];
    const kepala = number[2];
    const ekor = number[3];
    const jumlah = reduceToSingleDigit(parseInt(kepala) + parseInt(ekor));
    
    return { as, cop, kepala, ekor, jumlah };
}

// TAHAP 1: Hitung BASE RESULT dengan program lama
function calculateBaseResults(parsedData, formulas) {
    const reversedData = [...parsedData].reverse();
    
    formulas.forEach((formula, formulaIndex) => {
        reversedData.forEach((data, dataIndex) => {
            try {
                const baseResult = calculateSingleAI(formula, dataIndex, reversedData);
                if (!data.baseResults) data.baseResults = [];
                data.baseResults[formulaIndex] = baseResult;
            } catch (error) {
                console.error(`Error calculating base for ${data.number} with ${formula}:`, error);
                if (!data.baseResults) data.baseResults = [];
                data.baseResults[formulaIndex] = '';
            }
        });
    });
}

// PROGRAM LAMA - Calculate Single AI
function calculateSingleAI(formula, currentDayIndex, dataHistory) {
    let workingFormula = formula;
    
    const finalConversion = workingFormula.match(/\.\((\w+)\)/);
    if (finalConversion) {
        workingFormula = workingFormula.replace(/\.\((\w+)\)/, '');
    }
    
    const components = workingFormula.split('+');
    let total = 0;
    
    components.forEach(component => {
        const value = processComponent(component.trim(), currentDayIndex, dataHistory);
        total += value;
    });
    
    if (finalConversion) {
        const table = finalConversion[1].toUpperCase();
        const converted = convertMistik(total.toString(), table);
        total = parseInt(converted);
    }
    
    const finalResult = reduceToSingleDigit(total);
    return finalResult;
}

function processComponent(component, currentDayIndex, dataHistory) {
    const match = component.match(/^([AKCEJ])(\d+)(\w*)$/);
    if (!match) {
        throw new Error(`Format komponen tidak valid: ${component}`);
    }
    
    const type = match[1];
    const dayOffset = parseInt(match[2]);
    const conversion = match[3];
    
    const targetDayIndex = currentDayIndex + (dayOffset - 1);
    
    if (targetDayIndex >= dataHistory.length) {
        throw new Error(`Data tidak tersedia untuk ${component}`);
    }
    
    const data = dataHistory[targetDayIndex];
    let value;
    
    switch(type) {
        case 'A': value = parseInt(data.components.as); break;
        case 'K': value = parseInt(data.components.kepala); break;
        case 'C': value = parseInt(data.components.cop); break;
        case 'E': value = parseInt(data.components.ekor); break;
        case 'J': value = data.components.jumlah; break;
        default: throw new Error(`Tipe tidak dikenal: ${type}`);
    }
    
    if (conversion) {
        const table = conversion.toUpperCase();
        value = parseInt(convertMistik(value.toString(), table));
    }
    
    return value;
}

function convertMistik(number, table) {
    if (!mistikTables[table]) {
        throw new Error(`Tabel mistik tidak ditemukan: ${table}`);
    }
    
    const digit = reduceToSingleDigit(parseInt(number)).toString();
    
    if (mistikTables[table][digit] === undefined) {
        throw new Error(`Angka ${digit} tidak ada di tabel ${table}`);
    }
    
    return mistikTables[table][digit];
}

// TAHAP 2: Pattern Detection Akurat - FIXED!
function detectPatterns(parsedData, formulas) {
    detectedPatterns = [];
    
    formulas.forEach((formula, formulaIndex) => {
        const pattern = analyzePatternForFormula(parsedData, formula, formulaIndex);
        detectedPatterns.push(pattern);
    });
    
    displayPatternAnalysis();
}

function analyzePatternForFormula(parsedData, formula, formulaIndex) {
    // FIX: Cari data pertama yang punya hasil untuk rumus ini (abaikan data kosong di awal)
    let startIndex = -1;
    for (let i = 0; i < parsedData.length; i++) {
        if (parsedData[i].results.length > formulaIndex && 
            parsedData[i].results[formulaIndex] && 
            parsedData[i].results[formulaIndex] !== '') {
            startIndex = i;
            break;
        }
    }
    
    // Jika tidak ada data yang punya hasil
    if (startIndex === -1) {
        return {
            formula: formula,
            naikSequence: [],
            digitLength: 0,
            isValid: false,
            reason: `Tidak ada data dengan hasil final`,
            validDataCount: 0,
            consecutive: 0
        };
    }
    
    // FIX: Ambil semua data berturut-turut mulai dari data pertama yang punya hasil
    const validData = [];
    for (let i = startIndex; i < parsedData.length; i++) {
        const item = parsedData[i];
        if (item.results.length > formulaIndex && 
            item.results[formulaIndex] && 
            item.results[formulaIndex] !== '') {
            validData.push(item);
        } else {
            // Stop jika menemui data tanpa hasil
            break;
        }
    }
    
    console.log(`Rumus ${formula}: ${validData.length} data berturut-turut (mulai dari ${validData[0]?.number})`);
    
    // WAJIB minimal 4 data berturut-turut
    if (validData.length < 4) {
        return {
            formula: formula,
            naikSequence: [],
            digitLength: 0,
            isValid: false,
            reason: `Hanya ${validData.length} data berturut-turut (minimal 4 required)`,
            validDataCount: validData.length,
            consecutive: validData.length
        };
    }
    
    const pattern = {
        formula: formula,
        naikSequence: [],
        digitLength: validData[0].results[formulaIndex].length,
        isValid: true,
        reason: `${validData.length} data berturut-turut - Pattern valid`,
        validDataCount: validData.length,
        consecutive: validData.length,
        analysisDetails: []
    };
    
    // Untuk setiap digit position, cari pattern "naik X"
    for (let digitIndex = 0; digitIndex < pattern.digitLength; digitIndex++) {
        const naikValues = [];
        let allSame = true;
        let firstValue = null;
        
        // Analisis data berturut-turut
        for (let i = 0; i < validData.length - 1; i++) {
            const currentDigit = parseInt(validData[i].results[formulaIndex][digitIndex]);
            const nextDigit = parseInt(validData[i + 1].results[formulaIndex][digitIndex]);
            
            const naikValue = (nextDigit - currentDigit + 10) % 10;
            naikValues.push(naikValue);
            
            if (firstValue === null) {
                firstValue = naikValue;
            } else if (naikValue !== firstValue) {
                allSame = false;
            }
            
            pattern.analysisDetails.push({
                from: validData[i].number,
                to: validData[i + 1].number,
                digit: digitIndex,
                current: currentDigit,
                next: nextDigit,
                naik: naikValue
            });
        }
        
        // Pattern harus SAMA untuk semua data berturut-turut
        if (!allSame) {
            pattern.isValid = false;
            pattern.reason = `Pattern tidak konsisten pada digit ${digitIndex + 1}`;
            break;
        }
        
        pattern.naikSequence.push(naikValues[0]);
    }
    
    console.log(`Pattern untuk ${formula}:`, pattern);
    return pattern;
}

function calculateMissingData(parsedData, formulas) {
    const results = [...parsedData];
    
    const incompleteData = results.filter(item => 
        item.results.length < formulas.length || 
        item.results.some((r, idx) => !r && idx < formulas.length)
    );
    
    incompleteData.forEach(data => {
        while (data.results.length < formulas.length) {
            data.results.push('');
        }
        
        formulas.forEach((formula, i) => {
            if (!data.results[i] || data.results[i] === '') {
                const calculatedResult = calculateWithPattern(data, formula, detectedPatterns[i]);
                data.results[i] = calculatedResult;
            }
        });
    });
    
    return results;
}

function calculateWithPattern(data, formula, pattern) {
    if (!pattern || !pattern.isValid) {
        return "";
    }
    
    try {
        const formulaIndex = detectedPatterns.findIndex(p => p.formula === formula);
        const baseResult = data.baseResults[formulaIndex];
        
        if (!baseResult && baseResult !== 0) {
            return "";
        }
        
        let finalResult = "";
        let currentDigit = parseInt(baseResult);
        
        for (let i = 0; i < pattern.digitLength; i++) {
            currentDigit = naikSiklik(currentDigit, pattern.naikSequence[i]);
            finalResult += currentDigit.toString();
        }
        
        return finalResult;
    } catch (error) {
        console.error('Error in calculateWithPattern:', error);
        return "";
    }
}

function displayPatternAnalysis() {
    const patternAnalysis = document.getElementById('patternAnalysis');
    const patternResults = document.getElementById('patternResults');
    
    let html = '';
    let validPatterns = 0;
    
    detectedPatterns.forEach((pattern, index) => {
        const statusClass = pattern.isValid ? 'pattern-valid' : 'pattern-invalid';
        const statusIcon = pattern.isValid ? '‚úÖ' : '‚ö†Ô∏è';
        
        html += `<div class="pattern-item ${statusClass}">`;
        html += `<div><strong>${statusIcon} Rumus ${index + 1}:</strong> ${pattern.formula}</div>`;
        html += `<div><strong>Status:</strong> ${pattern.reason}</div>`;
        html += `<div><strong>Data Berturut-turut:</strong> ${pattern.consecutive}</div>`;
        
        if (pattern.isValid) {
            html += `<div><strong>Pattern "naik X":</strong> [${pattern.naikSequence.join(', ')}]</div>`;
            html += `<div><strong>Digit output:</strong> ${pattern.digitLength}</div>`;
            validPatterns++;
            
            // Tampilkan detail analisis
            html += `<div class="pattern-details">`;
            html += `<strong>Detail Analisis:</strong><br>`;
            pattern.analysisDetails.slice(0, 3).forEach(detail => {
                html += `${detail.from}‚Üí${detail.to}: digit${detail.digit + 1} ${detail.current}‚Üí${detail.next} (naik ${detail.naik})<br>`;
            });
            if (pattern.analysisDetails.length > 3) {
                html += `... dan ${pattern.analysisDetails.length - 3} data lainnya<br>`;
            }
            html += `</div>`;
        }
        
        html += `</div>`;
    });
    
    patternResults.innerHTML = html;
    patternAnalysis.style.display = 'block';
}

function displayAdvancedResult(results, formulas) {
    const output = document.getElementById('resultOutput');
    let outputText = '';
    
    results.forEach(result => {
        outputText += `${result.number} = `;
        if (result.results.length > 0) {
            const validResults = result.results.slice(0, formulas.length).filter(r => r !== '');
            outputText += validResults.join(' . ');
            if (result.label && validResults.length > 0) {
                outputText += ` ${result.label}`;
            }
        }
        outputText += '\n';
    });
    
    outputText += '======\n';
    formulas.forEach(formula => {
        outputText += `${formula}\n`;
    });
    
    output.textContent = outputText;
}

function reduceToSingleDigit(num) {
    let result = num;
    while (result > 9) {
        result = result.toString().split('').reduce((sum, digit) => sum + parseInt(digit), 0);
    }
    return result;
}

function clearAll() {
    document.getElementById('inputData').value = `6874 = 94 . 91 . 49 ai
0489 = 83 . 35 . 49 ai
2843 = 72 . 57 . 27 ai
3752 = 49 . 24 . 94 ai
8644 = 16 . 24 . 72 ai
2962 = 72 . 35 . 27 ai
6937 = 50 . 79 . 05 ai
0559 = 49 . 35 . 49 ai
8445 = 49 . 79 . 94 ai
2429 = 49 . 91 . 27 ai
5879 = 05 . 35 . 38 ai
9158 = 61 . 24 . 49 ai
5364 = 50 . 80 . 49 ai
2190 = 38 . 57 . 50 ai
3358 = 05 . 02 . 05 ai
1452 = 
======
A6ix+K8mb.(mb)
A9‚ÄìC10.(ty)
C8ix+E2ml.(ml)`;
    document.getElementById('resultOutput').textContent = `// Hasil perhitungan akan muncul di sini
// Format:
// 6874 = 94 . 91 . 49 ai
// 0489 = 83 . 35 . 49 ai  
// 2843 = 72 . 57 . 27 ai
// ...
// ======
// A6ix+K8mb.(mb) 
// A9‚ÄìC10.(ty) 
// C8ix+E2ml.(ml)`;
    document.getElementById('info').textContent = 'Masukkan data dan rumus dalam satu kolom, lalu klik ANALISIS & HITUNG';
    document.getElementById('inputInfo').textContent = 'Data dan rumus terdeteksi';
    document.getElementById('debugInfo').style.display = 'none';
    document.getElementById('patternAnalysis').style.display = 'none';
    dataHistory = [];
    detectedPatterns = [];
}

function showInfo(message, type) {
    const infoDiv = document.getElementById('info');
    infoDiv.textContent = message;
    infoDiv.style.background = type === 'error' ? '#ffebee' : 
                             type === 'success' ? '#e8f5e8' : '#e3f2fd';
    infoDiv.style.color = type === 'error' ? '#c62828' :
                        type === 'success' ? '#2e7d32' : '#1565c0';
}

function updateInputInfo() {
    const input = document.getElementById('inputData').value.trim();
    const lines = input.split('\n').filter(line => line.trim());
    const dataCount = lines.filter(line => line.match(/^\d+\s*=/)).length;
    const hasFormulas = input.includes('======');
    
    let info = `${dataCount} data terdeteksi`;
    if (hasFormulas) {
        info += ' + rumus';
    }
    
    document.getElementById('inputInfo').textContent = info;
}

document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('inputData').addEventListener('input', updateInputInfo);
    updateInputInfo();
});

document.getElementById('inputData').addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.key === 'Enter') {
        calculateAdvanced();
    }
});
</script>
</body>
</html>
