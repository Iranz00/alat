<script>
// Tabel konversi mistik
const mistikTables = {
    'IX': {'0':'5', '1':'6', '2':'7', '3':'8', '4':'9', '5':'0', '6':'1', '7':'2', '8':'3', '9':'4'},
    'TY': {'0':'7', '1':'4', '2':'9', '3':'6', '4':'1', '5':'8', '6':'3', '7':'0', '8':'5', '9':'2'},
    'ML': {'0':'1', '1':'0', '2':'5', '3':'8', '4':'7', '5':'2', '6':'9', '7':'4', '8':'3', '9':'6'},
    'MB': {'0':'8', '1':'7', '2':'6', '3':'9', '4':'5', '5':'4', '6':'2', '7':'1', '8':'0', '9':'3'},
    'M0': {'0':'6', '1':'5', '2':'7', '3':'8', '4':'9', '5':'1', '6':'0', '7':'2', '8':'3', '9':'4'},
    'M1': {'0':'1', '1':'0', '2':'9', '3':'8', '4':'7', '5':'6', '6':'5', '7':'4', '8':'3', '9':'2'},
    'M3': {'0':'3', '1':'2', '2':'1', '3':'0', '4':'9', '5':'8', '6':'7', '7':'6', '8':'5', '9':'4'},
    'M5': {'0':'5', '1':'4', '2':'3', '3':'2', '4':'1', '5':'0', '6':'9', '7':'8', '8':'7', '9':'6'},
    'M7': {'0':'7', '1':'6', '2':'5', '3':'4', '4':'3', '5':'2', '6':'1', '7':'0', '8':'9', '9':'8'},
    'M9': {'0':'9', '1':'8', '2':'7', '3':'6', '4':'5', '5':'4', '6':'3', '7':'2', '8':'1', '9':'0'}
};

let dataHistory = [];
let currentFormulas = [];
let originalInputData = [];

function calculateFormula() {
    const inputData = document.getElementById('inputData').value.trim();
    
    if (!inputData) {
        showInfo('Masukkan data terlebih dahulu!', 'error');
        return;
    }
    
    try {
        const parsedData = parseInputData(inputData);
        
        if (currentFormulas.length === 0) {
            showInfo('Tidak ada rumus yang terdeteksi! Pastikan ada rumus setelah garis "======"', 'error');
            return;
        }
        
        // Calculate untuk semua rumus
        const allResults = [];
        for (const formula of currentFormulas) {
            const results = calculateAIForAll(formula);
            
            // Untuk semua rumus, gunakan pola: warna pada posisi 0 dan 1
            const colorPattern = [0, 1]; // Dua digit pertama selalu berwarna
            
            allResults.push({ 
                formula, 
                results,
                colorPattern 
            });
        }
        
        displayMultiResultWithColor(allResults);
        showInfo(`Perhitungan berhasil! ${currentFormulas.length} rumus diproses.`, 'success');
        
    } catch (error) {
        showInfo(`Error: ${error.message}`, 'error');
        console.error('Calculation error:', error);
    }
}

function parseInputData(inputData) {
    dataHistory = [];
    currentFormulas = [];
    originalInputData = [];
    
    const lines = inputData.split('\n').filter(line => line.trim());
    let foundSeparator = false;
    const tempData = [];
    
    for (let line of lines) {
        line = line.trim();
        
        if (line === '======' || line.startsWith('======')) {
            foundSeparator = true;
            continue;
        }
        
        if (foundSeparator && line) {
            currentFormulas.push(line);
            continue;
        }
        
        if (!foundSeparator) {
            const numberMatch = line.match(/(\d{4})/);
            if (numberMatch) {
                const number = numberMatch[1];
                const as = number[0];
                const cop = number[1];
                const kepala = number[2];
                const ekor = number[3];
                const jumlah = reduceToSingleDigit(parseInt(kepala) + parseInt(ekor));
                
                tempData.push({ number, as, cop, kepala, ekor, jumlah });
                
                const originalMatch = line.match(/(\d{4})\s*=\s*(\d+)/);
                if (originalMatch) {
                    originalInputData.push({
                        number: originalMatch[1],
                        ai: originalMatch[2] || ''
                    });
                } else {
                    originalInputData.push({ number, ai: '' });
                }
            }
        }
    }
    
    dataHistory = tempData;
    
    document.getElementById('detectedFormula').textContent = 
        currentFormulas.length > 0 ? `${currentFormulas.length} rumus terdeteksi` : 'Tidak ada rumus';
    
    if (currentFormulas.length > 0) {
        const maxDayNeeded = Math.max(...currentFormulas.map(findMaxDayInFormula));
        document.getElementById('historyInfo').textContent = 
            `Butuh ${maxDayNeeded} hari history. ${currentFormulas.length} rumus terdeteksi.`;
    }
    
    return { data: dataHistory, formulas: currentFormulas };
}

function findMaxDayInFormula(formula) {
    let maxDay = 1;
    let workingFormula = formula.replace(/\.\((\w+)\)/, '');
    const components = workingFormula.split(/[+\-]/);
    
    components.forEach(component => {
        const match = component.trim().match(/^([AKCEJ])(\d+)/);
        if (match) {
            const day = parseInt(match[2]);
            if (day > maxDay) maxDay = day;
        }
    });
    
    return maxDay;
}

function calculateAIForAll(formula) {
    const results = [];
    const maxDayNeeded = findMaxDayInFormula(formula);
    
    for (let i = 0; i < dataHistory.length; i++) {
        if (i >= maxDayNeeded - 1) {
            const aiResult = calculateSingleAI(formula, i);
            results.push({
                number: dataHistory[i].number,
                ai: aiResult,
                canCalculate: true,
                originalAI: originalInputData[i].ai
            });
        } else {
            results.push({
                number: dataHistory[i].number,
                ai: '',
                canCalculate: false,
                originalAI: originalInputData[i].ai
            });
        }
    }
    
    return results;
}

function calculateSingleAI(formula, currentDayIndex) {
    let workingFormula = formula;
    const finalConversion = workingFormula.match(/\.\((\w+)\)/);
    if (finalConversion) {
        workingFormula = workingFormula.replace(/\.\((\w+)\)/, '');
    }
    
    const components = workingFormula.split(/([+\-])/);
    let total = 0;
    let currentOperator = '+';
    
    for (let i = 0; i < components.length; i++) {
        const component = components[i].trim();
        
        if (component === '+' || component === '-') {
            currentOperator = component;
            continue;
        }
        
        if (component) {
            const value = processComponent(component, currentDayIndex);
            if (currentOperator === '+') total += value;
            else if (currentOperator === '-') total -= value;
        }
    }
    
    if (total < 0) total = Math.abs(total);
    
    if (finalConversion) {
        const table = finalConversion[1].toUpperCase();
        const converted = convertMistik(total.toString(), table);
        total = parseInt(converted);
    }
    
    return reduceToSingleDigit(total);
}

function processComponent(component, currentDayIndex) {
    const match = component.match(/^([AKCEJ])(\d+)(\w*)$/);
    if (!match) throw new Error(`Format komponen tidak valid: ${component}`);
    
    const type = match[1];
    const dayOffset = parseInt(match[2]);
    const conversion = match[3];
    
    const targetDayIndex = currentDayIndex - (dayOffset - 1);
    if (targetDayIndex < 0) throw new Error(`Data tidak tersedia untuk ${component} (butuh ${dayOffset} hari history)`);
    
    const data = dataHistory[targetDayIndex];
    let value;
    
    switch(type) {
        case 'A': value = parseInt(data.as); break;
        case 'K': value = parseInt(data.kepala); break;
        case 'C': value = parseInt(data.cop); break;
        case 'E': value = parseInt(data.ekor); break;
        case 'J': value = data.jumlah; break;
        default: throw new Error(`Tipe tidak dikenal: ${type}`);
    }
    
    if (conversion) {
        const table = conversion.toUpperCase();
        value = parseInt(convertMistik(value.toString(), table));
    }
    
    return value;
}

function convertMistik(number, table) {
    if (!mistikTables[table]) throw new Error(`Tabel mistik tidak ditemukan: ${table}`);
    
    const digit = reduceToSingleDigit(parseInt(number)).toString();
    if (mistikTables[table][digit] === undefined) throw new Error(`Angka ${digit} tidak ada di tabel ${table}`);
    
    return mistikTables[table][digit];
}

function reduceToSingleDigit(num) {
    let result = num;
    while (result > 9) {
        result = result.toString().split('').reduce((sum, digit) => sum + parseInt(digit), 0);
    }
    return result;
}

function getRotatedDigits(calculatedAI, allDigits) {
    let rotatedDigits = '';
    const startIndex = allDigits.indexOf(calculatedAI.toString());
    
    for (let i = 0; i < allDigits.length; i++) {
        const actualIndex = (startIndex + i) % allDigits.length;
        rotatedDigits += allDigits[actualIndex];
    }
    
    return rotatedDigits;
}

function formatAIWithPattern(calculatedAI, originalAI, colorPattern) {
    const allDigits = '0123456789';
    const rotatedDigits = getRotatedDigits(calculatedAI, allDigits);
    
    let result = '';
    
    for (let i = 0; i < rotatedDigits.length; i++) {
        const digit = rotatedDigits[i];
        let shouldHighlight = false;
        
        // Prioritaskan originalAI jika ada
        if (originalAI && originalAI !== '') {
            shouldHighlight = originalAI.includes(digit);
        } 
        // Jika tidak ada originalAI, gunakan colorPattern (posisi 0 dan 1)
        else if (colorPattern && colorPattern.includes(i)) {
            shouldHighlight = true;
        }
        
        if (shouldHighlight) {
            result += `<span style="color: #FF6B6B; font-weight: bold;">${digit}</span>`;
        } else {
            result += digit;
        }
    }
    
    return result;
}

function displayMultiResultWithColor(allResults) {
    const output = document.getElementById('resultOutput');
    output.innerHTML = '';
    
    // Untuk setiap rumus, tampilkan semua data
    for (const { formula, results, colorPattern } of allResults) {
        const blockDiv = document.createElement('div');
        blockDiv.style.marginBottom = '25px';
        
        // Tampilkan semua data untuk rumus ini
        for (let i = 0; i < results.length; i++) {
            const result = results[i];
            const lineDiv = document.createElement('div');
            
            if (result.canCalculate) {
                const formattedAI = formatAIWithPattern(result.ai, result.originalAI, colorPattern);
                lineDiv.innerHTML = `${result.number} = ${formattedAI} ai`;
            } else {
                lineDiv.textContent = `${result.number} = `;
            }
            
            blockDiv.appendChild(lineDiv);
        }
        
        // Tambahkan separator dan formula
        const separatorDiv = document.createElement('div');
        separatorDiv.textContent = '======';
        separatorDiv.style.fontWeight = 'bold';
        separatorDiv.style.marginTop = '10px';
        blockDiv.appendChild(separatorDiv);
        
        const formulaDiv = document.createElement('div');
        formulaDiv.textContent = formula;
        formulaDiv.style.marginBottom = '15px';
        blockDiv.appendChild(formulaDiv);
        
        output.appendChild(blockDiv);
        
        // Tambahkan empty line antara blok rumus
        const emptyLine = document.createElement('div');
        emptyLine.style.height = '15px';
        output.appendChild(emptyLine);
    }
}

function getTextOutput() {
    const output = document.getElementById('resultOutput');
    const blocks = output.querySelectorAll('div > div');
    let textOutput = '';
    
    blocks.forEach(block => {
        const lines = block.querySelectorAll('div');
        
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            
            if (line.textContent.includes('======')) {
                textOutput += '======\n';
                if (lines[i + 1]) {
                    textOutput += lines[i + 1].textContent + '\n\n';
                    i++;
                }
            } else if (line.innerHTML.includes('<span')) {
                const number = line.textContent.split(' = ')[0];
                const spanElements = line.querySelectorAll('span');
                let highlightedDigits = '';
                
                spanElements.forEach(span => {
                    highlightedDigits += span.textContent;
                });
                
                if (highlightedDigits) {
                    textOutput += `${number} = ${highlightedDigits} ai\n`;
                } else {
                    textOutput += `${number} = \n`;
                }
            } else {
                const lineText = line.textContent.trim();
                if (lineText && !lineText.includes('======')) {
                    textOutput += lineText + '\n';
                }
            }
        }
    });
    
    return textOutput.trim();
}

function clearAll() {
    document.getElementById('inputData').value = '';
    document.getElementById('resultOutput').innerHTML = `// Hasil perhitungan akan muncul di sini<br>// Format multi-rumus:<br>// 3062 = 2345678901 ai<br>// 0405 = 5678901234 ai<br>// ...<br>// ======<br>// A3mb-A5m9.(ty)<br><br>// [Blok rumus berikutnya...]`;
    document.getElementById('info').textContent = 'Masukkan data dengan format angka dan rumus, lalu klik HITUNG RUMUS';
    document.getElementById('inputInfo').textContent = '0 angka + 0 rumus terdeteksi';
    document.getElementById('detectedFormula').textContent = 'Tidak ada rumus';
    document.getElementById('historyInfo').textContent = 'Butuh 0 hari history. Data terbaru (bawah) membutuhkan data sebelumnya (atas) untuk perhitungan.';
    dataHistory = [];
    currentFormulas = [];
    originalInputData = [];
}

function showInfo(message, type) {
    const infoDiv = document.getElementById('info');
    infoDiv.textContent = message;
    infoDiv.className = 'info';
    if (type === 'error') infoDiv.classList.add('error');
    else if (type === 'success') infoDiv.classList.add('success');
}

function updateInputInfo() {
    const input = document.getElementById('inputData').value.trim();
    const parsed = parseInputData(input);
    const numberCount = dataHistory.length;
    const formulaCount = currentFormulas.length;
    
    document.getElementById('inputInfo').textContent = `${numberCount} angka + ${formulaCount} rumus terdeteksi`;
}

function copyOutput() {
    const textOutput = getTextOutput();
    
    if (!textOutput || textOutput.includes('Hasil perhitungan akan muncul di sini')) {
        showInfo('Tidak ada output yang bisa disalin!', 'error');
        return;
    }
    
    navigator.clipboard.writeText(textOutput).then(() => {
        showCopyNotification();
    }).catch(err => {
        const textArea = document.createElement('textarea');
        textArea.value = textOutput;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showCopyNotification();
    });
}

function useOutputAsInput() {
    const textOutput = getTextOutput();
    
    if (!textOutput || textOutput.includes('Hasil perhitungan akan muncul di sini')) {
        showInfo('Tidak ada output yang bisa digunakan!', 'error');
        return;
    }
    
    document.getElementById('inputData').value = textOutput;
    updateInputInfo();
    showInfo('Output berhasil digunakan sebagai input baru!', 'success');
}

function showCopyNotification() {
    const notification = document.getElementById('copyNotification');
    notification.classList.add('show');
    setTimeout(() => {
        notification.classList.remove('show');
    }, 3000);
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('inputData').addEventListener('input', updateInputInfo);
    updateInputInfo();
});

document.getElementById('inputData').addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.key === 'Enter') {
        calculateFormula();
    }
});
</script>
