<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kalkulator Mistik Pro</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family: Arial,sans-serif; background: linear-gradient(135deg,#667eea,#764ba2); min-height:100vh; padding:20px; }
.container { max-width:1400px; margin:0 auto; background:white; border-radius:15px; padding:30px; box-shadow:0 10px 30px rgba(0,0,0,0.2); }
h1 { text-align:center; color:#333; margin-bottom:10px; }
.subtitle { text-align:center; color:#666; font-size:14px; margin-bottom:30px; }

.input-section { background:#f8f9fa; padding:25px; border-radius:10px; border:2px solid #e9ecef; margin-bottom:25px; }
.section-title { color:#333; margin-bottom:20px; font-size:18px; font-weight:bold; }
.data-input { margin-bottom:20px; }
.data-input textarea { width:100%; height:400px; padding:15px; border:2px solid #ddd; border-radius:8px; font-size:14px; resize:vertical; font-family:monospace; line-height:1.5; }
.data-input textarea:focus { border-color:#667eea; outline:none; }
.button-group { display:flex; gap:15px; margin-bottom:20px; }
button { flex:1; padding:15px; border:none; border-radius:8px; font-size:16px; font-weight:bold; cursor:pointer; transition:all 0.3s; }
.btn-calculate { background:#4CAF50;color:white; }
.btn-clear { background:#f44336;color:white; }
button:hover { opacity:0.9; transform:translateY(-2px); }
.info { background:#e3f2fd; padding:15px; border-radius:8px; margin-bottom:20px; text-align:center; }
.input-info { text-align:center; color:#666; font-size:14px; margin-bottom:15px; }

.output-section { background:#f8f9fa; padding:25px; border-radius:10px; border:2px solid #e9ecef; margin-bottom:25px; }
.result-box { background:#2d2d2d; color:#f8f8f2; padding:20px; border-radius:8px; font-family:'Courier New',monospace; min-height:300px; white-space:pre-wrap; line-height:1.5; font-size:14px; overflow-x:auto; user-select:all; -webkit-user-select:all; -moz-user-select:all; -ms-user-select:all; }

.pattern-analysis { background:#e8f5e8; padding:20px; border-radius:8px; margin-bottom:20px; border:1px solid #c8e6c9; }
.pattern-analysis h4 { color:#2e7d32; margin-bottom:15px; }
.pattern-item { margin-bottom:15px; padding:10px; background:#f1f8e9; border-radius:5px; }
.pattern-valid { border-left:4px solid #4CAF50; }
.pattern-invalid { border-left:4px solid #ff9800; background:#fff3e0; }
.debug-info { background:#ffebee; padding:15px; border-radius:8px; margin-top:15px; font-size:12px; color:#c62828; display:none; }

.explanation { background:#fff3cd; padding:20px; border-radius:8px; margin-top:25px; border:1px solid #ffeaa7; }
.explanation h3 { color:#856404; margin-bottom:15px; }
.explanation ul { color:#856404; padding-left:20px; }
.explanation li { margin-bottom:8px; }
</style>
</head>
<body>
<div class="container">
    <h1>üîÆ KALKULATOR MISTIK PRO</h1>
    <div class="subtitle">Hitung multiple rumus mistik dengan pattern detection - Minimal 4 Data Berturut-turut</div>
    
    <div class="input-section">
        <div class="section-title">üì• INPUT DATA & RUMUS (Semua dalam satu kolom)</div>
        
        <div class="data-input">
            <textarea id="inputData" placeholder="Masukkan data dan rumus dalam format:&#10;7013 = &#10;8741 = &#10;5337 = &#10;...&#10;6874 = 94 . 91 . 49 ai&#10;0489 = 83 . 35 . 49 ai&#10;...&#10;======&#10;A6ix+K8mb.(mb)&#10;A9‚ÄìC10.(ty)&#10;C8ix+E2ml.(ml)">6874 = 94 . 91 . 49 ai
0489 = 83 . 35 . 49 ai
2843 = 72 . 57 . 27 ai
3752 = 49 . 24 . 94 ai
8644 = 16 . 24 . 72 ai
2962 = 72 . 35 . 27 ai
6937 = 50 . 79 . 05 ai
0559 = 49 . 35 . 49 ai
8445 = 49 . 79 . 94 ai
2429 = 49 . 91 . 27 ai
5879 = 05 . 35 . 38 ai
9158 = 61 . 24 . 49 ai
5364 = 50 . 80 . 49 ai
2190 = 38 . 57 . 50 ai
3358 = 05 . 02 . 05 ai
1452 = 
======
A6ix+K8mb.(mb)
A9‚ÄìC10.(ty)
C8ix+E2ml.(ml)</textarea>
            <div class="input-info" id="inputInfo">Data dan rumus terdeteksi</div>
        </div>
        
        <div class="button-group">
            <button class="btn-calculate" onclick="calculateAdvanced()">üßÆ ANALISIS & HITUNG</button>
            <button class="btn-clear" onclick="clearAll()">üóëÔ∏è CLEAR</button>
        </div>
        
        <div class="info" id="info">Masukkan data dan rumus dalam satu kolom, lalu klik ANALISIS & HITUNG</div>
        <div class="pattern-analysis" id="patternAnalysis" style="display:none;">
            <h4>üîç ANALISIS PATTERN DITEMUKAN:</h4>
            <div id="patternResults"></div>
        </div>
        <div class="debug-info" id="debugInfo"></div>
    </div>

    <div class="output-section">
        <div class="section-title">üì§ HASIL PERHITUNGAN</div>
        <div class="result-box" id="resultOutput">
// Hasil perhitungan akan muncul di sini
// Format:
// 6874 = 94 . 91 . 49 ai
// 0489 = 83 . 35 . 49 ai  
// 2843 = 72 . 57 . 27 ai
// ...
// ======
// A6ix+K8mb.(mb) 
// A9‚ÄìC10.(ty) 
// C8ix+E2ml.(ml)
        </div>
    </div>

    <div class="explanation">
        <h3>üìù KRITERIA PATTERN DETECTION:</h3>
        <ul>
            <li><strong>Minimal 4 data berturut-turut</strong> dengan hasil lengkap untuk setiap rumus</li>
            <li><strong>Pattern harus konsisten</strong> (modus jelas dari data riil)</li>
            <li><strong>Tidak ada pattern default, random, atau acak</strong></li>
            <li><strong>Jika kurang dari 4 data</strong> ‚Üí hasil dikosongkan</li>
            <li><strong>Output dapat disalin:</strong> Klik dan copy hasil perhitungan</li>
        </ul>
    </div>
</div>

<script>
// Tabel konversi mistik
const mistikTables = {
    'IX': {'0':'5', '1':'6', '2':'7', '3':'8', '4':'9', '5':'0', '6':'1', '7':'2', '8':'3', '9':'4'},
    'TY': {'0':'7', '1':'4', '2':'9', '3':'6', '4':'1', '5':'8', '6':'3', '7':'0', '8':'5', '9':'2'},
    'ML': {'0':'1', '1':'0', '2':'5', '3':'8', '4':'7', '5':'2', '6':'9', '7':'4', '8':'3', '9':'6'},
    'MB': {'0':'8', '1':'7', '2':'6', '3':'9', '4':'5', '5':'4', '6':'2', '7':'1', '8':'0', '9':'3'},
    'M0': {'0':'6', '1':'5', '2':'7', '3':'8', '4':'9', '5':'1', '6':'0', '7':'2', '8':'3', '9':'4'},
    'M1': {'0':'1', '1':'0', '2':'9', '3':'8', '4':'7', '5':'6', '6':'5', '7':'4', '8':'3', '9':'2'},
    'M3': {'0':'3', '1':'2', '2':'1', '3':'0', '4':'9', '5':'8', '6':'7', '7':'6', '8':'5', '9':'4'},
    'M5': {'0':'5', '1':'4', '2':'3', '3':'2', '4':'1', '5':'0', '6':'9', '7':'8', '8':'7', '9':'6'},
    'M7': {'0':'7', '1':'6', '2':'5', '3':'4', '4':'3', '5':'2', '6':'1', '7':'0', '8':'9', '9':'8'},
    'M9': {'0':'9', '1':'8', '2':'7', '3':'6', '4':'5', '5':'4', '6':'3', '7':'2', '8':'1', '9':'0'}
};

let dataHistory = [];
let detectedPatterns = [];

// Fungsi naik dalam sistem siklik 0-9
function naikSiklik(digit, steps) {
    let result = parseInt(digit);
    for (let i = 0; i < steps; i++) {
        result = (result + 1) % 10;
    }
    return result;
}

function calculateAdvanced() {
    const inputData = document.getElementById('inputData').value.trim();
    
    if (!inputData) {
        showInfo('Masukkan data dan rumus terlebih dahulu!', 'error');
        return;
    }
    
    try {
        // Parse data input dan extract formulas
        const { parsedData, formulas } = parseCompleteInput(inputData);
        
        // Analisis pattern dari data yang ada
        detectPatterns(parsedData, formulas);
        
        // Calculate untuk data yang belum lengkap
        const results = calculateMissingData(parsedData, formulas);
        
        // Display result
        displayAdvancedResult(results, formulas);
        showInfo('Analisis pattern dan perhitungan berhasil!', 'success');
        
    } catch (error) {
        showInfo(`Error: ${error.message}`, 'error');
        console.error('Calculation error:', error);
    }
}

function parseCompleteInput(inputData) {
    const lines = inputData.split('\n').filter(line => line.trim());
    const parsedData = [];
    let formulas = [];
    let foundSeparator = false;
    
    for (let line of lines) {
        if (line.trim() === '======') {
            foundSeparator = true;
            continue;
        }
        
        if (!foundSeparator) {
            // Parse data lines
            const match = line.match(/^(\d+)\s*=\s*(.*?)\s*$/);
            if (match) {
                const number = match[1];
                const resultsStr = match[2].trim();
                
                let results = [];
                let label = 'ai'; // default
                
                if (resultsStr && resultsStr !== '') {
                    // Parse format: 94 . 91 . 49 ai
                    const parts = resultsStr.split(/\s+/);
                    let tempResults = [];
                    let tempLabel = '';
                    
                    for (let part of parts) {
                        if (part === '.') continue;
                        if (part.match(/^[a-z]+$/i)) {
                            tempLabel = part;
                        } else if (part.match(/^\d+$/)) {
                            tempResults.push(part);
                        }
                    }
                    
                    results = tempResults;
                    label = tempLabel || 'ai';
                }
                
                parsedData.push({
                    number: number,
                    results: results,
                    label: label,
                    components: extractComponents(number)
                });
            }
        } else {
            // Parse formula lines setelah separator
            if (line.trim() && !line.includes('======')) {
                formulas.push(line.trim());
            }
        }
    }
    
    // Jika tidak ada separator, gunakan default formulas
    if (!foundSeparator || formulas.length === 0) {
        formulas = ['A6ix+K8mb.(mb)', 'A9‚ÄìC10.(ty)', 'C8ix+E2ml.(ml)'];
    }
    
    console.log('Parsed data:', parsedData);
    console.log('Parsed formulas:', formulas);
    
    return { parsedData, formulas };
}

function extractComponents(number) {
    const as = number[0];
    const cop = number[1];
    const kepala = number[2];
    const ekor = number[3];
    const jumlah = reduceToSingleDigit(parseInt(kepala) + parseInt(ekor));
    
    return { as, cop, kepala, ekor, jumlah };
}

function detectPatterns(parsedData, formulas) {
    detectedPatterns = [];
    const formulaCount = formulas.length;
    
    // Untuk setiap formula, cari patternnya
    for (let formulaIndex = 0; formulaIndex < formulaCount; formulaIndex++) {
        const pattern = analyzePatternForFormula(parsedData, formulas[formulaIndex], formulaIndex);
        detectedPatterns.push(pattern);
    }
    
    // Tampilkan hasil analisis pattern
    displayPatternAnalysis();
}

function analyzePatternForFormula(parsedData, formula, formulaIndex) {
    // 1. Cari data yang punya hasil untuk rumus ini (BERTURUT-TURUT)
    const validData = [];
    let consecutiveCount = 0;
    
    // Cari data berturut-turut yang memiliki hasil untuk rumus ini
    for (let i = 0; i < parsedData.length; i++) {
        const item = parsedData[i];
        if (item.results.length > formulaIndex && item.results[formulaIndex] && item.results[formulaIndex] !== '') {
            validData.push(item);
            consecutiveCount++;
        } else {
            // Jika bertemu data tanpa hasil, reset consecutive count
            if (consecutiveCount > 0) {
                break; // Hanya gunakan data berturut-turut
            }
        }
    }
    
    console.log(`Rumus ${formula}: ${validData.length} data berturut-turut`);
    
    // 2. WAJIB minimal 4 data berturut-turut dengan hasil lengkap
    if (validData.length < 4) {
        return {
            formula: formula,
            naikSequence: [],
            digitLength: 0,
            isValid: false,
            reason: `Hanya ${validData.length} data berturut-turut (minimal 4 required)`,
            validDataCount: validData.length
        };
    }
    
    // 3. Analisis pattern hanya jika memenuhi kriteria
    const pattern = {
        formula: formula,
        naikSequence: [],
        digitLength: validData[0].results[formulaIndex].length,
        isValid: true,
        reason: `${validData.length} data berturut-turut - Pattern valid`,
        validDataCount: validData.length
    };
    
    // 4. Untuk setiap digit position, cari pattern
    for (let digitIndex = 0; digitIndex < pattern.digitLength; digitIndex++) {
        const naikValues = [];
        
        // Analisis data berturut-turut
        for (let i = 0; i < validData.length - 1; i++) {
            const currentDigit = parseInt(validData[i].results[formulaIndex][digitIndex]);
            const nextDigit = parseInt(validData[i + 1].results[formulaIndex][digitIndex]);
            
            const naikValue = (nextDigit - currentDigit + 10) % 10;
            naikValues.push(naikValue);
        }
        
        // Cek konsistensi pattern - minimal 75% data memiliki nilai yang sama
        const consistentNaik = findConsistentValue(naikValues);
        const consistency = calculateConsistency(naikValues, consistentNaik);
        
        if (consistency < 0.75) {
            pattern.isValid = false;
            pattern.reason = `Pattern tidak konsisten (${Math.round(consistency * 100)}% consistency)`;
        }
        
        pattern.naikSequence.push(consistentNaik);
    }
    
    console.log(`Pattern untuk ${formula}:`, pattern);
    return pattern;
}

function findConsistentValue(values) {
    if (values.length === 0) return 0;
    
    const frequency = {};
    let maxCount = 0;
    let consistentValue = values[0];
    
    for (let value of values) {
        frequency[value] = (frequency[value] || 0) + 1;
        if (frequency[value] > maxCount) {
            maxCount = frequency[value];
            consistentValue = value;
        }
    }
    
    return consistentValue;
}

function calculateConsistency(values, targetValue) {
    const count = values.filter(v => v === targetValue).length;
    return count / values.length;
}

function calculateMissingData(parsedData, formulas) {
    const results = [...parsedData];
    
    // Cari data yang belum lengkap
    const incompleteData = results.filter(item => 
        item.results.length < formulas.length || 
        item.results.some((r, idx) => !r && idx < formulas.length)
    );
    
    for (let data of incompleteData) {
        // Pastikan array results cukup panjang
        while (data.results.length < formulas.length) {
            data.results.push('');
        }
        
        // Hitung hasil untuk setiap formula yang belum ada
        for (let i = 0; i < formulas.length; i++) {
            if (!data.results[i] || data.results[i] === '') {
                const calculatedResult = calculateWithPattern(data, formulas[i], detectedPatterns[i], results);
                data.results[i] = calculatedResult;
            }
        }
    }
    
    return results;
}

function calculateWithPattern(data, formula, pattern, allData) {
    // JIKA PATTERN TIDAK ADA atau TIDAK VALID - KOSONGKAN
    if (!pattern || !pattern.isValid) {
        return "";
    }
    
    try {
        // Cari data terakhir yang memiliki hasil untuk rumus ini
        const lastValidData = allData
            .filter(item => 
                item.results.length > allData.indexOf(data) && 
                item.results[allData.indexOf(data)] && 
                item.results[allData.indexOf(data)] !== ''
            )
            .pop();
        
        if (!lastValidData) {
            return "";
        }
        
        const lastResult = lastValidData.results[allData.indexOf(data)];
        let finalResult = "";
        
        // Hitung berdasarkan pattern dari hasil terakhir
        for (let i = 0; i < pattern.digitLength; i++) {
            const lastDigit = parseInt(lastResult[i]);
            const naikValue = pattern.naikSequence[i];
            const newDigit = naikSiklik(lastDigit, naikValue);
            finalResult += newDigit.toString();
        }
        
        return finalResult;
    } catch (error) {
        console.error('Error in calculateWithPattern:', error);
        return "";
    }
}

function calculateSingleFormula(data, formula) {
    // Placeholder untuk perhitungan base
    const components = data.components;
    
    let result = 0;
    
    if (formula.includes('A') && formula.includes('K')) {
        result = (parseInt(components.as) + parseInt(components.kepala)) % 10;
    } else if (formula.includes('A') && formula.includes('C')) {
        result = (parseInt(components.as) + parseInt(components.cop)) % 10;
    } else if (formula.includes('K') && formula.includes('E')) {
        result = (parseInt(components.kepala) + parseInt(components.ekor)) % 10;
    } else if (formula.includes('C') && formula.includes('E')) {
        result = (parseInt(components.cop) + parseInt(components.ekor)) % 10;
    } else {
        result = parseInt(components.jumlah);
    }
    
    return result;
}

function displayPatternAnalysis() {
    const patternAnalysis = document.getElementById('patternAnalysis');
    const patternResults = document.getElementById('patternResults');
    
    let html = '';
    let validPatterns = 0;
    
    detectedPatterns.forEach((pattern, index) => {
        const statusClass = pattern.isValid ? 'pattern-valid' : 'pattern-invalid';
        const statusIcon = pattern.isValid ? '‚úÖ' : '‚ö†Ô∏è';
        
        html += `<div class="pattern-item ${statusClass}">`;
        html += `<div><strong>${statusIcon} Rumus ${index + 1}:</strong> ${pattern.formula}</div>`;
        html += `<div><strong>Status:</strong> ${pattern.reason}</div>`;
        
        if (pattern.isValid) {
            html += `<div><strong>Pattern "naik X":</strong> [${pattern.naikSequence.join(', ')}]</div>`;
            html += `<div><strong>Digit output:</strong> ${pattern.digitLength}</div>`;
            validPatterns++;
        }
        
        html += `</div>`;
    });
    
    if (validPatterns === 0) {
        html = '<div style="text-align: center; color: #ff9800; padding: 20px;">‚ö†Ô∏è Tidak ada pattern yang valid ditemukan (minimal 4 data berturut-turut required)</div>';
    }
    
    patternResults.innerHTML = html;
    patternAnalysis.style.display = 'block';
}

function displayAdvancedResult(results, formulas) {
    const output = document.getElementById('resultOutput');
    let outputText = '';
    
    results.forEach(result => {
        outputText += `${result.number} = `;
        if (result.results.length > 0) {
            const validResults = result.results.slice(0, formulas.length).filter(r => r !== '');
            outputText += validResults.join(' . ');
            if (result.label && validResults.length > 0) {
                outputText += ` ${result.label}`;
            }
        }
        outputText += '\n';
    });
    
    outputText += '======\n';
    formulas.forEach(formula => {
        outputText += `${formula}\n`;
    });
    
    output.textContent = outputText;
}

function reduceToSingleDigit(num) {
    let result = num;
    while (result > 9) {
        result = result.toString().split('').reduce((sum, digit) => sum + parseInt(digit), 0);
    }
    return result;
}

function clearAll() {
    document.getElementById('inputData').value = `6874 = 94 . 91 . 49 ai
0489 = 83 . 35 . 49 ai
2843 = 72 . 57 . 27 ai
3752 = 49 . 24 . 94 ai
8644 = 16 . 24 . 72 ai
2962 = 72 . 35 . 27 ai
6937 = 50 . 79 . 05 ai
0559 = 49 . 35 . 49 ai
8445 = 49 . 79 . 94 ai
2429 = 49 . 91 . 27 ai
5879 = 05 . 35 . 38 ai
9158 = 61 . 24 . 49 ai
5364 = 50 . 80 . 49 ai
2190 = 38 . 57 . 50 ai
3358 = 05 . 02 . 05 ai
1452 = 
======
A6ix+K8mb.(mb)
A9‚ÄìC10.(ty)
C8ix+E2ml.(ml)`;
    document.getElementById('resultOutput').textContent = `// Hasil perhitungan akan muncul di sini
// Format:
// 6874 = 94 . 91 . 49 ai
// 0489 = 83 . 35 . 49 ai  
// 2843 = 72 . 57 . 27 ai
// ...
// ======
// A6ix+K8mb.(mb) 
// A9‚ÄìC10.(ty) 
// C8ix+E2ml.(ml)`;
    document.getElementById('info').textContent = 'Masukkan data dan rumus dalam satu kolom, lalu klik ANALISIS & HITUNG';
    document.getElementById('inputInfo').textContent = 'Data dan rumus terdeteksi';
    document.getElementById('debugInfo').style.display = 'none';
    document.getElementById('patternAnalysis').style.display = 'none';
    dataHistory = [];
    detectedPatterns = [];
}

function showInfo(message, type) {
    const infoDiv = document.getElementById('info');
    infoDiv.textContent = message;
    infoDiv.style.background = type === 'error' ? '#ffebee' : 
                             type === 'success' ? '#e8f5e8' : '#e3f2fd';
    infoDiv.style.color = type === 'error' ? '#c62828' :
                        type === 'success' ? '#2e7d32' : '#1565c0';
}

// Update info input real-time
function updateInputInfo() {
    const input = document.getElementById('inputData').value.trim();
    const lines = input.split('\n').filter(line => line.trim());
    const dataCount = lines.filter(line => line.match(/^\d+\s*=/)).length;
    const hasFormulas = input.includes('======');
    
    let info = `${dataCount} data terdeteksi`;
    if (hasFormulas) {
        info += ' + rumus';
    }
    
    document.getElementById('inputInfo').textContent = info;
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('inputData').addEventListener('input', updateInputInfo);
    updateInputInfo();
});

document.getElementById('inputData').addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.key === 'Enter') {
        calculateAdvanced();
    }
});
</script>
</body>
</html>
